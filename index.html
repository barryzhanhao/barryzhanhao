<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Zhan Hao&#39;s Blogs">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Zhan Hao&#39;s Blogs">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zhan Hao">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Zhan Hao's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zhan Hao's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/07/spring-rabbitmq-consumer-reconnect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/07/spring-rabbitmq-consumer-reconnect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">spring rabbitmq consumer reconnect源码分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-07 15:11:00 / Modified: 19:25:28" itemprop="dateCreated datePublished" datetime="2023-11-07T15:11:00+08:00">2023-11-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、起因"><a href="#一、起因" class="headerlink" title="一、起因"></a>一、起因</h1><p>某日深夜，生产环境，rabbitmq服务器集群宕机，收到企微告警，以为rabbitmq server端有灾难恢复和高可用机制，业务不会受影响，就没关注该异常。</p>
<p>早上，到公司之后，就被运维告知，负责的某个服务消费的queue有消息积压，和平常的业务表现不同，隐约感觉和晚上的rabbitmq服务器异常有关。检查服务日志，发现服务没有消费rabbitmq数据，grafana上消费的某些queue consumer数量为0，而某些queue consumer正常。</p>
<p><strong>疑问</strong>：该服务对rabbitmq的使用，抽象一下，A-&gt;B-&gt;C，其中A\B\C是queue，现象是rabbitmq server发生宕机恢复后，服务对A\B queue consumer 数量为0，服务对A\B queue consumer 数量正常，spring rabbitmq consumer reconnect客户端机制是怎么样的？为什么会有差异？</p>
<h1 id="二、源码分析"><a href="#二、源码分析" class="headerlink" title="二、源码分析"></a>二、源码分析</h1><p>带着疑问，分析服务业务代码，阅读spring rabbitmq源码。</p>
<p><strong>结论</strong>：发现服务对A\B\C queue的消费，有差异，差异造成了rabbitmq server发生宕机恢复后，consumer reconnect表现形式不同，其中A\B使用的是@RabbitListener注解，底层是<strong>SimpleMessageListenerContainer</strong>，C是继承的接口MessageListener，底层是<strong>DirectMessageListenerContainer</strong>。</p>
<p>从日志搜索关键字，</p>
<ul>
<li><em><strong>SimpleMessageListenerContainer</strong></em>，有限次重试reconnect，日志只有打印几次关键字：<em><strong>“Consumer threw missing queues exception, fatal=true”</strong></em>，<em><strong>“Stopping container from aborted consumer”</strong></em>，<em><strong>“Restarting Consumer XXX”</strong></em>。</li>
<li><em><strong>DirectMessageListenerContainer</strong></em>，有不断重试reconnect，日志有不断打印关键字：***”Queue not present, scheduling consumer XXX for queue  XXX for restart”***</li>
</ul>
<p>生产环境，springboot版本为2.4.6，spring-rabbit版本为2.3.7；以下源码，springboot版本为3.1.5，spring-rabbit版本为3.0.10。</p>
<h2 id="1-SimpleMessageListenerContainer"><a href="#1-SimpleMessageListenerContainer" class="headerlink" title="1.SimpleMessageListenerContainer"></a>1.SimpleMessageListenerContainer</h2><p>SimpleMessageListenerContainer消费者consumer核心逻辑在<strong>org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.AsyncMessageProcessingConsumer</strong>类，AsyncMessageProcessingConsumer是一个Runnable，主要逻辑在run方法，主要是控制逻辑，真正的消费逻辑，在内部属性BlockingQueueConsumer类，源码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.AsyncMessageProcessingConsumer</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncMessageProcessingConsumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> BlockingQueueConsumer consumer; <span class="comment">//真正的消费mq逻辑,其他属性略</span></span><br><span class="line"></span><br><span class="line">		<span class="meta">@Override</span> <span class="comment">// NOSONAR - complexity - many catch blocks</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123; <span class="comment">// NOSONAR - line count</span></span><br><span class="line">			<span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">				<span class="keyword">this</span>.start.countDown();</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">boolean</span> aborted = <span class="keyword">false</span>; <span class="comment">//重要的标志位，异常时为true</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">this</span>.consumer.setLocallyTransacted(isChannelLocallyTransacted());</span><br><span class="line"></span><br><span class="line">			String routingLookupKey = getRoutingLookupKey();</span><br><span class="line">			<span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">				SimpleResourceHolder.bind(getRoutingConnectionFactory(), routingLookupKey); <span class="comment">// NOSONAR both never null</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.consumer.getQueueCount() &lt; <span class="number">1</span>) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">					logger.debug(<span class="string">&quot;Consumer stopping; no queues for &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">				&#125;</span><br><span class="line">				SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">				<span class="keyword">if</span> (getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">					getApplicationEventPublisher().publishEvent(</span><br><span class="line">							<span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">this</span>.start.countDown();</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				initialize();</span><br><span class="line">				<span class="keyword">while</span> (isActive(<span class="keyword">this</span>.consumer) || <span class="keyword">this</span>.consumer.hasDelivery() || !<span class="keyword">this</span>.consumer.cancelled()) &#123;</span><br><span class="line">					mainLoop(); <span class="comment">//有条件的死循环，mainLoop为BlockingQueueConsumer consumer真正消费rabbitmq消息，mainLoop不是异常重连reconnect的重点，重点关注while的循环条件，发生异常或者，不满足条件时，会跳出死循环。</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Consumer thread interrupted, processing stopped.&quot;</span>);</span><br><span class="line">				Thread.currentThread().interrupt();</span><br><span class="line">				aborted = <span class="keyword">true</span>;</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer thread interrupted, processing stopped&quot;</span>, <span class="keyword">true</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (QueuesNotAvailableException ex) &#123;</span><br><span class="line">				logger.error(<span class="string">&quot;Consumer threw missing queues exception, fatal=&quot;</span> + isMissingQueuesFatal(), ex); <span class="comment">//该日志就是日志输出的异常，rabbitmq server端不可用，这时aborted标志位会设置为true。</span></span><br><span class="line">				<span class="keyword">if</span> (isMissingQueuesFatal()) &#123;</span><br><span class="line">					<span class="keyword">this</span>.startupException = ex;</span><br><span class="line">					<span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">					aborted = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer queue(s) not available&quot;</span>, aborted, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (FatalListenerStartupException ex) &#123;</span><br><span class="line">				logger.error(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, ex);</span><br><span class="line">				<span class="keyword">this</span>.startupException = ex;</span><br><span class="line">				<span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">				aborted = <span class="keyword">true</span>;</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception on startup&quot;</span>, <span class="keyword">true</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (FatalListenerExecutionException ex) &#123; <span class="comment">// NOSONAR exception as flow control</span></span><br><span class="line">				logger.error(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, ex);</span><br><span class="line">				<span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">				aborted = <span class="keyword">true</span>;</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer received fatal exception during processing&quot;</span>, <span class="keyword">true</span>, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (PossibleAuthenticationFailureException ex) &#123;</span><br><span class="line">				logger.error(<span class="string">&quot;Consumer received fatal=&quot;</span> + isPossibleAuthenticationFailureFatal() +</span><br><span class="line">						<span class="string">&quot; exception during processing&quot;</span>, ex);</span><br><span class="line">				<span class="keyword">if</span> (isPossibleAuthenticationFailureFatal()) &#123;</span><br><span class="line">					<span class="keyword">this</span>.startupException =</span><br><span class="line">							<span class="keyword">new</span> FatalListenerStartupException(<span class="string">&quot;Authentication failure&quot;</span>,</span><br><span class="line">									<span class="keyword">new</span> AmqpAuthenticationException(ex));</span><br><span class="line">					<span class="comment">// Fatal, but no point re-throwing, so just abort.</span></span><br><span class="line">					aborted = <span class="keyword">true</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer received PossibleAuthenticationFailure during startup&quot;</span>, aborted, ex);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (ShutdownSignalException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (RabbitUtils.isNormalShutdown(e)) &#123;</span><br><span class="line">					<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">						logger.debug(<span class="string">&quot;Consumer received Shutdown Signal, processing stopped: &quot;</span> + e.getMessage());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					logConsumerException(e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (AmqpIOException e) &#123;</span><br><span class="line">				<span class="keyword">if</span> (e.getCause() <span class="keyword">instanceof</span> IOException &amp;&amp; e.getCause().getCause() <span class="keyword">instanceof</span> ShutdownSignalException</span><br><span class="line">						&amp;&amp; e.getCause().getCause().getMessage().contains(<span class="string">&quot;in exclusive use&quot;</span>)) &#123;</span><br><span class="line">					getExclusiveConsumerExceptionLogger().log(logger,</span><br><span class="line">							<span class="string">&quot;Exclusive consumer failure&quot;</span>, e.getCause().getCause());</span><br><span class="line">					publishConsumerFailedEvent(<span class="string">&quot;Consumer raised exception, attempting restart&quot;</span>, <span class="keyword">false</span>, e);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> &#123;</span><br><span class="line">					logConsumerException(e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Error e) &#123; <span class="comment">//NOSONAR</span></span><br><span class="line">				logger.error(<span class="string">&quot;Consumer thread error, thread abort.&quot;</span>, e);</span><br><span class="line">				publishConsumerFailedEvent(<span class="string">&quot;Consumer threw an Error&quot;</span>, <span class="keyword">true</span>, e);</span><br><span class="line">				getJavaLangErrorHandler().handle(e);</span><br><span class="line">				aborted = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">//NOSONAR</span></span><br><span class="line">				<span class="comment">// by now, it must be an exception</span></span><br><span class="line">				<span class="keyword">if</span> (isActive()) &#123;</span><br><span class="line">					logConsumerException(t);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (getTransactionManager() != <span class="keyword">null</span>) &#123;</span><br><span class="line">					ConsumerChannelRegistry.unRegisterConsumerChannel();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// In all cases count down to allow container to progress beyond startup</span></span><br><span class="line">			<span class="keyword">this</span>.start.countDown();</span><br><span class="line"></span><br><span class="line">			killOrRestart(aborted); <span class="comment">//当发生异常，当前AsyncMessageProcessingConsumer会跳出死循环，aborted=true。</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> (routingLookupKey != <span class="keyword">null</span>) &#123;</span><br><span class="line">				SimpleResourceHolder.unbind(getRoutingConnectionFactory()); <span class="comment">// NOSONAR never null here</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">killOrRestart</span><span class="params">(<span class="keyword">boolean</span> aborted)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (!isActive(<span class="keyword">this</span>.consumer) || aborted) &#123; <span class="comment">//注意IF条件，二选一为真会进入，aborted=true，会执行stop方法</span></span><br><span class="line">				logger.debug(<span class="string">&quot;Cancelling &quot;</span> + <span class="keyword">this</span>.consumer);</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">this</span>.consumer.stop();</span><br><span class="line">					SimpleMessageListenerContainer.<span class="keyword">this</span>.cancellationLock.release(<span class="keyword">this</span>.consumer);</span><br><span class="line">					<span class="keyword">if</span> (getApplicationEventPublisher() != <span class="keyword">null</span>) &#123;</span><br><span class="line">						getApplicationEventPublisher().publishEvent(</span><br><span class="line">								<span class="keyword">new</span> AsyncConsumerStoppedEvent(SimpleMessageListenerContainer.<span class="keyword">this</span>, <span class="keyword">this</span>.consumer));</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (AmqpException e) &#123;</span><br><span class="line">					logger.info(<span class="string">&quot;Could not cancel message consumer&quot;</span>, e);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (aborted &amp;&amp; SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort</span><br><span class="line">						.compareAndSet(<span class="keyword">null</span>, Thread.currentThread())) &#123;</span><br><span class="line">					logger.error(<span class="string">&quot;Stopping container from aborted consumer&quot;</span>);</span><br><span class="line">					stop(); <span class="comment">//stop是核心方法,stop是父类AbstractMessageListenerContainer的方法</span></span><br><span class="line">					SimpleMessageListenerContainer.<span class="keyword">this</span>.containerStoppingForAbort.set(<span class="keyword">null</span>);</span><br><span class="line">					ListenerContainerConsumerFailedEvent event = <span class="keyword">null</span>;</span><br><span class="line">					<span class="keyword">do</span> &#123;</span><br><span class="line">						<span class="keyword">try</span> &#123;</span><br><span class="line">							event = SimpleMessageListenerContainer.<span class="keyword">this</span>.abortEvents.poll(ABORT_EVENT_WAIT_SECONDS,</span><br><span class="line">									TimeUnit.SECONDS);</span><br><span class="line">							<span class="keyword">if</span> (event != <span class="keyword">null</span>) &#123;</span><br><span class="line">								SimpleMessageListenerContainer.<span class="keyword">this</span>.publishConsumerFailedEvent(</span><br><span class="line">										event.getReason(), event.isFatal(), event.getThrowable());</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">							Thread.currentThread().interrupt();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">while</span> (event != <span class="keyword">null</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123; <span class="comment">//不满足!isActive(this.consumer) || aborted，会重启consumer，即BlockingQueueConsumer</span></span><br><span class="line">				logger.info(<span class="string">&quot;Restarting &quot;</span> + <span class="keyword">this</span>.consumer);<span class="comment">//日志的关键字，也有Restarting关键字</span></span><br><span class="line">				restart(<span class="keyword">this</span>.consumer);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>而AbstractMessageListenerContainer的stop方法，调用的是shutdown方法，shutdown方法，是把AbstractMessageListenerContainer的active设置为false。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.<span class="function">AbstractMessageListenerContainer	</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">(<span class="meta">@Nullable</span> Runnable callback)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.lifecycleMonitor) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!isActive()) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Shutdown ignored - container is not active already&quot;</span>);</span><br><span class="line">				<span class="keyword">this</span>.lifecycleMonitor.notifyAll();</span><br><span class="line">				<span class="keyword">if</span> (callback != <span class="keyword">null</span>) &#123;</span><br><span class="line">					callback.run();</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">this</span>.active = <span class="keyword">false</span>; <span class="comment">//设置active为false</span></span><br><span class="line">			<span class="keyword">this</span>.lifecycleMonitor.notifyAll();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		logger.debug(<span class="string">&quot;Shutting down Rabbit listener container&quot;</span>);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Shut down the invokers.</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			shutdownAndWaitOrCallback(callback);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			<span class="keyword">throw</span> convertRabbitAccessException(ex);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			setNotRunning();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>而其他consumer，AsyncMessageProcessingConsumer的mainLoop while死循环，判断条件isActive（）会使用到AbstractMessageListenerContainer的active方法，其他的AsyncMessageProcessingConsumer consumer，就会进入killOrRestart方法的else方法，重启consumer。（参考AsyncMessageProcessingConsumer的run方法）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer.<span class="function">AsyncMessageProcessingConsumer</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">(BlockingQueueConsumer consumer)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">boolean</span> consumerActive;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">			consumerActive = <span class="keyword">this</span>.consumers != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.consumers.contains(consumer);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> consumerActive &amp;&amp; <span class="keyword">this</span>.isActive();<span class="comment">//this.isActive()调用父类AbstractMessageListenerContainer的方法，判断AbstractMessageListenerContainer的active属性</span></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>综上，SimpleMessageListenerContainer的reconnect机制，只是有限次数，和线上日志的表现形式一致。</p>
<h2 id="2-DirectMessageListenerContainer"><a href="#2-DirectMessageListenerContainer" class="headerlink" title="2.DirectMessageListenerContainer"></a>2.DirectMessageListenerContainer</h2><p>DirectMessageListenerContainer消费者consumer核心逻辑在<strong>org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</strong>类，核心方法是actualStart，其中启动consumer的方法是startConsumers，但是startConsumers不是reconnect机制的重点，reconnect机制的核心代码是startMonitor，startMonitor是启动的后台线程，不断检查consumer状态，异常时consumer reconnect，源码片段如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.<span class="function">DirectMessageListenerContainer</span></span><br><span class="line"><span class="function">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">actualStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.aborted = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">this</span>.hasStopped = <span class="keyword">false</span>;</span><br><span class="line">		<span class="keyword">if</span> (getPrefetchCount() &lt; <span class="keyword">this</span>.messagesPerAck) &#123;</span><br><span class="line">			setPrefetchCount(<span class="keyword">this</span>.messagesPerAck);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">super</span>.doStart();</span><br><span class="line">		<span class="keyword">final</span> String[] queueNames = getQueueNames();</span><br><span class="line">		checkMissingQueues(queueNames);</span><br><span class="line">		checkConnect();</span><br><span class="line">		<span class="keyword">long</span> idleEventInterval = getIdleEventInterval();</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.taskScheduler == <span class="keyword">null</span>) &#123;</span><br><span class="line">			afterPropertiesSet();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (idleEventInterval &gt; <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.monitorInterval &gt; idleEventInterval) &#123;</span><br><span class="line">			<span class="keyword">this</span>.monitorInterval = idleEventInterval / <span class="number">2</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (getFailedDeclarationRetryInterval() &lt; <span class="keyword">this</span>.monitorInterval) &#123;</span><br><span class="line">			<span class="keyword">this</span>.monitorInterval = getFailedDeclarationRetryInterval();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">final</span> Map&lt;String, Queue&gt; namesToQueues = getQueueNamesToQueues();</span><br><span class="line">		<span class="keyword">this</span>.lastRestartAttempt = System.currentTimeMillis();</span><br><span class="line">		startMonitor(idleEventInterval, namesToQueues);<span class="comment">//consumer reconnect核心代码</span></span><br><span class="line">		<span class="keyword">if</span> (queueNames.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			doRedeclareElementsIfNecessary();</span><br><span class="line">			getTaskExecutor().execute(() -&gt; &#123; <span class="comment">// NOSONAR never null here</span></span><br><span class="line">				startConsumers(queueNames);<span class="comment">//启动consumer，非reconnenct机制重点</span></span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.started = <span class="keyword">true</span>;</span><br><span class="line">			<span class="keyword">this</span>.startedLatch.countDown();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.logger.info(<span class="string">&quot;Container initialized for queues: &quot;</span> + Arrays.asList(queueNames));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>startMonitor方法，源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.<span class="function">DirectMessageListenerContainer</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startMonitor</span><span class="params">(<span class="keyword">long</span> idleEventInterval, <span class="keyword">final</span> Map&lt;String, Queue&gt; namesToQueues)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.consumerMonitorTask = <span class="keyword">this</span>.taskScheduler.scheduleAtFixedRate(() -&gt; &#123; <span class="comment">//固定间隔运行的后台线程</span></span><br><span class="line">			<span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">			checkIdle(idleEventInterval, now);</span><br><span class="line">			checkConsumers(now); <span class="comment">//检查consumer是否可用，不可用，放入consumersToRestart队列</span></span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.lastRestartAttempt + getFailedDeclarationRetryInterval() &lt; now) &#123;</span><br><span class="line">				<span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">					<span class="keyword">if</span> (<span class="keyword">this</span>.started) &#123;</span><br><span class="line">						List&lt;SimpleConsumer&gt; restartableConsumers = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.consumersToRestart); <span class="comment">//consumersToRestart需要重连的consumer</span></span><br><span class="line">						<span class="keyword">this</span>.consumersToRestart.clear();</span><br><span class="line">						<span class="keyword">if</span> (restartableConsumers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">							doRedeclareElementsIfNecessary();</span><br><span class="line">						&#125;</span><br><span class="line">						Iterator&lt;SimpleConsumer&gt; iterator = restartableConsumers.iterator();</span><br><span class="line">						<span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">							SimpleConsumer consumer = iterator.next();</span><br><span class="line">							iterator.remove();</span><br><span class="line">							<span class="keyword">if</span> (DirectMessageListenerContainer.<span class="keyword">this</span>.removedQueues.contains(consumer.getQueue())) &#123;</span><br><span class="line">								<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">									<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Skipping restart of consumer, queue removed &quot;</span> + consumer);</span><br><span class="line">								&#125;</span><br><span class="line">								<span class="keyword">continue</span>;</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">								<span class="keyword">this</span>.logger.debug(<span class="string">&quot;Attempting to restart consumer &quot;</span> + consumer);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">if</span> (!restartConsumer(namesToQueues, restartableConsumers, consumer)) &#123;<span class="comment">//重连consumer</span></span><br><span class="line">								<span class="keyword">break</span>;</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">this</span>.lastRestartAttempt = now;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			processMonitorTask();</span><br><span class="line">		&#125;, Duration.ofMillis(<span class="keyword">this</span>.monitorInterval));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkConsumers</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> List&lt;SimpleConsumer&gt; consumersToCancel;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">			consumersToCancel = <span class="keyword">this</span>.consumers.stream()</span><br><span class="line">					.filter(consumer -&gt; &#123;</span><br><span class="line">						<span class="keyword">boolean</span> open = consumer.getChannel().isOpen() &amp;&amp; !consumer.isAckFailed() <span class="comment">//检查consumer是否可用</span></span><br><span class="line">								&amp;&amp; !consumer.targetChanged();</span><br><span class="line">						<span class="keyword">if</span> (open &amp;&amp; <span class="keyword">this</span>.messagesPerAck &gt; <span class="number">1</span>) &#123;</span><br><span class="line">							<span class="keyword">try</span> &#123;</span><br><span class="line">								consumer.ackIfNecessary(now);</span><br><span class="line">							&#125;</span><br><span class="line">							<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">								<span class="keyword">this</span>.logger.error(<span class="string">&quot;Exception while sending delayed ack&quot;</span>, e);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">return</span> !open;</span><br><span class="line">					&#125;)</span><br><span class="line">					.collect(Collectors.toList());</span><br><span class="line">		&#125;</span><br><span class="line">		consumersToCancel</span><br><span class="line">				.forEach(consumer -&gt; &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						RabbitUtils.closeMessageConsumer(consumer.getChannel(),</span><br><span class="line">								Collections.singletonList(consumer.getConsumerTag()), isChannelTransacted());</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						<span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">							logger.debug(<span class="string">&quot;Error closing consumer &quot;</span> + consumer, e);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">this</span>.logger.error(<span class="string">&quot;Consumer canceled - channel closed &quot;</span> + consumer);</span><br><span class="line">					consumer.cancelConsumer(<span class="string">&quot;Consumer &quot;</span> + consumer + <span class="string">&quot; channel closed&quot;</span>); <span class="comment">//不可用的consumer，调用SimpleConsumer的cancel方法</span></span><br><span class="line">				&#125;);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>SimpleConsumer的cancelConsumer方法，把当前SimpleConsumer调用DirectMessageListenerContainer的addConsumerToRestart方法，添加到consumersToRestart集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer.<span class="function">SimpleConsumer</span></span><br><span class="line"><span class="function">		<span class="keyword">void</span> <span class="title">cancelConsumer</span><span class="params">(<span class="keyword">final</span> String eventMessage)</span> </span>&#123;</span><br><span class="line">			publishConsumerFailedEvent(eventMessage, <span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="keyword">synchronized</span> (DirectMessageListenerContainer.<span class="keyword">this</span>.consumersMonitor) &#123;</span><br><span class="line">				List&lt;SimpleConsumer&gt; list = DirectMessageListenerContainer.<span class="keyword">this</span>.consumersByQueue.get(<span class="keyword">this</span>.queue);</span><br><span class="line">				<span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">					list.remove(<span class="keyword">this</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				DirectMessageListenerContainer.<span class="keyword">this</span>.consumers.remove(<span class="keyword">this</span>);</span><br><span class="line">				addConsumerToRestart(<span class="keyword">this</span>);<span class="comment">//调用SimpleConsumer自己，添加到DirectMessageListenerContainer的consumersToRestart</span></span><br><span class="line">			&#125;</span><br><span class="line">			finalizeConsumer();</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>DirectMessageListenerContainer的addConsumerToRestart方法:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</span><br><span class="line">private void addConsumerToRestart(SimpleConsumer consumer) &#123;</span><br><span class="line">		this.consumersToRestart.add(consumer);</span><br><span class="line">		if (this.logger.isTraceEnabled()) &#123;</span><br><span class="line">			this.logger.trace(&quot;Consumers to restart now: &quot; + this.consumersToRestart);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>综上，DirectMessageListenerContainer的reconnect机制，是因为有后台线程保证，只是无限次数，和线上日志的表现形式一致。</p>
<h2 id="3-总结"><a href="#3-总结" class="headerlink" title="3.总结"></a>3.总结</h2><p>DirectMessageListenerContainer的reconnect机制，比SimpleMessageListenerContainer完备。如果rabbitmq server段，闪断的情况，SimpleMessageListenerContainer可以处理，如果时间一长，SimpleMessageListenerContainer的reconnect实现机制，就不能处理，而DirectMessageListenerContainer的实现机制更合理、更完备。</p>
<h1 id="三、修复方案"><a href="#三、修复方案" class="headerlink" title="三、修复方案"></a>三、修复方案</h1><p>本着，最小改动，最小代价修复问题的方针，方案：修改@RabbitListener注解的<strong>containerFactory</strong>。根据javadoc，containerFactory return的是org.springframework.amqp.rabbit.listener.RabbitListenerContainerFactory，RabbitListenerContainerFactory的几种实现如下，</p>
<p><img src="https://p.ipic.vip/fz9c7e.png" alt="image-20231107191734155"></p>
<p>只需要，选择org.springframework.amqp.rabbit.config.DirectRabbitListenerContainerFactory实现就好，springboot其实已经贴心留好了钩子，只需要设置属性<em><strong>spring.rabbitmq.listener=direct</strong></em>即可切换containerFactory为DirectRabbitListenerContainerFactory，不需要更改代码。</p>
<p>另外注意切换containerFactory后，如果使用了@RabbitListener注解的<strong>concurrency</strong>并发度，可能需要适配修改。原因如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set the concurrency of the listener container for this listener. Overrides the</span></span><br><span class="line"><span class="comment"> * default set by the listener container factory. Maps to the concurrency setting of</span></span><br><span class="line"><span class="comment"> * the container type.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer</span></span><br><span class="line"><span class="comment"> * SimpleMessageListenerContainer&#125; if this value is a simple integer, it sets a fixed</span></span><br><span class="line"><span class="comment"> * number of consumers in the &#123;<span class="doctag">@code</span> concurrentConsumers&#125; property. If it is a string</span></span><br><span class="line"><span class="comment"> * with the form &#123;<span class="doctag">@code</span> &quot;m-n&quot;&#125;, the &#123;<span class="doctag">@code</span> concurrentConsumers&#125; is set to &#123;<span class="doctag">@code</span> m&#125;</span></span><br><span class="line"><span class="comment"> * and the &#123;<span class="doctag">@code</span> maxConcurrentConsumers&#125; is set to &#123;<span class="doctag">@code</span> n&#125;.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;For a</span></span><br><span class="line"><span class="comment"> * &#123;<span class="doctag">@link</span> org.springframework.amqp.rabbit.listener.DirectMessageListenerContainer</span></span><br><span class="line"><span class="comment"> * DirectMessageListenerContainer&#125; it sets the &#123;<span class="doctag">@code</span> consumersPerQueue&#125; property.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> the concurrency.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">String <span class="title">concurrency</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>; <span class="comment">//SimpleMessageListenerContainer的concurrency是自适应的，之前生产的设置就是m-n</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/02/rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/02/rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90(%E4%B8%80)/" class="post-title-link" itemprop="url">rocketmq源码解析（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-02 22:56:26" itemprop="dateCreated datePublished" datetime="2023-07-02T22:56:26+08:00">2023-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-03 10:51:16" itemprop="dateModified" datetime="2023-07-03T10:51:16+08:00">2023-07-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、RocketMQ"><a href="#一、RocketMQ" class="headerlink" title="一、RocketMQ"></a>一、RocketMQ</h1><p>摘自<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/">官网</a>的简介：</p>
<blockquote>
<p>RocketMQ 5.0: A cloud-native “messaging, eventing, streaming” real-time data processing platform, covering cloud-edge-device collaboration scenarios</p>
</blockquote>
<h1 id="二、从Quick-Start开始阅读和DEBUG源码"><a href="#二、从Quick-Start开始阅读和DEBUG源码" class="headerlink" title="二、从Quick Start开始阅读和DEBUG源码"></a>二、从Quick Start开始阅读和DEBUG源码</h1><p>个人认为，最高效的学习技术的方法，是在实际项目中运用技术，在不断解决问题中理解技术。如果没有实际项目运用，开源项目也是很好的快速提高个人技术水平的切入点。</p>
<p>简单调用开源项目的API，完成简单的DEMO，有用，但是，并不是深入理解开源项目的方式。</p>
<ul>
<li>阅读文档</li>
<li>阅读源码</li>
<li>DEBUG源码</li>
</ul>
<p>三种方式，难易度：阅读文档 &gt; 阅读源码 &gt; DEBUG源码；深入理解：DEBUG源码 &gt; 阅读源码 &gt; 阅读源码 。</p>
<p>下面，我们讲，以<em><strong>个人的理解</strong></em>，不太多的阅读文档和概念，直接从Quick Start开始，简单粗暴的阅读和DEBUG rocketmq的源码。</p>
<h2 id="2-1-IDEA启动Broker"><a href="#2-1-IDEA启动Broker" class="headerlink" title="2.1 IDEA启动Broker"></a>2.1 IDEA启动Broker</h2><p>首先，根据<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quickStart/01quickstart/">Quick Start</a>文档，以<strong>RocketMQ 5.1.3</strong>版本为例</p>
<ul>
<li>下载RocketMQ的源码、编译。</li>
<li>启动NameServer</li>
<li>启动 Broker and Proxy，这里和Qucick Start文档，稍微有点不一样，因为需要DEBUG，我们直接从github上，clone rocketmq的源码，然后启动源码的Broker，不是使用编译好的二进制Broker，方便后续DEBUG源码。</li>
<li>发送和接收消息，可以用tools或者SDK.</li>
</ul>
<p>其中，注意源码启动rocketmq的Broker代码时，使用JDK8，因为rocketmq使用了1.8的sun.misc包下面的Unsafe类。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-022500.jpg" alt="008vOhrAgy1hfizmg30e1j31y00egn0f"></p>
<p>其实官方在github和文档两处也提到了JDK版本的要求，只是我本人的电脑使用的比较高版本的JDK：</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-023653.jpg" alt="008vOhrAgy1hfj03vlgc8j31g80haac3"></p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-023756.jpg" alt="008vOhrAgy1hfj05cy5u9j31bq0bgdh0"></p>
<p>如何设置JDK版本，参考下图</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-023846.jpg" alt="008vOhrAgy1hfizrcrpnhj31010u00u6"></p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-023954.jpg" alt="008vOhrAgy1hfizsam0edj31at0u0whq"></p>
<p>如何找到入口，从哪里入手阅读和DEBUG源码？</p>
<p>我们注意到，<em><strong>Start Broker and Proxy</strong></em>，是这样启动Broker的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## start broker</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nohup sh bin/mqbroker -n localhost:9876 --enable-proxy &amp;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">## verify broker</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> tail -f ~/logs/rocketmqlogs/proxy.log</span> </span><br><span class="line">The broker[broker-a,192.169.1.2:10911] boot success...</span><br></pre></td></tr></table></figure>

<p>按照shell里面的位置，找到distribution/bin/mqbroker，其中，需要关注的环境变量和参数，是ROCKETMQ_HOME和$enable_proxy，</p>
<p>从以下截图中，可以看到，rocketmq的入口，是org.apache.rocketmq.proxy.ProxyStartup。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024028.jpg" alt="008vOhrAgy1hfj0chkph1j31h70u0q83"></p>
<p>runserver.sh中逻辑，主要是设置Java参数，比如GC，如果只是DEBUG，这些不是必须的。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024053.jpg" alt="008vOhrAgy1hfj1b48wcyj31j40u079x"></p>
<p>使用如下环境变量，就能在IDEA中RUN起来了：</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024113.jpg" alt="008vOhrAgy1hfj188t5vdj31lw0u0dms"></p>
<p>其中，比较迷惑的是，如果按照mqbroker shell中的enable_proxy逻辑，启动参数中，是需要加***-pm local<em><strong>的，这样反而DEBUG的时候，程序会推出，</strong></em>System.exit(0)***，启动不了。这点很迷惑。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024212.jpg" alt="008vOhrAgy1hfj1ejdyvuj31it0u0dnr"></p>
<p>按照<a target="_blank" rel="noopener" href="https://rocketmq.apache.org/docs/quickStart/01quickstart#4-send-and-receive-messages-with-tools">Send and Receive Messages with tools</a>的方式，不打断点的方式，成功验证Broker是否成功启动。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">export</span> NAMESRV_ADDR=localhost:9876</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span></span><br><span class="line"> SendResult [sendStatus=SEND_OK, msgId= ...</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sh bin/tools.sh org.apache.rocketmq.example.quickstart.Consumer</span></span><br><span class="line"><span class="meta"> ConsumeMessageThread_%</span><span class="bash">d Receive New Messages: [MessageExt...</span></span><br></pre></td></tr></table></figure>

<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024238.jpg" alt="008vOhrAgy1hfj1ji2xumj32gu06sjyi"></p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024248.jpg" alt="008vOhrAgy1hfj1l7ej0mj32jc0bok0d"></p>
<h2 id="2-2-DEBUG-Brocker"><a href="#2-2-DEBUG-Brocker" class="headerlink" title="2.2 DEBUG Brocker"></a>2.2 DEBUG Brocker</h2><p> 以下，使用断点调试。</p>
<p>如何找到断点入口，从哪里开始调试代码？</p>
<p>注意：org.apache.rocketmq.example.quickstart.Producer，消息生产者的代码入手：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.example.quickstart.Producer#main</span></span><br><span class="line">     </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> MQClientException, InterruptedException </span>&#123;</span><br><span class="line">              DefaultMQProducer producer = <span class="keyword">new</span> DefaultMQProducer(PRODUCER_GROUP);</span><br><span class="line">              producer.setNamesrvAddr(DEFAULT_NAMESRVADDR);</span><br><span class="line">              producer.start();</span><br><span class="line">                  Message msg = <span class="keyword">new</span> Message(TOPIC <span class="comment">/* Topic */</span>,</span><br><span class="line">                      TAG <span class="comment">/* Tag */</span>,</span><br><span class="line">                      (<span class="string">&quot;Hello RocketMQ &quot;</span> + i).getBytes(RemotingHelper.DEFAULT_CHARSET) <span class="comment">/* Message body */</span></span><br><span class="line">                  );</span><br><span class="line">                SendResult sendResult = producer.send(msg); <span class="comment">//调用的是org.apache.rocketmq.client.producer.DefaultMQProducer发送send方法</span></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.producer.DefaultMQProducer，只是很薄的一层封装，直接调用实现类DefaultMQProducerImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.producer.DefaultMQProducer</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SendResult <span class="title">send</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        Message msg)</span> <span class="keyword">throws</span> MQClientException, RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">        msg.setTopic(withNamespace(msg.getTopic()));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.defaultMQProducerImpl.send(msg);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl，是比较核心的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.producer.DefaultMQProducerImpl</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DEFAULT ASYNC -------------------------------------------------------</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        SendCallback sendCallback)</span> <span class="keyword">throws</span> MQClientException, RemotingException, InterruptedException </span>&#123;</span><br><span class="line">        send(msg, sendCallback, <span class="keyword">this</span>.defaultMQProducer.getSendMsgTimeout());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> SendCallback sendCallback, <span class="keyword">final</span> <span class="keyword">long</span> timeout)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> MQClientException, RemotingException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeout &gt; costTime) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        sendDefaultImpl(msg, CommunicationMode.ASYNC, sendCallback, timeout - costTime);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        sendCallback.onException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sendCallback.onException(</span><br><span class="line">                        <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;DEFAULT ASYNC send call timeout&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        executeAsyncMessageSend(runnable, msg, sendCallback, timeout, beginStartTime);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之后的sendDefaultImpl逻辑，调用栈比较深，不是这次的重点。</p>
<p>sendDefaultImpl  =&gt; sendKernelImpl</p>
<p>最终调用的是org.apache.rocketmq.client.impl.MQClientAPIImpl#sendMessage发送，相当于是底层API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ASYNC:</span><br><span class="line">                        Message tmpMessage = msg;</span><br><span class="line">                        <span class="keyword">boolean</span> messageCloned = <span class="keyword">false</span>;</span><br><span class="line">                        <span class="keyword">if</span> (msgBodyCompressed) &#123;</span><br><span class="line">                            <span class="comment">//If msg body was compressed, msgbody should be reset using prevBody.</span></span><br><span class="line">                            <span class="comment">//Clone new message using commpressed message body and recover origin massage.</span></span><br><span class="line">                            <span class="comment">//Fix bug:https://github.com/apache/rocketmq-externals/issues/66</span></span><br><span class="line">                            tmpMessage = MessageAccessor.cloneMessage(msg);</span><br><span class="line">                            messageCloned = <span class="keyword">true</span>;</span><br><span class="line">                            msg.setBody(prevBody);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (topicWithNamespace) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!messageCloned) &#123;</span><br><span class="line">                                tmpMessage = MessageAccessor.cloneMessage(msg);</span><br><span class="line">                                messageCloned = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            msg.setTopic(NamespaceUtil.withoutNamespace(msg.getTopic(), <span class="keyword">this</span>.defaultMQProducer.getNamespace()));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">long</span> costTimeAsync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                        <span class="keyword">if</span> (timeout &lt; costTimeAsync) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendKernelImpl call timeout&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        sendResult = <span class="keyword">this</span>.mQClientFactory.getMQClientAPIImpl().sendMessage(</span><br><span class="line">                            brokerAddr,</span><br><span class="line">                            brokerName,</span><br><span class="line">                            tmpMessage,</span><br><span class="line">                            requestHeader,</span><br><span class="line">                            timeout - costTimeAsync,</span><br><span class="line">                            communicationMode,</span><br><span class="line">                            sendCallback,</span><br><span class="line">                            topicPublishInfo,</span><br><span class="line">                            <span class="keyword">this</span>.mQClientFactory,</span><br><span class="line">                            <span class="keyword">this</span>.defaultMQProducer.getRetryTimesWhenSendAsyncFailed(),</span><br><span class="line">                            context,</span><br><span class="line">                            <span class="keyword">this</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.rocketmq.client.impl.MQClientAPIImpl的sendMessage中，有个需要关注的地方，Producer或者说Client端，最终发送出去的数据结构是：<em><strong>RemotingCommand</strong></em>，这也是我们后续DEBUG  Broker的关键点之一。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> SendResult <span class="title">sendMessage</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> String addr,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendMessageRequestHeader requestHeader,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> CommunicationMode communicationMode,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> MQClientInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">int</span> retryTimesWhenSendFailed,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendMessageContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> DefaultMQProducerImpl producer</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="keyword">throws</span> RemotingException, MQBrokerException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        RemotingCommand request = <span class="keyword">null</span>; <span class="comment">//第一次出现RemotingCommand</span></span><br><span class="line">        String msgType = msg.getProperty(MessageConst.PROPERTY_MESSAGE_TYPE);</span><br><span class="line">        <span class="keyword">boolean</span> isReply = msgType != <span class="keyword">null</span> &amp;&amp; msgType.equals(MixAll.REPLY_MESSAGE_FLAG);</span><br><span class="line">        <span class="keyword">if</span> (isReply) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sendSmartMsg) &#123;</span><br><span class="line">                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span><br><span class="line">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE_V2, requestHeaderV2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_REPLY_MESSAGE, requestHeader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (sendSmartMsg || msg <span class="keyword">instanceof</span> MessageBatch) &#123;</span><br><span class="line">                SendMessageRequestHeaderV2 requestHeaderV2 = SendMessageRequestHeaderV2.createSendMessageRequestHeaderV2(requestHeader);</span><br><span class="line">                request = RemotingCommand.createRequestCommand(msg <span class="keyword">instanceof</span> MessageBatch ? RequestCode.SEND_BATCH_MESSAGE : RequestCode.SEND_MESSAGE_V2, requestHeaderV2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                request = RemotingCommand.createRequestCommand(RequestCode.SEND_MESSAGE, requestHeader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        request.setBody(msg.getBody());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (communicationMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> ONEWAY:</span><br><span class="line">                <span class="keyword">this</span>.remotingClient.invokeOneway(addr, request, timeoutMillis);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">case</span> ASYNC:</span><br><span class="line">                <span class="keyword">final</span> AtomicInteger times = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">                <span class="keyword">long</span> costTimeAsync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeoutMillis &lt; costTimeAsync) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendMessage call timeout&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            		<span class="comment">//调用异步接口发送RemotingCommand</span></span><br><span class="line">                <span class="keyword">this</span>.sendMessageAsync(addr, brokerName, msg, timeoutMillis - costTimeAsync, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                    retryTimesWhenSendFailed, times, context, producer);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">case</span> SYNC:</span><br><span class="line">                <span class="keyword">long</span> costTimeSync = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeoutMillis &lt; costTimeSync) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;sendMessage call timeout&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.sendMessageSync(addr, brokerName, msg, timeoutMillis - costTimeSync, request);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在sendMessageAsync方法中，发现remotingClient发送的数据，那remotingClient又是什么啦？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.client.impl.MQClientAPIImpl</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendMessageAsync</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> String addr,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> String brokerName,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> Message msg,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> RemotingCommand request,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendCallback sendCallback,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> TopicPublishInfo topicPublishInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> MQClientInstance instance,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> <span class="keyword">int</span> retryTimesWhenSendFailed,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> AtomicInteger times,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> SendMessageContext context,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> DefaultMQProducerImpl producer</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.remotingClient.invokeAsync(addr, request, timeoutMillis, <span class="keyword">new</span> InvokeCallback() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ResponseFuture responseFuture)</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">long</span> cost = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                    RemotingCommand response = responseFuture.getResponseCommand();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">null</span> == sendCallback &amp;&amp; response != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SendResult sendResult = MQClientAPIImpl.<span class="keyword">this</span>.processSendResponse(brokerName, msg, response, addr);</span><br><span class="line">                            <span class="keyword">if</span> (context != <span class="keyword">null</span> &amp;&amp; sendResult != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                context.setSendResult(sendResult);</span><br><span class="line">                                context.getProducer().executeSendMessageHookAfter(context);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            SendResult sendResult = MQClientAPIImpl.<span class="keyword">this</span>.processSendResponse(brokerName, msg, response, addr);</span><br><span class="line">                            <span class="keyword">assert</span> sendResult != <span class="keyword">null</span>;</span><br><span class="line">                            <span class="keyword">if</span> (context != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                context.setSendResult(sendResult);</span><br><span class="line">                                context.getProducer().executeSendMessageHookAfter(context);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                sendCallback.onSuccess(sendResult);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">false</span>);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                            producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">true</span>);</span><br><span class="line">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                                retryTimesWhenSendFailed, times, e, context, <span class="keyword">false</span>, producer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        producer.updateFaultItem(brokerName, System.currentTimeMillis() - responseFuture.getBeginTimestamp(), <span class="keyword">true</span>);</span><br><span class="line">                        <span class="keyword">if</span> (!responseFuture.isSendRequestOK()) &#123;</span><br><span class="line">                            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;send request failed&quot;</span>, responseFuture.getCause());</span><br><span class="line">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                                retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (responseFuture.isTimeout()) &#123;</span><br><span class="line">                            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;wait response timeout &quot;</span> + responseFuture.getTimeoutMillis() + <span class="string">&quot;ms&quot;</span>,</span><br><span class="line">                                responseFuture.getCause());</span><br><span class="line">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                                retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            MQClientException ex = <span class="keyword">new</span> MQClientException(<span class="string">&quot;unknow reseaon&quot;</span>, responseFuture.getCause());</span><br><span class="line">                            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                                retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">long</span> cost = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">            producer.updateFaultItem(brokerName, cost, <span class="keyword">true</span>);</span><br><span class="line">            onExceptionImpl(brokerName, msg, timeoutMillis - cost, request, sendCallback, topicPublishInfo, instance,</span><br><span class="line">                retryTimesWhenSendFailed, times, ex, context, <span class="keyword">true</span>, producer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>RemotingClient是接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.remoting.RemotingClient  </span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">invokeAsync</span><span class="params">(<span class="keyword">final</span> String addr, <span class="keyword">final</span> RemotingCommand request, <span class="keyword">final</span> <span class="keyword">long</span> timeoutMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> InvokeCallback invokeCallback)</span> <span class="keyword">throws</span> InterruptedException, RemotingConnectException,</span></span><br><span class="line"><span class="function">        RemotingTooMuchRequestException, RemotingTimeoutException, RemotingSendRequestException</span>;</span><br></pre></td></tr></table></figure>

<p>而RemotingClient的具体实现类，只有一个：NettyRemotingClient，那就真相了，后续Broker BEBUG的时候，需要找到<em><strong>netty</strong></em>相关的代码，即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// org.apache.rocketmq.remoting.netty.NettyRemotingClient</span></span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invokeAsync</span><span class="params">(String addr, RemotingCommand request, <span class="keyword">long</span> timeoutMillis, InvokeCallback invokeCallback)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> InterruptedException, RemotingConnectException, RemotingTooMuchRequestException, RemotingTimeoutException,</span></span><br><span class="line"><span class="function">        RemotingSendRequestException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> beginStartTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">final</span> Channel channel = <span class="keyword">this</span>.getAndCreateChannel(addr); <span class="comment">//使用netty Channel发送</span></span><br><span class="line">        String channelRemoteAddr = RemotingHelper.parseChannelRemoteAddr(channel);</span><br><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isActive()) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                doBeforeRpcHooks(channelRemoteAddr, request);</span><br><span class="line">                <span class="keyword">long</span> costTime = System.currentTimeMillis() - beginStartTime;</span><br><span class="line">                <span class="keyword">if</span> (timeoutMillis &lt; costTime) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingTooMuchRequestException(<span class="string">&quot;invokeAsync call the addr[&quot;</span> + channelRemoteAddr + <span class="string">&quot;] timeout&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.invokeAsyncImpl(channel, request, timeoutMillis - costTime, <span class="keyword">new</span> InvokeCallbackWrapper(invokeCallback, addr));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RemotingSendRequestException e) &#123;</span><br><span class="line">                LOGGER.warn(<span class="string">&quot;invokeAsync: send request exception, so close the channel[&#123;&#125;]&quot;</span>, channelRemoteAddr);</span><br><span class="line">                <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.closeChannel(addr, channel);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemotingConnectException(addr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们在Broker module搜索<em><strong>RemotingCommand</strong></em>和<em><strong>netty</strong></em>关键字的代码，发现引用RemotingCommand的类，有很多Processor，而且都继承接口<em><strong>NettyRequestProcessor</strong></em>，所以，我们都在这些Processor类上，都打上断点。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024314.jpg" alt="008vOhrAgy1hfj38rzypwj319e0u07c7"></p>
<p>然后，再执行生产者，产生消息的shell：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh bin/tools.sh org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure>

<p>这是发现，断点进到Broker的<em><strong>NettyRequestProcessor</strong></em>，后续可以在broker中，愉快的DEBUG代码了。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-024326.jpg" alt="008vOhrAgy1hfj3d7r6yhj31gi0u0qai"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/05/05/SpringBoot3%20Native%20Image%E6%9E%84%E5%BB%BA%E6%8E%A2%E7%A7%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/05/SpringBoot3%20Native%20Image%E6%9E%84%E5%BB%BA%E6%8E%A2%E7%A7%98/" class="post-title-link" itemprop="url">SpringBoot3 Native Image探秘</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-05-05 16:52:07" itemprop="dateCreated datePublished" datetime="2023-05-05T16:52:07+08:00">2023-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-28 15:07:13" itemprop="dateModified" datetime="2023-06-28T15:07:13+08:00">2023-06-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="SpringBoot3-如何构建Native-Image"><a href="#SpringBoot3-如何构建Native-Image" class="headerlink" title="SpringBoot3 如何构建Native Image"></a>SpringBoot3 如何构建Native Image</h1><p>以Gradle为例子，使用bootBuildImage命令，即可构建一个Native Image。</p>
<h1 id="背后的工具"><a href="#背后的工具" class="headerlink" title="背后的工具"></a>背后的工具</h1><h2 id="Buildpacks"><a href="#Buildpacks" class="headerlink" title="Buildpacks"></a>Buildpacks</h2><p>##paketobuildpacks</p>
<p><a target="_blank" rel="noopener" href="https://paketo.io/docs/howto/java/">https://paketo.io/docs/howto/java/</a></p>
<h2 id="liberica-native-image-kit"><a href="#liberica-native-image-kit" class="headerlink" title="liberica-native-image-kit"></a>liberica-native-image-kit</h2><p><a target="_blank" rel="noopener" href="https://bell-sw.com/announcements/2022/09/07/garbage-collection-in-java/">https://bell-sw.com/announcements/2022/09/07/garbage-collection-in-java/</a></p>
<h2 id="grype"><a href="#grype" class="headerlink" title="grype"></a>grype</h2><p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/Z8128Ope7MVzfAgLNH9F">https://www.infoq.cn/article/Z8128Ope7MVzfAgLNH9F</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/anchore/grype">https://github.com/anchore/grype</a></p>
<h1 id="SpringBoot3-Native-Image分层"><a href="#SpringBoot3-Native-Image分层" class="headerlink" title="SpringBoot3 Native Image分层"></a>SpringBoot3 Native Image分层</h1><p>ubuntu</p>
<h1 id="SpringBoot3-Native-Image的一些思考"><a href="#SpringBoot3-Native-Image的一些思考" class="headerlink" title="SpringBoot3 Native Image的一些思考"></a>SpringBoot3 Native Image的一些思考</h1><h2 id="graalvm-gc-support-native-image"><a href="#graalvm-gc-support-native-image" class="headerlink" title="graalvm gc support native image"></a>graalvm gc support native image</h2><p>Native Image运行时，没有Jvm，如何内存管理？</p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/22.0/reference-manual/native-image/MemoryManagement/">https://www.graalvm.org/22.0/reference-manual/native-image/MemoryManagement/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/oracle/graal/pull/5362">https://github.com/oracle/graal/pull/5362</a></p>
<h2 id="Native-Image执行性能，基本持平-C1-JIT-Compiler，稍微逊色C2-JIT-Compiler"><a href="#Native-Image执行性能，基本持平-C1-JIT-Compiler，稍微逊色C2-JIT-Compiler" class="headerlink" title="Native Image执行性能，基本持平 C1 JIT Compiler，稍微逊色C2 JIT Compiler"></a>Native Image执行性能，基本持平 C1 JIT Compiler，稍微逊色C2 JIT Compiler</h2><p><a target="_blank" rel="noopener" href="https://www.beyondjava.net/graalvm-dictionary-bytecode-c1-c2-compiler">https://www.beyondjava.net/graalvm-dictionary-bytecode-c1-c2-compiler</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.com/articles/native-java-graalvm/">https://www.infoq.com/articles/native-java-graalvm/</a></p>
<p><a target="_blank" rel="noopener" href="https://medium.com/graalvm/libgraal-graalvm-compiler-as-a-precompiled-graalvm-native-image-26e354bee5c">https://medium.com/graalvm/libgraal-graalvm-compiler-as-a-precompiled-graalvm-native-image-26e354bee5c</a></p>
<p><a target="_blank" rel="noopener" href="https://gunceljava.blogspot.com/2018/11/just-in-time-compilation-jit.html">https://gunceljava.blogspot.com/2018/11/just-in-time-compilation-jit.html</a></p>
<p><a target="_blank" rel="noopener" href="https://senoritadeveloper.medium.com/introduction-to-graalvm-5822086f8c19">https://senoritadeveloper.medium.com/introduction-to-graalvm-5822086f8c19</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/11/23/SpringBoot3%E5%BF%AB%E9%80%9F%E4%BD%93%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/11/23/SpringBoot3%E5%BF%AB%E9%80%9F%E4%BD%93%E9%AA%8C/" class="post-title-link" itemprop="url">SpringBoot3快速体验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-11-23 18:45:08" itemprop="dateCreated datePublished" datetime="2022-11-23T18:45:08+08:00">2022-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-03 11:33:16" itemprop="dateModified" datetime="2023-07-03T11:33:16+08:00">2023-07-03</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="工程配置"><a href="#工程配置" class="headerlink" title="工程配置"></a>工程配置</h1><h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ul>
<li>JDK17</li>
<li>Gradle7.5</li>
<li>IntelliJ IDEA 2022</li>
</ul>
<h2 id="工程配置-1"><a href="#工程配置-1" class="headerlink" title="工程配置"></a>工程配置</h2><p>使用gradle创建验证性的工程，因为使用SpringBoot3是3.0.0-RC版本，需要在setting.gradle里面，添加spring的maven仓库。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pluginManagement &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://repo.spring.io/milestone&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>root的build.gradle中，添加spring的maven仓库</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        maven &#123; url <span class="string">&#x27;https://repo.spring.io/milestone&#x27;</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>引入<strong>org.springframework.boot</strong>插件和<strong>org.graalvm.buildtools.native</strong>插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;java&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;java-library&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;project-report&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;idea&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;3.0.0-RC2&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">    id <span class="string">&#x27;org.graalvm.buildtools.native&#x27;</span> version <span class="string">&#x27;0.9.17&#x27;</span> apply <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringBoot module里面，开启插件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.springframework.boot&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.graalvm.buildtools.native&quot;</span></span><br></pre></td></tr></table></figure>

<p>引入SpringBoot3依赖</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;</span><br><span class="line">    springBootVersion = <span class="string">&#x27;3.0.0-RC2&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">  implementation(platform(<span class="string">&quot;org.springframework.boot:spring-boot-dependencies:$springBootVersion&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务启动类和API接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置完成上述插件和代码后，可以在gradle看到以下tasks。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033042.jpg" alt="008vxvgGgy1h8f9pkdai6j30ls0oamys"></p>
<p>执行bootBuildImage，会得到一个docker image，SpringBoot3的云原生的容器镜像。日志如下：</p>
<p><strong>大致流程</strong>如下：</p>
<ol>
<li><p>拉取构建build native image的 builder image （docker.io/paketobuildpacks/builder:tiny，docker.io/paketobuildpacks/run:tiny-cnb）</p>
</li>
<li><p>开始构建云原生镜像（Running creator）</p>
<ul>
<li><p>分析（ANALYZING），目标云原生镜像是否存在</p>
</li>
<li><p>检测（DETECTING），检测所需依赖lib的版本（paketo-buildpacks/ca-certificates，paketo-buildpacks/bellsoft-liberica等）</p>
</li>
<li><p>保存（RESTORING），保存所需依赖lib版本</p>
</li>
<li><p>构建（BUILDING），拉取所以依赖lib，设置构建配置（比如 $BP_JVM_TYPE                 JRE                                                          the JVM type - JDK or JRE）</p>
</li>
<li><p><strong>GraalVM虚拟机</strong>，编译代码，构建Natvie Image（GraalVM Native Image）,这是核心步骤，7步，具体每步干啥，可以参考GraalVM官方文档，<a target="_blank" rel="noopener" href="https://www.graalvm.org/22.0/reference-manual/native-image/BuildOutput/">链接</a>。</p>
<ul>
<li>初始化（Initializing），初始化GraalVM虚拟机的各种依赖版本（比如：Version info: ‘GraalVM 22.3.0 Java 17 CE’，Java version info: ‘17.0.5+8-LTS’），设置属性初始值（比如：Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2SmilePresent set to false at build time）</li>
<li>执行分析（Performing analysis），编写的代码和引入的jar包，哪些classes，fields，methods是有使用的，哪些classes、fields、methonds有使用反射，有使用JNI，使用哪些native libraries（耗时步骤：200+s）</li>
<li>构建上下文（Building Universe），包含所有classes，fields，methods，用于最后的创建的Native Image</li>
<li>解析方法（Parsing Methods ），解析使用到的方法</li>
<li>内联方法（Inlining Methods），内联使用到的方法</li>
<li>编译方法（Compiling Methods），GraalVM虚拟机，最终将用到的方法，编译成机器代码（耗时步骤：130+s）</li>
<li>生产镜像（Creating Image），生成Native Image到本机Docker images</li>
</ul>
</li>
</ul>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br></pre></td><td class="code"><pre><span class="line">&gt; Task :springboot3:bootBuildImage</span><br><span class="line">Building image &#x27;docker.io/library/springboot3:1.0.0&#x27;</span><br><span class="line"></span><br><span class="line"> &gt; Pulling builder image &#x27;docker.io/paketobuildpacks/builder:tiny&#x27; ..................................................</span><br><span class="line"> &gt; Pulled builder image &#x27;paketobuildpacks/builder@sha256:853c60ed091daf2abf5b376f8178a3ccf754b15fe45666b720d278fe48ba8c42&#x27;</span><br><span class="line"> &gt; Pulling run image &#x27;docker.io/paketobuildpacks/run:tiny-cnb&#x27; ..................................................</span><br><span class="line"> &gt; Pulled run image &#x27;paketobuildpacks/run@sha256:6edd2f36f33b08a4553449b91cd4f4d4bcffd1c8d7677b35790d1b80fa13720c&#x27;</span><br><span class="line"> &gt; Executing lifecycle version v0.15.1</span><br><span class="line"> &gt; Using build cache volume &#x27;pack-cache-64ae48079398.build&#x27;</span><br><span class="line"></span><br><span class="line"> &gt; Running creator</span><br><span class="line">    [creator]     ===&gt; ANALYZING</span><br><span class="line">    [creator]     Previous image with name &quot;docker.io/library/springboot3:1.0.0&quot; not found</span><br><span class="line">    [creator]     ===&gt; DETECTING</span><br><span class="line">    [creator]     6 of 14 buildpacks participating</span><br><span class="line">    [creator]     paketo-buildpacks/ca-certificates   3.5.0</span><br><span class="line">    [creator]     paketo-buildpacks/bellsoft-liberica 9.10.0</span><br><span class="line">    [creator]     paketo-buildpacks/syft              1.22.1</span><br><span class="line">    [creator]     paketo-buildpacks/executable-jar    6.5.0</span><br><span class="line">    [creator]     paketo-buildpacks/spring-boot       5.20.0</span><br><span class="line">    [creator]     paketo-buildpacks/native-image      5.6.0</span><br><span class="line">    [creator]     ===&gt; RESTORING</span><br><span class="line">    [creator]     ===&gt; BUILDING</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for CA Certificates 3.5.0</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/ca-certificates</span><br><span class="line">    [creator]       Launch Helper: Contributing to layer</span><br><span class="line">    [creator]         Creating /layers/paketo-buildpacks_ca-certificates/helper/exec.d/ca-certificates-helper</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for BellSoft Liberica 9.10.0</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/bellsoft-liberica</span><br><span class="line">    [creator]       Build Configuration:</span><br><span class="line">    [creator]         $BP_JVM_JLINK_ARGS           --no-man-pages --no-header-files --strip-debug --compress=1  configure custom link arguments (--output must be omitted)</span><br><span class="line">    [creator]         $BP_JVM_JLINK_ENABLED        false                                                        enables running jlink tool to generate custom JRE</span><br><span class="line">    [creator]         $BP_JVM_TYPE                 JRE                                                          the JVM type - JDK or JRE</span><br><span class="line">    [creator]         $BP_JVM_VERSION              11                                                           the Java version</span><br><span class="line">    [creator]       Launch Configuration:</span><br><span class="line">    [creator]         $BPL_DEBUG_ENABLED           false                                                        enables Java remote debugging support</span><br><span class="line">    [creator]         $BPL_DEBUG_PORT              8000                                                         configure the remote debugging port</span><br><span class="line">    [creator]         $BPL_DEBUG_SUSPEND           false                                                        configure whether to suspend execution until a debugger has attached</span><br><span class="line">    [creator]         $BPL_HEAP_DUMP_PATH                                                                       write heap dumps on error to this path</span><br><span class="line">    [creator]         $BPL_JAVA_NMT_ENABLED        true                                                         enables Java Native Memory Tracking (NMT)</span><br><span class="line">    [creator]         $BPL_JAVA_NMT_LEVEL          summary                                                      configure level of NMT, summary or detail</span><br><span class="line">    [creator]         $BPL_JFR_ARGS                                                                             configure custom Java Flight Recording (JFR) arguments</span><br><span class="line">    [creator]         $BPL_JFR_ENABLED             false                                                        enables Java Flight Recording (JFR)</span><br><span class="line">    [creator]         $BPL_JMX_ENABLED             false                                                        enables Java Management Extensions (JMX)</span><br><span class="line">    [creator]         $BPL_JMX_PORT                5000                                                         configure the JMX port</span><br><span class="line">    [creator]         $BPL_JVM_HEAD_ROOM           0                                                            the headroom in memory calculation</span><br><span class="line">    [creator]         $BPL_JVM_LOADED_CLASS_COUNT  35% of classes                                               the number of loaded classes in memory calculation</span><br><span class="line">    [creator]         $BPL_JVM_THREAD_COUNT        250                                                          the number of threads in memory calculation</span><br><span class="line">    [creator]         $JAVA_TOOL_OPTIONS                                                                        the JVM launch flags</span><br><span class="line">    [creator]         Using Java version 17 extracted from MANIFEST.MF</span><br><span class="line">    [creator]       BellSoft Liberica NIK 17.0.5: Contributing to layer</span><br><span class="line">    [creator]         Downloading from https://download.bell-sw.com/vm/22.3.0/bellsoft-liberica-vm-core-openjdk17.0.5+8-22.3.0+2-linux-amd64.tar.gz</span><br><span class="line">    [creator]         Verifying checksum</span><br><span class="line">    [creator]         Expanding to /layers/paketo-buildpacks_bellsoft-liberica/native-image-svm</span><br><span class="line">    [creator]         Adding 127 container CA certificates to JVM truststore</span><br><span class="line">    [creator]         Writing env.build/JAVA_HOME.override</span><br><span class="line">    [creator]         Writing env.build/JDK_HOME.override</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for Syft 1.22.1</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/syft</span><br><span class="line">    [creator]         Downloading from https://github.com/anchore/syft/releases/download/v0.60.3/syft_0.60.3_linux_amd64.tar.gz</span><br><span class="line">    [creator]         Verifying checksum</span><br><span class="line">    [creator]         Writing env.build/SYFT_CHECK_FOR_APP_UPDATE.default</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for Executable JAR 6.5.0</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/executable-jar</span><br><span class="line">    [creator]       Class Path: Contributing to layer</span><br><span class="line">    [creator]         Writing env.build/CLASSPATH.delim</span><br><span class="line">    [creator]         Writing env.build/CLASSPATH.prepend</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for Spring Boot 5.20.0</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/spring-boot</span><br><span class="line">    [creator]       Build Configuration:</span><br><span class="line">    [creator]         $BP_SPRING_CLOUD_BINDINGS_DISABLED   false  whether to contribute Spring Boot cloud bindings support</span><br><span class="line">    [creator]       Launch Configuration:</span><br><span class="line">    [creator]         $BPL_SPRING_CLOUD_BINDINGS_DISABLED  false  whether to auto-configure Spring Boot environment properties from bindings</span><br><span class="line">    [creator]         $BPL_SPRING_CLOUD_BINDINGS_ENABLED   true   Deprecated - whether to auto-configure Spring Boot environment properties from bindings</span><br><span class="line">    [creator]       Class Path: Contributing to layer</span><br><span class="line">    [creator]         native args file /workspace/META-INF/native-image/argfile</span><br><span class="line">    [creator]         Writing env.build/BP_NATIVE_IMAGE_BUILD_ARGUMENTS_FILE.default</span><br><span class="line">    [creator]         Writing env.build/CLASSPATH.append</span><br><span class="line">    [creator]         Writing env.build/CLASSPATH.delim</span><br><span class="line">    [creator]       Image labels:</span><br><span class="line">    [creator]         org.springframework.boot.version</span><br><span class="line">    [creator]     Warning: BOM table is deprecated in this buildpack api version, though it remains supported for backwards compatibility. Buildpack authors should write BOM information to &lt;layer&gt;.sbom.&lt;ext&gt;, launch.sbom.&lt;ext&gt;, or build.sbom.&lt;ext&gt;.</span><br><span class="line">    [creator]     </span><br><span class="line">    [creator]     Paketo Buildpack for Native Image 5.6.0</span><br><span class="line">    [creator]       https://github.com/paketo-buildpacks/native-image</span><br><span class="line">    [creator]       Build Configuration:</span><br><span class="line">    [creator]         $BP_BINARY_COMPRESSION_METHOD                                                    Compression mechanism used to reduce binary size. Options: `none` (default), `upx` or `gzexe`</span><br><span class="line">    [creator]         $BP_NATIVE_IMAGE                       true                                      enable native image build</span><br><span class="line">    [creator]         $BP_NATIVE_IMAGE_BUILD_ARGUMENTS                                                 arguments to pass to the native-image command</span><br><span class="line">    [creator]         $BP_NATIVE_IMAGE_BUILD_ARGUMENTS_FILE  /workspace/META-INF/native-image/argfile  a file with arguments to pass to the native-image command</span><br><span class="line">    [creator]         $BP_NATIVE_IMAGE_BUILT_ARTIFACT                                                  the built application artifact explicitly, required if building from a JAR</span><br><span class="line">    [creator]       Native Image: Contributing to layer</span><br><span class="line">    [creator]         Executing native-image -H:+StaticExecutableWithDynamicLibC @/workspace/META-INF/native-image/argfile -H:Name=/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application -cp /workspace:/workspace/BOOT-INF/classes:/workspace/BOOT-INF/lib/lombok-1.18.24.jar:/workspace/BOOT-INF/lib/guava-27.1-jre.jar:/workspace/BOOT-INF/lib/jackson-datatype-jsr310-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-module-parameter-names-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-core-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-datatype-jdk8-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-databind-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/jackson-annotations-2.14.0-rc3.jar:/workspace/BOOT-INF/lib/log4j-to-slf4j-2.19.0.jar:/workspace/BOOT-INF/lib/log4j-api-2.19.0.jar:/workspace/BOOT-INF/lib/spring-webmvc-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-web-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/micrometer-observation-1.10.0.jar:/workspace/BOOT-INF/lib/micrometer-commons-1.10.0.jar:/workspace/BOOT-INF/lib/spring-boot-autoconfigure-3.0.0-RC2.jar:/workspace/BOOT-INF/lib/spring-boot-3.0.0-RC2.jar:/workspace/BOOT-INF/lib/spring-context-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-aop-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-beans-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-expression-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-core-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/spring-jcl-6.0.0-RC4.jar:/workspace/BOOT-INF/lib/jakarta.annotation-api-2.1.1.jar:/workspace/BOOT-INF/lib/logback-classic-1.4.4.jar:/workspace/BOOT-INF/lib/logback-core-1.4.4.jar:/workspace/BOOT-INF/lib/jul-to-slf4j-2.0.3.jar:/workspace/BOOT-INF/lib/slf4j-api-2.0.3.jar:/workspace/BOOT-INF/lib/snakeyaml-1.33.jar:/workspace/BOOT-INF/lib/tomcat-embed-websocket-10.1.1.jar:/workspace/BOOT-INF/lib/tomcat-embed-core-10.1.1.jar:/workspace/BOOT-INF/lib/tomcat-embed-el-10.1.1.jar:/workspace/BOOT-INF/lib/failureaccess-1.0.1.jar:/workspace/BOOT-INF/lib/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar:/workspace/BOOT-INF/lib/jsr305-3.0.2.jar:/workspace/BOOT-INF/lib/checker-qual-2.5.2.jar:/workspace/BOOT-INF/lib/error_prone_annotations-2.2.0.jar:/workspace/BOOT-INF/lib/j2objc-annotations-1.1.jar:/workspace/BOOT-INF/lib/animal-sniffer-annotations-1.17.jar pers.james.practice.springboog3.Application</span><br><span class="line">    [creator]     ================================================================================</span><br><span class="line">    [creator]     GraalVM Native Image: Generating &#x27;/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application&#x27; (static executable)...</span><br><span class="line">    [creator]     ================================================================================</span><br><span class="line">    [creator]     [1/7] Initializing...                                           (11.2s @ 0.22GB)</span><br><span class="line">    [creator]      Version info: &#x27;GraalVM 22.3.0 Java 17 CE&#x27;</span><br><span class="line">    [creator]      Java version info: &#x27;17.0.5+8-LTS&#x27;</span><br><span class="line">    [creator]      C compiler: gcc (linux, x86_64, 7.5.0)</span><br><span class="line">    [creator]      Garbage collector: Serial GC</span><br><span class="line">    [creator]      1 user-specific feature(s)</span><br><span class="line">    [creator]      - org.springframework.aot.nativex.feature.PreComputeFieldFeature</span><br><span class="line">    [creator]     The bundle named: org.apache.el.Messages, has not been found. If the bundle is part of a module, verify the bundle name is a fully qualified class name. Otherwise verify the bundle path is accessible in the classpath.</span><br><span class="line">    [creator]     Field org.springframework.core.NativeDetector#imageCode set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.format.support.DefaultFormattingConversionService#jsr354Present set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.KotlinDetector#kotlinPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.KotlinDetector#kotlinReflectPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#romePresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jaxb2Present set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2Present set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2XmlPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2SmilePresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jackson2CborPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#gsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#jsonbPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.config.annotation.WebMvcConfigurationSupport#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.boot.logging.logback.LogbackLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.boot.logging.log4j2.Log4J2LoggingSystem$Factory#PRESENT set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.boot.logging.java.JavaLoggingSystem$Factory#PRESENT set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.view.InternalResourceViewResolver#jstlPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.context.support.StandardServletEnvironment#jndiPresent set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jaxb2Present set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2Present set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2XmlPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jackson2SmilePresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#gsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#jsonbPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.http.converter.support.AllEncompassingFormHttpMessageConverter#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.context.event.ApplicationListenerMethodAdapter#reactiveStreamsPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.context.support.WebApplicationContextUtils#jsfPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.context.request.RequestContextHolder#jsfPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.boot.autoconfigure.web.format.WebConversionService#JSR_354_PRESENT set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#romePresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jaxb2Present set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jackson2Present set to true at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jackson2XmlPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jackson2SmilePresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jackson2CborPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#gsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#jsonbPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationCborPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationJsonPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.client.RestTemplate#kotlinSerializationProtobufPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.ReactiveAdapterRegistry#reactorPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.ReactiveAdapterRegistry#rxjava3Present set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.ReactiveAdapterRegistry#kotlinCoroutinesPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.core.ReactiveAdapterRegistry#mutinyPresent set to false at build time</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.mvc.method.annotation.ReactiveTypeHandler#isContextPropagationPresent will be evaluated at runtime due to this error during build time evaluation: org.slf4j.spi.SLF4JServiceProvider: ch.qos.logback.classic.spi.LogbackServiceProvider not a subtype</span><br><span class="line">    [creator]     Field org.springframework.web.servlet.support.RequestContext#jstlPresent set to false at build time</span><br><span class="line">    [creator]     [2/7] Performing analysis...  [*********]                      (215.2s @ 1.28GB)</span><br><span class="line">    [creator]       15,670 (92.37%) of 16,964 classes reachable</span><br><span class="line">    [creator]       25,869 (67.79%) of 38,159 fields reachable</span><br><span class="line">    [creator]       75,776 (62.18%) of 121,858 methods reachable</span><br><span class="line">    [creator]          788 classes,   166 fields, and 3,521 methods registered for reflection</span><br><span class="line">    [creator]           64 classes,    70 fields, and    55 methods registered for JNI access</span><br><span class="line">    [creator]            4 native libraries: dl, pthread, rt, z</span><br><span class="line">    [creator]     [3/7] Building universe...                                      (58.9s @ 1.26GB)</span><br><span class="line">    [creator]     GC warning: 31.1s spent in 10 GCs during the last stage, taking up 52.68% of the time.</span><br><span class="line">    [creator]                 Please ensure more than 1.74GB of memory is available for Native Image</span><br><span class="line">    [creator]                 to reduce GC overhead and improve image build time.</span><br><span class="line">    [creator]     [4/7] Parsing methods...      [*****]                           (27.9s @ 1.10GB)</span><br><span class="line">    [creator]     [5/7] Inlining methods...     [***]                             (10.0s @ 1.09GB)</span><br><span class="line">    [creator]     [6/7] Compiling methods...    [***********]                    (138.3s @ 1.15GB)</span><br><span class="line">    [creator]     [7/7] Creating image...                                         (43.0s @ 1.31GB)</span><br><span class="line">    [creator]       33.84MB (45.94%) for code area:    49,725 compilation units</span><br><span class="line">    [creator]       37.03MB (50.27%) for image heap:  371,461 objects and 420 resources</span><br><span class="line">    [creator]        2.79MB ( 3.79%) for other data</span><br><span class="line">    [creator]       73.65MB in total</span><br><span class="line">    [creator]     --------------------------------------------------------------------------------</span><br><span class="line">    [creator]     Top 10 packages in code area:           Top 10 object types in image heap:</span><br><span class="line">    [creator]        1.63MB sun.security.ssl                 7.45MB byte[] for code metadata</span><br><span class="line">    [creator]        1.06MB java.util                        6.03MB byte[] for embedded resources</span><br><span class="line">    [creator]      827.16KB java.lang.invoke                 3.74MB java.lang.Class</span><br><span class="line">    [creator]      718.01KB com.sun.crypto.provider          3.50MB java.lang.String</span><br><span class="line">    [creator]      541.01KB org.apache.catalina.core         3.11MB byte[] for general heap data</span><br><span class="line">    [creator]      499.54KB org.apache.tomcat.util.net       2.86MB byte[] for java.lang.String</span><br><span class="line">    [creator]      490.49KB org.apache.coyote.http2          1.32MB c.o.s.c.h.DynamicHubCompanion</span><br><span class="line">    [creator]      472.92KB java.lang                      835.87KB byte[] for reflection metadata</span><br><span class="line">    [creator]      470.23KB c.s.o.a.xerces.internal.impl   679.55KB java.lang.String[]</span><br><span class="line">    [creator]      461.63KB sun.security.x509              607.22KB java.util.HashMap$Node</span><br><span class="line">    [creator]       26.41MB for 658 more packages            6.10MB for 3120 more object types</span><br><span class="line">    [creator]     --------------------------------------------------------------------------------</span><br><span class="line">    [creator]       164.1s (29.2% of total time) in 257 GCs | Peak RSS: 1.74GB | CPU load: 1.44</span><br><span class="line">    [creator]     --------------------------------------------------------------------------------</span><br><span class="line">    [creator]     Produced artifacts:</span><br><span class="line">    [creator]      /layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application (executable)</span><br><span class="line">    [creator]      /layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application.build_artifacts.txt (txt)</span><br><span class="line">    [creator]     ================================================================================</span><br><span class="line">    [creator]     Finished generating &#x27;/layers/paketo-buildpacks_native-image/native-image/pers.james.practice.springboog3.Application&#x27; in 9m 20s.</span><br><span class="line">    [creator]       Removing bytecode</span><br><span class="line">    [creator]       Process types:</span><br><span class="line">    [creator]         native-image: /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">    [creator]         task:         /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">    [creator]         web:          /workspace/pers.james.practice.springboog3.Application (direct)</span><br><span class="line">    [creator]     ===&gt; EXPORTING</span><br><span class="line">    [creator]     Adding layer &#x27;paketo-buildpacks/ca-certificates:helper&#x27;</span><br><span class="line">    [creator]     Adding layer &#x27;launch.sbom&#x27;</span><br><span class="line">    [creator]     Adding 1/1 app layer(s)</span><br><span class="line">    [creator]     Adding layer &#x27;launcher&#x27;</span><br><span class="line">    [creator]     Adding layer &#x27;config&#x27;</span><br><span class="line">    [creator]     Adding layer &#x27;process-types&#x27;</span><br><span class="line">    [creator]     Adding label &#x27;io.buildpacks.lifecycle.metadata&#x27;</span><br><span class="line">    [creator]     Adding label &#x27;io.buildpacks.build.metadata&#x27;</span><br><span class="line">    [creator]     Adding label &#x27;io.buildpacks.project.metadata&#x27;</span><br><span class="line">    [creator]     Adding label &#x27;org.springframework.boot.version&#x27;</span><br><span class="line">    [creator]     Setting default process type &#x27;web&#x27;</span><br><span class="line">    [creator]     Saving docker.io/library/springboot3:1.0.0...</span><br><span class="line">    [creator]     *** Images (12137cda1f20):</span><br><span class="line">    [creator]           docker.io/library/springboot3:1.0.0</span><br><span class="line">    [creator]     Adding cache layer &#x27;paketo-buildpacks/bellsoft-liberica:native-image-svm&#x27;</span><br><span class="line">    [creator]     Adding cache layer &#x27;paketo-buildpacks/syft:syft&#x27;</span><br><span class="line">    [creator]     Adding cache layer &#x27;paketo-buildpacks/native-image:native-image&#x27;</span><br><span class="line">    [creator]     Adding cache layer &#x27;cache.sbom&#x27;</span><br><span class="line"></span><br><span class="line">Successfully built image &#x27;docker.io/library/springboot3:1.0.0&#x27;</span><br><span class="line"></span><br><span class="line">Persisted dependency lock state for project &#x27;:springboot3&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个任务执行，比较耗时，11min。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033112.jpg" alt="008vxvgGgy1h8f9u94ab5j30y40243yz"></p>
<p>然后在本机上，可以看到一个docker images</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033129.jpg" alt="008vxvgGgy1h8f9y5lyhfj31e2036js3"></p>
<p>启动docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -p 8080:8080 docker.io/library/springboot3:1.0.0</span><br></pre></td></tr></table></figure>

<p>SpringBoot启动日志，启动速度非常快</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">  .   ____          _            __ _ _</span><br><span class="line"> /\\ / ___&#x27;_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="line">( ( )\___ | &#x27;_ | &#x27;_| | &#x27;_ \/ _` | \ \ \ \</span><br><span class="line"> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )</span><br><span class="line">  &#x27;  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="line"> =========|_|==============|___/=/_/_/_/</span><br><span class="line"> :: Spring Boot ::            (v3.0.0-RC2)</span><br><span class="line"></span><br><span class="line">2022-11-23T10:16:08.247Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : Starting AOT-processed Application using Java 17.0.5 with PID 1 (/workspace/pers.james.practice.springboog3.Application started by cnb in /workspace)</span><br><span class="line">2022-11-23T10:16:08.247Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : No active profile set, falling back to 1 default profile: &quot;default&quot;</span><br><span class="line">2022-11-23T10:16:08.260Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)</span><br><span class="line">2022-11-23T10:16:08.261Z  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]</span><br><span class="line">2022-11-23T10:16:08.261Z  INFO 1 --- [           main] o.apache.catalina.core.StandardEngine    : Starting Servlet engine: [Apache Tomcat/10.1.1]</span><br><span class="line">2022-11-23T10:16:08.265Z  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext</span><br><span class="line">2022-11-23T10:16:08.265Z  INFO 1 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 18 ms</span><br><span class="line">2022-11-23T10:16:08.295Z  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path &#x27;&#x27;</span><br><span class="line">2022-11-23T10:16:08.296Z  INFO 1 --- [           main] p.j.practice.springboog3.Application     : Started Application in 0.058 seconds (process running for 0.07)</span><br></pre></td></tr></table></figure>

<p>系统占用内存，也非常低，使用docker stats观察docker占用内存。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033143.jpg" alt="008vxvgGgy1h8fa24m6avj318w03eq3h"></p>
<p>访问API接口</p>
<p><img src="/Users/zhanhao/Desktop/1111/008vxvgGgy1h8fa3oyp8sj30ou01yjrh.jpg" alt="008vxvgGgy1h8fa3oyp8sj30ou01yjrh"></p>
<p>后台日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet &#x27;dispatcherServlet&#x27;</span><br><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#x27;dispatcherServlet&#x27;</span><br><span class="line">2022-11-23T10:16:37.488Z  INFO 1 --- [nio-8080-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 0 ms</span><br></pre></td></tr></table></figure>

<p>另外build目录下，也会产生AOT(ahead-of-time)提前编译，    相关目录和编译中间结果</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033308.jpg" alt="008vxvgGgy1h8g6book3lj30su172gro"></p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-033251.jpg" alt="008vxvgGgy1h8g6f76710j30u00wpad7"></p>
<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/3.0.0-RC2/reference/htmlsingle/#native-image.developing-your-first-application.buildpacks.gradle">SpringBoot官网-GraalVM Native Image Support Gradle</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/3.0.0-RC2/gradle-plugin/reference/htmlsingle/#aot">SpringBoot官网-gradle-plugin</a></p>
<p><a target="_blank" rel="noopener" href="https://www.graalvm.org/22.0/reference-manual/native-image/BuildOutput/">GraalVM-Build-Output</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/19/SOFAJRaft%E5%85%83%E4%BF%A1%E6%81%AFMeta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">SOFAJRaft元信息Meta存储分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-19 17:03:51" itemprop="dateCreated datePublished" datetime="2022-09-19T17:03:51+08:00">2022-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-22 16:32:39" itemprop="dateModified" datetime="2022-09-22T16:32:39+08:00">2022-09-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Meta%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">Meta存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="一、SOFAJRaft元信息"><a href="#一、SOFAJRaft元信息" class="headerlink" title="一、SOFAJRaft元信息"></a>一、SOFAJRaft元信息</h1><p>引用SOFARaft，关于Meta元信息存储定义如下：</p>
<blockquote>
<p>Meta 存储，元信息存储，记录 raft 实现的内部状态，比如当前 term,、投票给哪个节点等信息。</p>
</blockquote>
<p>Meta信息核心接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.RaftMetaStorage</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage主要方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.RaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RaftMetaStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">RaftMetaStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTerm</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get current term.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PeerId <span class="title">getVotedFor</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Set term and voted for information.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setTermAndVotedFor</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> PeerId peerId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RaftMetaStorage只有一个实现类：LocalRaftMetaStorage，从名字可以看出来，具体实现，是以本地存储为主。即以本地文件的形式完成Meta信息的存储。</p>
<p>LocalRaftMetaStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalRaftMetaStorage</span> <span class="keyword">implements</span> <span class="title">RaftMetaStorage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String        path; <span class="comment">//本地文件存储路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                term; <span class="comment">//选举任期</span></span><br><span class="line">    <span class="keyword">private</span> PeerId              votedFor  = PeerId.emptyPeer(); <span class="comment">//选举投票给谁</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LocalRaftMetaStorage的主要方法，主要分为Set，Get两类:</p>
<p>其中Set类，保存term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">    <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setVotedFor</span><span class="params">(<span class="keyword">final</span> PeerId peerId)</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">this</span>.votedFor = peerId;</span><br><span class="line">    <span class="keyword">return</span> save();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//保存主要逻辑</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> start = Utils.monotonicMs();</span><br><span class="line">    <span class="keyword">final</span> StablePBMeta meta = StablePBMeta.newBuilder() <span class="comment">//存储格式是Protobuf文件格式内容</span></span><br><span class="line">        .setTerm(<span class="keyword">this</span>.term) </span><br><span class="line">        .setVotedfor(<span class="keyword">this</span>.votedFor.toString()) </span><br><span class="line">        .build();</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();<span class="comment">//Protobuf文件</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!pbFile.save(meta, <span class="keyword">this</span>.raftOptions.isSyncMeta())) &#123;<span class="comment">//写入文件</span></span><br><span class="line">            reportIOError();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to save raft meta&quot;</span>, e);</span><br><span class="line">        reportIOError();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - start;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.nodeMetrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;save-raft-meta&quot;</span>, cost);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.info(<span class="string">&quot;Save raft meta, path=&#123;&#125;, term=&#123;&#125;, votedFor=&#123;&#125;, cost time=&#123;&#125; ms&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.term,</span><br><span class="line">            <span class="keyword">this</span>.votedFor, cost);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>StablePBMeta是实现了protobuf的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.entity.LocalStorageOutter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StablePBMeta</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">google</span>.<span class="title">protobuf</span>.<span class="title">GeneratedMessageV3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>   term_;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> java.lang.Object votedfor_;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>保存protobuf文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.io.ProtoBufFile</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">(<span class="keyword">final</span> Message msg, <span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Write message into temp file</span></span><br><span class="line">    <span class="keyword">final</span> File file = <span class="keyword">new</span> File(<span class="keyword">this</span>.path + <span class="string">&quot;.tmp&quot;</span>);<span class="comment">//先保存tmp文件</span></span><br><span class="line">    <span class="keyword">try</span> (<span class="keyword">final</span> FileOutputStream fOut = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            <span class="keyword">final</span> BufferedOutputStream output = <span class="keyword">new</span> BufferedOutputStream(fOut)) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] lenBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// name len + name</span></span><br><span class="line">        <span class="keyword">final</span> String fullName = msg.getDescriptorForType().getFullName();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> nameLen = fullName.length();</span><br><span class="line">        Bits.putInt(lenBytes, <span class="number">0</span>, nameLen);</span><br><span class="line">        output.write(lenBytes);</span><br><span class="line">        output.write(fullName.getBytes());</span><br><span class="line">        <span class="comment">// msg len + msg</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> msgLen = msg.getSerializedSize();</span><br><span class="line">        Bits.putInt(lenBytes, <span class="number">0</span>, msgLen);</span><br><span class="line">        output.write(lenBytes);</span><br><span class="line">        msg.writeTo(output);</span><br><span class="line">        output.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sync) &#123; <span class="comment">//同步刷盘</span></span><br><span class="line">        Utils.fsync(file);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Utils.atomicMoveFile(file, <span class="keyword">new</span> File(<span class="keyword">this</span>.path), sync); <span class="comment">//tmp文件 -&gt; 正式文件</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中Get类，读取term和voteFor。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.LocalRaftMetaStorage</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTerm</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.term; <span class="comment">//直接读取属性，初始化的时候，有load方法，从磁盘文件读取。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PeerId <span class="title">getVotedFor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    checkState();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.votedFor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> RaftMetaStorageOptions opts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isInited) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Raft meta storage is already inited.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.node = opts.getNode();</span><br><span class="line">    <span class="keyword">this</span>.nodeMetrics = <span class="keyword">this</span>.node.getNodeMetrics();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileUtils.forceMkdir(<span class="keyword">new</span> File(<span class="keyword">this</span>.path));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to mkdir &#123;&#125;&quot;</span>, <span class="keyword">this</span>.path, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (load()) &#123;<span class="comment">//从磁盘文件读取</span></span><br><span class="line">        <span class="keyword">this</span>.isInited = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> ProtoBufFile pbFile = newPbFile();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> StablePBMeta meta = pbFile.load();<span class="comment">//从Protobuf文件读取</span></span><br><span class="line">        <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.term = meta.getTerm();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.votedFor.parse(meta.getVotedfor());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> FileNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to load raft meta storage&quot;</span>, e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="二、SOFAJRaft元信息使用"><a href="#二、SOFAJRaft元信息使用" class="headerlink" title="二、SOFAJRaft元信息使用"></a>二、SOFAJRaft元信息使用</h1><p>SOFAJRaft元信息的使用，主要发生在选举的过程中，具体代码在Node的实现类NodeImpl.java里面。</p>
<p>场景1：比如开始选举时，把选票投给自己的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">electSelf</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> oldTerm;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; start vote and grant vote self, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.conf.contains(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; can&#x27;t do electSelf as it is not in &#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.conf);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_FOLLOWER) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Node &#123;&#125; stop election timer, term=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">this</span>.electionTimer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">        resetLeaderId(PeerId.emptyPeer(), <span class="keyword">new</span> Status(RaftError.ERAFTTIMEDOUT,</span><br><span class="line">            <span class="string">&quot;A follower&#x27;s leader_id is reset to NULL as it begins to request_vote.&quot;</span>));</span><br><span class="line">        <span class="keyword">this</span>.state = State.STATE_CANDIDATE;</span><br><span class="line">        <span class="keyword">this</span>.currTerm++;</span><br><span class="line">        <span class="keyword">this</span>.votedId = <span class="keyword">this</span>.serverId.copy();</span><br><span class="line">        LOG.debug(<span class="string">&quot;Node &#123;&#125; start vote timer, term=&#123;&#125; .&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">        <span class="keyword">this</span>.voteTimer.start();</span><br><span class="line">        <span class="keyword">this</span>.voteCtx.init(<span class="keyword">this</span>.conf.getConf(), <span class="keyword">this</span>.conf.isStable() ? <span class="keyword">null</span> : <span class="keyword">this</span>.conf.getOldConf());</span><br><span class="line">        oldTerm = <span class="keyword">this</span>.currTerm;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// vote need defense ABA after unlock&amp;writeLock</span></span><br><span class="line">        <span class="keyword">if</span> (oldTerm != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when getLastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">final</span> PeerId peer : <span class="keyword">this</span>.conf.listPeers()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (peer.equals(<span class="keyword">this</span>.serverId)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.rpcService.connect(peer.getEndpoint())) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Node &#123;&#125; channel init failed, address=&#123;&#125;.&quot;</span>, getNodeId(), peer.getEndpoint());</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> OnRequestVoteRpcDone done = <span class="keyword">new</span> OnRequestVoteRpcDone(peer, <span class="keyword">this</span>.currTerm, <span class="keyword">this</span>);</span><br><span class="line">            done.request = RequestVoteRequest.newBuilder() <span class="comment">//</span></span><br><span class="line">                .setPreVote(<span class="keyword">false</span>) <span class="comment">// It&#x27;s not a pre-vote request.</span></span><br><span class="line">                .setGroupId(<span class="keyword">this</span>.groupId) <span class="comment">//</span></span><br><span class="line">                .setServerId(<span class="keyword">this</span>.serverId.toString()) <span class="comment">//</span></span><br><span class="line">                .setPeerId(peer.toString()) <span class="comment">//</span></span><br><span class="line">                .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">                .setLastLogIndex(lastLogId.getIndex()) <span class="comment">//</span></span><br><span class="line">                .setLastLogTerm(lastLogId.getTerm()) <span class="comment">//</span></span><br><span class="line">                .build();</span><br><span class="line">            <span class="keyword">this</span>.rpcService.requestVote(peer.getEndpoint(), done.request, done);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(<span class="keyword">this</span>.currTerm, <span class="keyword">this</span>.serverId); <span class="comment">//term和serverId都是Node自身的属性</span></span><br><span class="line">        <span class="keyword">this</span>.voteCtx.grant(<span class="keyword">this</span>.serverId);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.voteCtx.isGranted()) &#123;</span><br><span class="line">            becomeLeader();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景2：降级，收到更高的任期的时候</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stepDown</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> term, <span class="keyword">final</span> <span class="keyword">boolean</span> wakeupCandidate, <span class="keyword">final</span> Status status)</span> </span>&#123;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Node &#123;&#125; stepDown, term=&#123;&#125;, newTerm=&#123;&#125;, wakeupCandidate=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm, term,</span><br><span class="line">        wakeupCandidate);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_CANDIDATE) &#123;</span><br><span class="line">        stopVoteTimer();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.state.compareTo(State.STATE_TRANSFERRING) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        stopStepDownTimer();</span><br><span class="line">        <span class="keyword">this</span>.ballotBox.clearPendingTasks();</span><br><span class="line">        <span class="comment">// signal fsm leader stop immediately</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.state == State.STATE_LEADER) &#123;</span><br><span class="line">            onLeaderStop(status);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// reset leader_id</span></span><br><span class="line">    resetLeaderId(PeerId.emptyPeer(), status);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// soft state in memory</span></span><br><span class="line">    <span class="keyword">this</span>.state = State.STATE_FOLLOWER;</span><br><span class="line">    <span class="keyword">this</span>.confCtx.reset();</span><br><span class="line">    updateLastLeaderTimestamp(Utils.monotonicMs());</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.snapshotExecutor != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.snapshotExecutor.interruptDownloadingSnapshots(term);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// meta state</span></span><br><span class="line">    <span class="keyword">if</span> (term &gt; <span class="keyword">this</span>.currTerm)  <span class="comment">//收到更高的term</span></span><br><span class="line">        <span class="keyword">this</span>.currTerm = term;</span><br><span class="line">        <span class="keyword">this</span>.votedId = PeerId.emptyPeer();</span><br><span class="line">        <span class="keyword">this</span>.metaStorage.setTermAndVotedFor(term, <span class="keyword">this</span>.votedId);<span class="comment">//只更新term</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (wakeupCandidate) &#123;</span><br><span class="line">        <span class="keyword">this</span>.wakingCandidate = <span class="keyword">this</span>.replicatorGroup.stopAllAndFindTheNextCandidate(<span class="keyword">this</span>.conf);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.wakingCandidate != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Replicator.sendTimeoutNowAndStop(<span class="keyword">this</span>.wakingCandidate, <span class="keyword">this</span>.options.getElectionTimeoutMs());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.replicatorGroup.stopAll();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.stopTransferArg != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.transferTimer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.transferTimer.cancel(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// There is at most one StopTransferTimer at the same term, it&#x27;s safe to</span></span><br><span class="line">        <span class="comment">// mark stopTransferArg to NULL</span></span><br><span class="line">        <span class="keyword">this</span>.stopTransferArg = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Learner node will not trigger the election timer.</span></span><br><span class="line">    <span class="keyword">if</span> (!isLearner()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.electionTimer.restart();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Node &#123;&#125; is a learner, election timer is not started.&quot;</span>, <span class="keyword">this</span>.nodeId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>场景3：收到其他候选人的选票时</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.core.NodeImpl</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Message <span class="title">handleRequestVoteRequest</span><span class="params">(<span class="keyword">final</span> RequestVoteRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.state.isActive()) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; is not in active state, currTerm=&#123;&#125;.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">            <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">                .responseFactory() <span class="comment">//</span></span><br><span class="line">                .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                    <span class="string">&quot;Node %s is not in active state, state %s.&quot;</span>, getNodeId(), <span class="keyword">this</span>.state.name());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> PeerId candidateId = <span class="keyword">new</span> PeerId();</span><br><span class="line">        <span class="keyword">if</span> (!candidateId.parse(request.getServerId())) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125; serverId bad format.&quot;</span>, getNodeId(),</span><br><span class="line">                request.getServerId());</span><br><span class="line">            <span class="keyword">return</span> RpcFactoryHelper <span class="comment">//</span></span><br><span class="line">                .responseFactory() <span class="comment">//</span></span><br><span class="line">                .newResponse(RequestVoteResponse.getDefaultInstance(), RaftError.EINVAL,</span><br><span class="line">                    <span class="string">&quot;Parse candidateId failed: %s.&quot;</span>, request.getServerId());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// noinspection ConstantConditions</span></span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="comment">// check term</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() &gt;= <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                LOG.info(<span class="string">&quot;Node &#123;&#125; received RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                    request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="comment">// increase current term, change state to follower</span></span><br><span class="line">                <span class="keyword">if</span> (request.getTerm() &gt; <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                    stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EHIGHERTERMRESPONSE,</span><br><span class="line">                        <span class="string">&quot;Raft node receives higher term RequestVoteRequest.&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// ignore older term</span></span><br><span class="line">                LOG.info(<span class="string">&quot;Node &#123;&#125; ignore RequestVoteRequest from &#123;&#125;, term=&#123;&#125;, currTerm=&#123;&#125;.&quot;</span>, getNodeId(),</span><br><span class="line">                    request.getServerId(), request.getTerm(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            doUnlock = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> LogId lastLogId = <span class="keyword">this</span>.logManager.getLastLogId(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            doUnlock = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">            <span class="comment">// vote need ABA check after unlock&amp;writeLock</span></span><br><span class="line">            <span class="keyword">if</span> (request.getTerm() != <span class="keyword">this</span>.currTerm) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Node &#123;&#125; raise term &#123;&#125; when get lastLogId.&quot;</span>, getNodeId(), <span class="keyword">this</span>.currTerm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> logIsOk = <span class="keyword">new</span> LogId(request.getLastLogIndex(), request.getLastLogTerm())</span><br><span class="line">                .compareTo(lastLogId) &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (logIsOk &amp;&amp; (<span class="keyword">this</span>.votedId == <span class="keyword">null</span> || <span class="keyword">this</span>.votedId.isEmpty())) &#123;</span><br><span class="line">                stepDown(request.getTerm(), <span class="keyword">false</span>, <span class="keyword">new</span> Status(RaftError.EVOTEFORCANDIDATE,</span><br><span class="line">                    <span class="string">&quot;Raft node votes for some candidate, step down to restart election_timer.&quot;</span>));</span><br><span class="line">                <span class="keyword">this</span>.votedId = candidateId.copy();</span><br><span class="line">                <span class="keyword">this</span>.metaStorage.setVotedFor(candidateId); <span class="comment">//更新候选人信息</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RequestVoteResponse.newBuilder() <span class="comment">//</span></span><br><span class="line">            .setTerm(<span class="keyword">this</span>.currTerm) <span class="comment">//</span></span><br><span class="line">            .setGranted(request.getTerm() == <span class="keyword">this</span>.currTerm &amp;&amp; candidateId.equals(<span class="keyword">this</span>.votedId)) <span class="comment">//</span></span><br><span class="line">            .build();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/18/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%89%EF%BC%89/" class="post-title-link" itemprop="url">SOFAJRaft日志存储分析（三）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-18 15:49:53 / Modified: 21:12:07" itemprop="dateCreated datePublished" datetime="2022-08-18T15:49:53+08:00">2022-08-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="LogStorage其他实现分析"><a href="#LogStorage其他实现分析" class="headerlink" title="LogStorage其他实现分析"></a>LogStorage其他实现分析</h1><p>上篇<a target="_blank" rel="noopener" href="https://barryzhanhao.github.io/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">SOFAJRaft日志存储分析（二）</a>中，着重分析了LogStorage的默认实现RocksDBLogStorage，还剩其他实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.HybridLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.LogitLogStorage</span><br><span class="line">com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span><br></pre></td></tr></table></figure>

<h2 id="BDBLogStorage"><a href="#BDBLogStorage" class="headerlink" title="BDBLogStorage"></a>BDBLogStorage</h2><p>BDBLogStorage和RocksDBLogStorage很类似，底层存储都依赖嵌入K-V数据库，BDBLogStorage使用的是oracle的<a target="_blank" rel="noopener" href="https://github.com/berkeleydb">berkeley-db</a>, <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/zh-cn/Berkeley_DB">维基定义</a></p>
<blockquote>
<p><strong>Berkeley DB</strong>（BDB）是一个高效的嵌入式<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>和<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%94%AE-%E5%80%BC%E6%95%B0%E6%8D%AE%E5%BA%93">键-值数据库</a>编程库，<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">C语言</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/C%2B%2B">C++</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Java">Java</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Perl">Perl</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Python">Python</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Tcl">Tcl</a>以及其他很多语言都有其对应的API。Berkeley DB可以保存任意类型的键/值对（Key/Value Pair），而且可以为一个键保存多个数据。Berkeley DB支持让数千的并发线程同时操作数据库，支持最大256TB的数据，广泛用于各种操作系统，其中包括大多数<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Unix-like">类Unix</a>操作系统、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Microsoft_Windows">Windows</a>操作系统以及<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AE%9E%E6%97%B6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F">实时操作系统</a>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BDBLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span>, <span class="title">Describer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOG                   = LoggerFactory.getLogger(BDBLogStorage.class);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String         DEFAULT_DATABASE_NAME = <span class="string">&quot;jraft-log&quot;</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String         CONF_DATABASE_NAME    = <span class="string">&quot;jraft-conf&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String              groupId;</span><br><span class="line">    <span class="keyword">private</span> Database            defaultTable; <span class="comment">//实际底层存储berkeley-db，com.sleepycat.je.Database</span></span><br><span class="line">    <span class="keyword">private</span> Database            confTable;</span><br><span class="line">    <span class="keyword">private</span> Environment         environment;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String        homePath; <span class="comment">//berkeley-db的目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>             opened                = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> LogEntryEncoder     logEntryEncoder;</span><br><span class="line">    <span class="keyword">private</span> LogEntryDecoder     logEntryDecoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock readWriteLock         = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock          readLock              = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock          writeLock             = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>       sync;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>       firstLogIndex         = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>    hasLoadFirstLogIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法"><a href="#getEntry读取方法" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage </span></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            checkState();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            DatabaseEntry logEntry = <span class="keyword">new</span> DatabaseEntry();</span><br><span class="line">            OperationStatus operationStatus = <span class="keyword">this</span>.defaultTable.get(<span class="keyword">null</span>, getKeyDatabaseEntry(index), logEntry,</span><br><span class="line">                LockMode.DEFAULT); <span class="comment">//调用berkeley-db的get方法</span></span><br><span class="line">            <span class="keyword">if</span> (isSuccessOperation(operationStatus)) &#123;</span><br><span class="line">                <span class="keyword">return</span> toLogEntry(logEntry);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125;.&quot;</span>, index, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法"><a href="#appendEntry写入方法" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//com.alipay.sofa.jraft.storage.impl.BDBLogStorage   </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(LogEntry entry)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">       Transaction txn = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           checkState();</span><br><span class="line">           DatabaseEntry key = getKeyDatabaseEntry(entry.getId().getIndex());</span><br><span class="line">           DatabaseEntry value = toDatabaseEntry(entry);</span><br><span class="line">           txn = beginTransaction();</span><br><span class="line">           <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">               <span class="keyword">this</span>.confTable.put(txn, key, value);</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.defaultTable.put(txn, key, value); <span class="comment">//调用berkeley-db的put方法</span></span><br><span class="line">           txn.commit();</span><br><span class="line">           syncIfNeed();</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (DatabaseException e) &#123;</span><br><span class="line">           LOG.error(<span class="string">&quot;Fail to append entry &#123;&#125;.&quot;</span>, entry, e);</span><br><span class="line">           <span class="keyword">if</span> (txn != <span class="keyword">null</span>) &#123;</span><br><span class="line">               txn.abort();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="RocksDBSegmentLogStorage"><a href="#RocksDBSegmentLogStorage" class="headerlink" title="RocksDBSegmentLogStorage"></a>RocksDBSegmentLogStorage</h2><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，在RocksDB的存储能力上，加入文件Segment功能(和LogManager的Segment不是一个概念)，<strong>是为了解决大数据Value写入的问题</strong>。</p>
<p>RocksDBSegmentLogStorage的主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RocksDBSegmentLogStorage</span> <span class="keyword">extends</span> <span class="title">RocksDBLogStorage</span> </span>&#123; <span class="comment">//继承 RocksDBLogStorage</span></span><br><span class="line">  </span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   valueSizeThreshold; <span class="comment">//Value大小阀值，大于该值，使用Segment文件存储，小于的使用RocksDB直接存储</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String                segmentsPath; <span class="comment">//Segment文件存放路径</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CheckpointFile        checkpointFile;</span><br><span class="line">    <span class="comment">// used  or using segments.</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;SegmentFile&gt;           segments; <span class="comment">//Segment文件列表</span></span><br><span class="line">    <span class="comment">// pre-allocated and blank segments.</span></span><br><span class="line">    <span class="keyword">private</span> ArrayDeque&lt;AllocatedResult&gt; blankSegments; <span class="comment">//预分配Segments</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock                  allocateLock             = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition             fullCond                 = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition             emptyCond                = <span class="keyword">this</span>.allocateLock.newCondition();</span><br><span class="line">    <span class="comment">// segment file sequence.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong            nextFileSequence         = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock         readWriteLock            = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock                  writeLock                = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock                  readLock                 = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService    checkpointExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AbortFile             abortFile;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor    writeExecutor; <span class="comment">//Segments异步写入线程池</span></span><br><span class="line">    <span class="keyword">private</span> Thread                      segmentAllocator; <span class="comment">//Segment预分配器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span>                   maxSegmentFileSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                         preAllocateSegmentCount  = PRE_ALLOCATE_SEGMENT_COUNT; <span class="comment">//Segment预分数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                         keepInMemorySegmentCount = MEM_SEGMENT_COUNT;<span class="comment">//Segment内存保留数量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                         checkpointIntervalMs     = DEFAULT_CHECKPOINT_INTERVAL_MS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SegmentFile是带缓存的固定格式的文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A fixed size file. The content format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   magic bytes       first log index    reserved</span></span><br><span class="line"><span class="comment"> *   [0x20 0x20]      [... 8 bytes...]   [8 bytes]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   [record, record, ...]</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Every record format is:</span></span><br><span class="line"><span class="comment"> * &lt;pre&gt;</span></span><br><span class="line"><span class="comment"> *   Magic bytes     data length   data</span></span><br><span class="line"><span class="comment"> *   [0x57, 0x8A]    [4 bytes]     [bytes]</span></span><br><span class="line"><span class="comment"> *&lt;/pre&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentFile</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">SegmentFileOptions</span>&gt; </span>&#123;</span><br><span class="line">     * Magic bytes <span class="keyword">for</span> data buffer.</span><br><span class="line">     */</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[]       RECORD_MAGIC_BYTES      = <span class="keyword">new</span> <span class="keyword">byte</span>[] &#123; (<span class="keyword">byte</span>) <span class="number">0x57</span>, (<span class="keyword">byte</span>) <span class="number">0x8A</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>          RECORD_MAGIC_BYTES_SIZE = RECORD_MAGIC_BYTES.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SegmentHeader      header;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The file last log index(inclusive)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span>            lastLogIndex            = Long.MAX_VALUE;</span><br><span class="line">    <span class="comment">// File size</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                      size;</span><br><span class="line">    <span class="comment">// File path</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String             path; <span class="comment">//文件path</span></span><br><span class="line">    <span class="comment">// mmap byte buffer.</span></span><br><span class="line">    <span class="keyword">private</span> MappedByteBuffer         buffer; <span class="comment">//缓存</span></span><br><span class="line">    <span class="comment">// Wrote position.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             wrotePos; <span class="comment">//游标</span></span><br><span class="line">    <span class="comment">// Committed position</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span>             committedPos;<span class="comment">//游标</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock      readWriteLock           = <span class="keyword">new</span> ReentrantReadWriteLock(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock               writeLock               = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock               readLock                = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor writeExecutor;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         swappedOut;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>         readOnly;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                     swappedOutTimestamp     = -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String             filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-1"><a href="#appendEntry写入方法-1" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><p>RocksDBSegmentLogStorage继承默认实现RocksDBLogStorage，appendEntry写入方法还是调用的父类RocksDBLogStorage的appendEntry写入方法，只是父类RocksDBLogStorage预留了一些hook钩子方法，RocksDBSegmentLogStorage通过实现这些钩子方法，扩展功能。</p>
<p>RocksDBLogStorage父类，appendEntry写入方法的扩展点，父类中，扩展点，均没实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">            <span class="keyword">return</span> executeBatch(batch -&gt; addConfBatch(entry, batch));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.db == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    LOG.warn(<span class="string">&quot;DB not initialized or destroyed in data path: &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> WriteContext writeCtx = newWriteContext(); <span class="comment">//扩展点 写入上下文WriteContext</span></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] valueBytes = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] newValueBytes = onDataAppend(logIndex, valueBytes, writeCtx); <span class="comment">//扩展点onDataAppend</span></span><br><span class="line">                writeCtx.startJob(); <span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">                <span class="keyword">this</span>.db.put(<span class="keyword">this</span>.defaultHandle, <span class="keyword">this</span>.writeOptions, getKeyBytes(logIndex), newValueBytes);</span><br><span class="line">                writeCtx.joinAll();<span class="comment">//扩展点，写入上下文WriteContext生命周期</span></span><br><span class="line">                <span class="keyword">if</span> (newValueBytes != valueBytes) &#123;</span><br><span class="line">                    doSync();<span class="comment">// //扩展点，Segment文件刷盘</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">                LOG.error(<span class="string">&quot;Fail to append entry.&quot;</span>, e);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//可以复写protected </span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> WriteContext <span class="title">newWriteContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> EmptyWriteContext.INSTANCE; <span class="comment">//空实现</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//数据写入，前置方法，可以复写protected </span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value,</span><br><span class="line">                                  <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">        ctx.finishJob();</span><br><span class="line">        <span class="keyword">return</span> value; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        onSync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//空方法，可以复写protected </span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>WriteContext写入上下文，实现写入任务化，异步化，和生命周期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A write context</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Start a sub job.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Finish a sub job</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Adds a callback that will be invoked after all sub jobs finish.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Set an exception to context.</span></span><br><span class="line"><span class="comment">       * <span class="doctag">@param</span> e exception</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/**</span></span><br><span class="line"><span class="comment">       * Wait for all sub jobs finish.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>子类RocksDBSegmentLogStorage扩展点，实现方式：</p>
<p>首先是BarrierWriteContext，支持多个Job写入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//类似CyclicBarrier </span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BarrierWriteContext</span> <span class="keyword">implements</span> <span class="title">WriteContext</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownEvent    events = <span class="keyword">new</span> CountDownEvent();</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Exception      e;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Runnable&gt; hooks;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.events.incrementAndGet();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">addFinishHook</span><span class="params">(<span class="keyword">final</span> Runnable r)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hooks == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.hooks = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.hooks.add(r);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">finishJob</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.events.countDown();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setError</span><span class="params">(<span class="keyword">final</span> Exception e)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.e = e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">joinAll</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.events.await();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.hooks != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Runnable r : <span class="keyword">this</span>.hooks) &#123;</span><br><span class="line">                    r.run();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Fail to apppend entries&quot;</span>, <span class="keyword">this</span>.e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//await和notify</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownEvent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>             state    = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock      lock     = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Condition busyCond = <span class="keyword">this</span>.lock.newCondition();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object attachment;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getAttachment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.attachment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAttachment</span><span class="params">(<span class="keyword">final</span> Object attachment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.attachment = attachment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">incrementAndGet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ++<span class="keyword">this</span>.state;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countDown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (--<span class="keyword">this</span>.state == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.busyCond.signalAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.state &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.busyCond.await();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扩展方法：onDataAppend</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataAppend(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value, <span class="keyword">final</span> WriteContext ctx) <span class="keyword">throws</span> IOException,                                                                                                InterruptedException &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteBytes = SegmentFile.getWriteBytes(value);</span><br><span class="line">        SegmentFile lastSegmentFile = getLastSegmentFile(logIndex, waitToWroteBytes, <span class="keyword">true</span>, ctx);<span class="comment">//获取Semgent文件</span></span><br><span class="line">        <span class="keyword">if</span> (lastSegmentFile.reachesFileEndBy(waitToWroteBytes)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Too large value size: &quot;</span> + value.length + <span class="string">&quot;, maxSegmentFileSize=&quot;</span></span><br><span class="line">                                  + <span class="keyword">this</span>.maxSegmentFileSize);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value.length &lt; <span class="keyword">this</span>.valueSizeThreshold) &#123; <span class="comment">//小value，直接写入Rocksdb</span></span><br><span class="line">            <span class="comment">// Small value will be stored in rocksdb directly.</span></span><br><span class="line">            lastSegmentFile.setLastLogIndex(logIndex);</span><br><span class="line">            ctx.finishJob();<span class="comment">//调用WriteContext上下文的生命周期方法</span></span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">// Large value is stored in segment file and returns an encoded location info that will be stored in rocksdb.</span></span><br><span class="line">       <span class="comment">//大Value</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pos = lastSegmentFile.write(logIndex, value, ctx);<span class="comment">//写入Segment，不是同步写入，后台线程异步写入</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = lastSegmentFile.getFirstLogIndex();</span><br><span class="line">        <span class="keyword">return</span> encodeLocationMetadata(firstLogIndex, pos); <span class="comment">//返回metadata，不是实际存储的value，实际的value在Segment文件里面</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SegmentFile <span class="title">getLastSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> waitToWroteSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">final</span> <span class="keyword">boolean</span> createIfNecessary, <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">                                                                                                   InterruptedException </span>&#123;</span><br><span class="line">        SegmentFile lastFile = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> segmentCount = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; <span class="comment">//存在Segment文件</span></span><br><span class="line">                    segmentCount = <span class="keyword">this</span>.segments.size();</span><br><span class="line">                    <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">                    <span class="keyword">if</span> (waitToWroteSize &lt;= <span class="number">0</span> || !currLastFile.reachesFileEndBy(waitToWroteSize)) &#123;</span><br><span class="line">                        lastFile = currLastFile;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (lastFile == <span class="keyword">null</span> &amp;&amp; createIfNecessary) &#123;</span><br><span class="line">                lastFile = createNewSegmentFile(logIndex, segmentCount, ctx); <span class="comment">//不存在，创建</span></span><br><span class="line">                <span class="keyword">if</span> (lastFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> lastFile;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Try again</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> lastFile;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SegmentFile <span class="title">createNewSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">int</span> oldSegmentCount,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             <span class="keyword">final</span> WriteContext ctx)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        SegmentFile segmentFile = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// CAS by segments count.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.segments.size() != oldSegmentCount) &#123;</span><br><span class="line">                <span class="keyword">return</span> segmentFile;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.segments.isEmpty()) &#123; </span><br><span class="line">                <span class="comment">// Sync current last file and correct it&#x27;s lastLogIndex.</span></span><br><span class="line">                <span class="keyword">final</span> SegmentFile currLastFile = getLastSegmentWithoutLock();</span><br><span class="line">                currLastFile.setLastLogIndex(logIndex - <span class="number">1</span>);</span><br><span class="line">                ctx.startJob();</span><br><span class="line">                <span class="comment">// Attach a finish hook to set last segment file to be read-only.</span></span><br><span class="line">                ctx.addFinishHook(() -&gt; currLastFile.setReadOnly(<span class="keyword">true</span>));</span><br><span class="line">                <span class="comment">// Run sync in parallel</span></span><br><span class="line">                <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//异步写入，线程池</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        currLastFile.sync(isSync());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">                        ctx.setError(e);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        ctx.finishJob();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            segmentFile = allocateSegmentFile(logIndex);<span class="comment">//从预分配Semgent读取</span></span><br><span class="line">            <span class="keyword">return</span> segmentFile;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SegmentFile <span class="title">allocateSegmentFile</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.allocateLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.emptyCond.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> AllocatedResult result = <span class="keyword">this</span>.blankSegments.pollFirst();<span class="comment">//预分配队列</span></span><br><span class="line">            <span class="keyword">if</span> (result.ie != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> result.ie;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.fullCond.signal();</span><br><span class="line">            result.segmentFile.setFirstLogIndex(index);</span><br><span class="line">            <span class="keyword">this</span>.segments.add(result.segmentFile);</span><br><span class="line">            <span class="keyword">return</span> result.segmentFile;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.allocateLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>lastSegmentFile.write，Segment的写方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> WriteContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> pos = -<span class="number">1</span>;</span><br><span class="line">    MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> (<span class="keyword">this</span>.wrotePos == <span class="keyword">this</span>.buffer.position());</span><br><span class="line">        buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">        pos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">        <span class="keyword">this</span>.wrotePos += RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE + data.length;</span><br><span class="line">        <span class="keyword">this</span>.buffer.position(<span class="keyword">this</span>.wrotePos);</span><br><span class="line">        <span class="comment">// Update log index.</span></span><br><span class="line">        <span class="keyword">if</span> (isBlank() || pos == HEADER_SIZE) &#123;</span><br><span class="line">            <span class="keyword">this</span>.header.firstLogIndex = logIndex;</span><br><span class="line">            <span class="comment">// we don&#x27;t need to call fsync header here, the new header will be flushed with this wrote.</span></span><br><span class="line">            saveHeader(<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.lastLogIndex = logIndex;</span><br><span class="line">        <span class="keyword">return</span> pos;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> wroteIndex = pos;</span><br><span class="line">        <span class="keyword">final</span> MappedByteBuffer buffer = buf;</span><br><span class="line">        <span class="keyword">this</span>.writeExecutor.execute(() -&gt; &#123; <span class="comment">//线程，异步写入</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                put(buffer, wroteIndex, RECORD_MAGIC_BYTES); <span class="comment">//写入 魔法数字</span></span><br><span class="line">                putInt(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE, data.length); <span class="comment">//写入头信息</span></span><br><span class="line">                put(buffer, wroteIndex + RECORD_MAGIC_BYTES_SIZE + RECORD_DATA_LENGTH_SIZE, data);<span class="comment">//写入数据data</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                ctx.setError(e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                ctx.finishJob();<span class="comment">//调用声明写上下文周期方法</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>encodeLocationMetadata方法，生产的metadata信息，才是写入的RocksDB的Value数据，返回父类，会触发newValueBytes != valueBytes条件，会调用刷盘doSync()方法，可能会引起刷盘（需要isSync=true）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"> </span><br><span class="line"> * <span class="function">Encode segment file <span class="title">firstLogIndex</span><span class="params">(fileName)</span> and position to a <span class="keyword">byte</span> array in the format of:</span></span><br><span class="line"><span class="function"> * &lt;ul&gt;</span></span><br><span class="line"><span class="function"> *  &lt;li&gt; magic <span class="title">bytes</span><span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function"> *  &lt;li&gt; <span class="title">reserved</span> <span class="params">(<span class="number">2</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function"> *  &lt;li&gt; <span class="title">firstLogIndex</span><span class="params">(<span class="number">8</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function"> *  &lt;li&gt; wrote <span class="title">position</span><span class="params">(<span class="number">4</span> B)</span>&lt;/li&gt;</span></span><br><span class="line"><span class="function"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="function"> * @param firstLogIndex the first log index</span></span><br><span class="line"><span class="function"> * @param pos           the wrote position</span></span><br><span class="line"><span class="function"> * @return segment info</span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span>[] <span class="title">encodeLocationMetadata</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex, <span class="keyword">final</span> <span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] newData = <span class="keyword">new</span> <span class="keyword">byte</span>[LOCATION_METADATA_SIZE];</span><br><span class="line">    System.arraycopy(SegmentFile.RECORD_MAGIC_BYTES, <span class="number">0</span>, newData, <span class="number">0</span>, SegmentFile.RECORD_MAGIC_BYTES_SIZE);</span><br><span class="line">    <span class="comment">// 2 bytes reserved</span></span><br><span class="line">    Bits.putLong(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span>, firstLogIndex);</span><br><span class="line">    Bits.putInt(newData, SegmentFile.RECORD_MAGIC_BYTES_SIZE + <span class="number">2</span> + <span class="number">8</span>, pos);</span><br><span class="line">    <span class="keyword">return</span> newData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//覆盖父类的onSync方法</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSync</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> SegmentFile lastSegmentFile = getLastSegmentFileForRead();</span><br><span class="line">      <span class="keyword">if</span> (lastSegmentFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">            lastSegmentFile.sync(isSync());<span class="comment">//调用Segment文件的sync方法</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Segment文件的sync方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.SegmentFile</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Forces any changes made to this segment file&#x27;s content to be written to the</span></span><br><span class="line"><span class="comment">    * storage device containing the mapped file.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sync</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">       MappedByteBuffer buf = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (<span class="keyword">this</span>.committedPos &gt;= <span class="keyword">this</span>.wrotePos) &#123;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">this</span>.committedPos = <span class="keyword">this</span>.wrotePos;</span><br><span class="line">           buf = <span class="keyword">this</span>.buffer;</span><br><span class="line">           LOG.debug(<span class="string">&quot;Commit segment file &#123;&#125; at pos &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path, <span class="keyword">this</span>.committedPos);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (sync) &#123;</span><br><span class="line">           fsync(buf);<span class="comment">//刷盘</span></span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fsync</span><span class="params">(<span class="keyword">final</span> MappedByteBuffer buffer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (buffer != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">           buffer.force(); <span class="comment">//MappedByteBuffer的flush方法</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">long</span> cost = Utils.monotonicMs() - startMs;</span><br><span class="line">           <span class="keyword">if</span> (cost &gt;= FSYNC_COST_MS_THRESHOLD) &#123;</span><br><span class="line">               LOG.warn(<span class="string">&quot;Call fsync on file &#123;&#125;  cost &#123;&#125; ms.&quot;</span>, <span class="keyword">this</span>.path, cost);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>另外，后台Segment分配线程，加快分配逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSegmentAllocator</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// Warmup</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.blankSegments.isEmpty()) &#123;</span><br><span class="line">        doAllocateSegment0();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Start the thread.</span></span><br><span class="line">    <span class="keyword">this</span>.segmentAllocator = <span class="keyword">new</span> Thread(<span class="keyword">this</span>::doAllocateSegment);</span><br><span class="line">    <span class="keyword">this</span>.segmentAllocator.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">this</span>.segmentAllocator.setName(<span class="string">&quot;SegmentAllocator&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.segmentAllocator.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAllocateSegment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;SegmentAllocator is started.&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">        doAllocateSegmentInLock();</span><br><span class="line">        doSwapOutSegments(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;SegmentAllocator exit.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntrys写入方法-多个Entrys"><a href="#appendEntrys写入方法-多个Entrys" class="headerlink" title="appendEntrys写入方法(多个Entrys)"></a>appendEntrys写入方法(多个Entrys)</h3><p>RocksDBLogStorage父类，多个Entrys，WriteContext的notify方法就可以串起来</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (entries == <span class="keyword">null</span> || entries.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> entriesCount = entries.size();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> ret = executeBatch(batch -&gt; &#123;</span><br><span class="line">          <span class="keyword">final</span> WriteContext writeCtx = newWriteContext();<span class="comment">//初始化上下文</span></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entriesCount; i++) &#123;</span><br><span class="line">              <span class="keyword">final</span> LogEntry entry = entries.get(i);</span><br><span class="line">              <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">                  addConfBatch(entry, batch);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  writeCtx.startJob(); <span class="comment">//开起任务，任务数+1</span></span><br><span class="line">                  addDataBatch(entry, batch, writeCtx);<span class="comment">//写入上下文传递</span></span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          writeCtx.joinAll(); <span class="comment">//等待所有job完成</span></span><br><span class="line">          doSync(); <span class="comment">//刷一个Segment到磁盘</span></span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">          <span class="keyword">return</span> entriesCount;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-1"><a href="#getEntry读取方法-1" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><p>同写入方法，RocksDBSegmentLogStorage读取方法，通过扩展父类RocksDBLogStorage的扩展方法，实现Segment文件的读取。</p>
<p>父类的读取扩展方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.impl.RocksDBLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> getEntryFromDB(index);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125; in data path: &#123;&#125;.&quot;</span>, index, <span class="keyword">this</span>.path, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OnlyForTest</span></span><br><span class="line"><span class="function">LogEntry <span class="title">getEntryFromDB</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> IOException, RocksDBException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = getKeyBytes(index);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">byte</span>[] bs = onDataGet(index, getValueFromRocksDB(keyBytes));<span class="comment">//扩展方法OnDataGet</span></span><br><span class="line">  <span class="keyword">if</span> (bs != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logEntryDecoder.decode(bs);</span><br><span class="line">      <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> entry;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          LOG.error(<span class="string">&quot;Bad log entry format for index=&#123;&#125;, the log data is: &#123;&#125;.&quot;</span>, index, BytesUtil.toHex(bs));</span><br><span class="line">          <span class="comment">// invalid data remove? TODO</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//直接放回，可以复写protected</span></span><br><span class="line">		<span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>RocksDBSegmentLogStorage的onDataGet方法，才是关键</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.log.RocksDBSegmentLogStorage  </span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">byte</span>[] onDataGet(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] value) <span class="keyword">throws</span> IOException &#123;<span class="comment">//这里的Value是从RockDB读取的值</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.length != LOCATION_METADATA_SIZE) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> offset = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; offset &lt; SegmentFile.RECORD_MAGIC_BYTES_SIZE; offset++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value[offset] != SegmentFile.RECORD_MAGIC_BYTES[offset]) &#123;</span><br><span class="line">                <span class="keyword">return</span> value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// skip reserved</span></span><br><span class="line">        offset += <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex = Bits.getLong(value, offset); <span class="comment">//根据特定格式查找index</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pos = Bits.getInt(value, offset + <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">final</span> SegmentFile file = binarySearchFileByFirstLogIndex(firstLogIndex);<span class="comment">//二分法查找Segment文件</span></span><br><span class="line">        <span class="keyword">if</span> (file == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file.read(logIndex, pos);<span class="comment">//从Segment文件读取</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LogitLogStorage"><a href="#LogitLogStorage" class="headerlink" title="LogitLogStorage"></a>LogitLogStorage</h2><p>LogitLogStorage，是Java代码，实现的File文件存储。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A logStorage implemented by java</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogitLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger           LOG                    = LoggerFactory.getLogger(LogitLogStorage.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           INDEX_STORE_PATH       = <span class="string">&quot;LogIndex&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           SEGMENT_STORE_PATH     = <span class="string">&quot;LogSegment&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           CONF_STORE_PATH        = <span class="string">&quot;LogConf&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String           FIRST_INDEX_CHECKPOINT = <span class="string">&quot;FirstLogIndexCheckpoint&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FirstLogIndexCheckpoint firstLogIndexCheckpoint;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReadWriteLock           readWriteLock          = <span class="keyword">new</span> ReentrantReadWriteLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock                    readLock               = <span class="keyword">this</span>.readWriteLock.readLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Lock                    writeLock              = <span class="keyword">this</span>.readWriteLock.writeLock();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StoreOptions            storeOptions;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String                  indexStorePath; <span class="comment">//索引目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String                  segmentStorePath; <span class="comment">//segment文件目录</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String                  confStorePath;</span><br><span class="line">    <span class="keyword">private</span> String                        groupId;</span><br><span class="line">    <span class="keyword">private</span> ConfigurationManager          configurationManager;</span><br><span class="line">    <span class="keyword">private</span> LogEntryEncoder               logEntryEncoder;</span><br><span class="line">    <span class="keyword">private</span> LogEntryDecoder               logEntryDecoder;</span><br><span class="line">    <span class="keyword">private</span> SegmentLogDB                  segmentLogDB; <span class="comment">//Segment文件数据库，继承AbstractDB</span></span><br><span class="line">    <span class="keyword">private</span> IndexDB                       indexDB; <span class="comment">//索引文件数据库，继承AbstractDB</span></span><br><span class="line">    <span class="keyword">private</span> ConfDB                        confDB;</span><br><span class="line">    <span class="keyword">private</span> LogStoreFactory               logStoreFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件数据库，都继承AbstractDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.SegmentLogDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores logEntry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentLogDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SegmentLogDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(storePath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FileType <span class="title">getDBFileType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> FileType.FILE_SEGMENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDBFileSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.storeOptions.getSegmentFileSize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.IndexDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB that stores index entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexDB</span> <span class="keyword">extends</span> <span class="title">AbstractDB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IndexDB</span><span class="params">(<span class="keyword">final</span> String storePath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(storePath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.db.AbstractDB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DB parent class that invokes fileManager and anager</span></span><br><span class="line"><span class="comment"> * and wrappers uniform functions such as recover() etc..</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDB</span> <span class="keyword">implements</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStoreFactory</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger      LOG                     = LoggerFactory.getLogger(AbstractDB.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      FLUSH_STATUS_CHECKPOINT = <span class="string">&quot;FlushStatusCheckpoint&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String      ABORT_FILE              = <span class="string">&quot;Abort&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String           storePath;</span><br><span class="line">    <span class="keyword">protected</span> FileManager            fileManager; <span class="comment">//文件管理器</span></span><br><span class="line">    <span class="keyword">protected</span> ServiceManager         serviceManager;</span><br><span class="line">    <span class="keyword">protected</span> LogStoreFactory        logStoreFactory;</span><br><span class="line">    <span class="keyword">protected</span> StoreOptions           storeOptions;</span><br><span class="line">    <span class="keyword">protected</span> AbortFile              abortFile;</span><br><span class="line">    <span class="keyword">protected</span> FlushStatusCheckpoint  flushStatusCheckpoint;</span><br><span class="line">    <span class="keyword">private</span> ScheduledExecutorService checkpointExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-2"><a href="#getEntry读取方法-2" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; getFirstLogIndex() || index &gt; getLastLogIndex()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> IndexEntry indexEntry = <span class="keyword">this</span>.indexDB.lookupIndex(index);<span class="comment">//先查索引</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> phyPosition = indexEntry.getPosition();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span> logType = indexEntry.getLogType();</span><br><span class="line">        <span class="keyword">if</span> (phyPosition != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] logBytes;</span><br><span class="line">            <span class="keyword">if</span> (logType == IndexType.IndexSegment.getType()) &#123;</span><br><span class="line">                logBytes = <span class="keyword">this</span>.segmentLogDB.lookupLog(index, phyPosition);<span class="comment">//再从Segment数据库读取</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                logBytes = <span class="keyword">this</span>.confDB.lookupLog(index, phyPosition);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (logBytes != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.logEntryDecoder.decode(logBytes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-2"><a href="#appendEntry写入方法-2" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.LogitLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] logData = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">        <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">            <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.confDB, IndexType.IndexConf, <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> doAppendEntry(logIndex, logData, <span class="keyword">this</span>.segmentLogDB, IndexType.IndexSegment, <span class="keyword">true</span>);<span class="comment">//具体逻辑</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">doAppendEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> logIndex, <span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> AbstractDB logDB,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  <span class="keyword">final</span> IndexType indexType, <span class="keyword">final</span> <span class="keyword">boolean</span> isWaitingFlush)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logDB == <span class="keyword">null</span> || <span class="keyword">this</span>.indexDB == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Append log async , get position infos</span></span><br><span class="line">            <span class="keyword">final</span> Pair&lt;Integer, Long&gt; logPair = logDB.appendLogAsync(logIndex, data); </span><br><span class="line">            <span class="keyword">if</span> (logPair.getFirst() &lt; <span class="number">0</span> || logPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Pair&lt;Integer, Long&gt; indexPair = <span class="keyword">this</span>.indexDB</span><br><span class="line">                .appendIndexAsync(logIndex, logPair.getFirst(), indexType); <span class="comment">//写入索引文件数据库</span></span><br><span class="line">            <span class="keyword">if</span> (indexPair.getFirst() &lt; <span class="number">0</span> || indexPair.getSecond() &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Save first log index</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.firstLogIndexCheckpoint.isInit()) &#123;</span><br><span class="line">                saveFirstLogIndex(logIndex); </span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (isWaitingFlush) &#123;</span><br><span class="line">                <span class="keyword">return</span> waitForFlush(logDB, logPair.getSecond(), indexPair.getSecond());<span class="comment">//写入Segment文件数据库</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">waitForFlush</span><span class="params">(<span class="keyword">final</span> AbstractDB logDB, <span class="keyword">final</span> <span class="keyword">long</span> exceptedLogPosition,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">final</span> <span class="keyword">long</span> exceptedIndexPosition)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> maxFlushTimes = <span class="keyword">this</span>.storeOptions.getMaxFlushTimes();</span><br><span class="line">        <span class="comment">// We should flush log db first, because even If the power fails after flushing the log db</span></span><br><span class="line">        <span class="comment">// we can restore the index db based on the log db.</span></span><br><span class="line">        <span class="keyword">if</span> (!logDB.waitForFlush(exceptedLogPosition, maxFlushTimes)) &#123; <span class="comment">//写入Segment文件数据库</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.indexDB.waitForFlush(exceptedIndexPosition, maxFlushTimes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="HybridLogStorage"><a href="#HybridLogStorage" class="headerlink" title="HybridLogStorage"></a>HybridLogStorage</h2><p>HybridLogStorage是混合日志存储，有新旧两种实现，可以扩展LogStorage的能力，比如更换LogStorage的具体实现。</p>
<blockquote>
<p>HybridLogStorage is used to be compatible with new and old logStorage</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridLogStorage</span> <span class="keyword">implements</span> <span class="title">LogStorage</span> </span>&#123;</span><br><span class="line">		<span class="comment">//日志检查点</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String                 STATUS_CHECKPOINT_PATH = <span class="string">&quot;HybridStatusCheckpoint&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HybridStorageStatusCheckpoint statusCheckpoint;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span>                    isOldStorageExist; <span class="comment">//判断是否存在旧LogStorage</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    oldLogStorage; <span class="comment">//旧LogStorage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogStorage                    newLogStorage; <span class="comment">//新LogStorage</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// The index which separates the oldStorage and newStorage</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                                thresholdIndex; <span class="comment">//使用新旧LogStorage的分隔Log Index，即阀值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getEntry读取方法-3"><a href="#getEntry读取方法-3" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= <span class="keyword">this</span>.thresholdIndex) &#123; <span class="comment">//大于阀值，从newLogStorage读取</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.getEntry(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isOldStorageExist()) &#123; <span class="comment">//小于阀值，且存在oldLogStorage，从oldLogStorage读取</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.oldLogStorage.getEntry(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="appendEntry写入方法-3"><a href="#appendEntry写入方法-3" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.newLogStorage.appendEntry(entry); <span class="comment">//写入，都写入newLogStorage</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何确定thresholdIndex"><a href="#如何确定thresholdIndex" class="headerlink" title="如何确定thresholdIndex"></a>如何确定thresholdIndex</h3><p>使用old或者new LogStorage的关键，是thresholdIndex，如何确定thresholdIndex？在init方法，检查点HybridStorageStatusCheckpoint statusCheckpoint，确认存在oldLogStorage，oldLogStorage的lastLogIndex+1，即为thresholdIndex</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(<span class="keyword">final</span> LogStorageOptions opts)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.statusCheckpoint.load(); <span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line">            <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">this</span>.statusCheckpoint.isOldStorageExist;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.isOldStorageExist) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.oldLogStorage != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!<span class="keyword">this</span>.oldLogStorage.init(opts)) &#123;</span><br><span class="line">                        LOG.warn(<span class="string">&quot;Init old log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">final</span> <span class="keyword">long</span> lastLogIndex = <span class="keyword">this</span>.oldLogStorage.getLastLogIndex();</span><br><span class="line">                    <span class="keyword">if</span> (lastLogIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                        shutdownOldLogStorage();</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastLogIndex &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// Still exists logs in oldLogStorage, need to wait snapshot</span></span><br><span class="line">                        <span class="keyword">this</span>.thresholdIndex = lastLogIndex + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line">                        LOG.info(</span><br><span class="line">                            <span class="string">&quot;Still exists logs in oldLogStorage, lastIndex: &#123;&#125;,  need to wait snapshot to truncate logs&quot;</span>,</span><br><span class="line">                            lastLogIndex);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.isOldStorageExist = <span class="keyword">false</span>;</span><br><span class="line">                    saveStatusCheckpoint();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.newLogStorage.init(opts)) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;Init new log storage failed when startup hybridLogStorage&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Error happen when when load hybrid status checkpoint&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//日志检查点 Checkpoint#load方法</span></span><br><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.file.assit.Checkpoint</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Checkpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        <span class="keyword">this</span>.path = path;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encode metadata</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>[] encode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decode file data</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">save</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path);</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] data = <span class="keyword">this</span>.encode();</span><br><span class="line">        <span class="keyword">final</span> LocalFileMeta meta = LocalFileMeta.newBuilder() </span><br><span class="line">            .setUserMeta(ZeroByteStringHelper.wrap(data)) </span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">return</span> file.save(meta, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ProtoBufFile file = <span class="keyword">new</span> ProtoBufFile(<span class="keyword">this</span>.path); <span class="comment">//文件存储</span></span><br><span class="line">        <span class="keyword">final</span> LocalFileMeta meta = file.load();</span><br><span class="line">        <span class="keyword">if</span> (meta != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] data = meta.getUserMeta().toByteArray();</span><br><span class="line">            decode(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// HybridStorageStatusCheckpoint#decode</span></span><br><span class="line"><span class="comment">// com.alipay.sofa.jraft.storage.file.assit.HybridStorageStatusCheckpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HybridStorageStatusCheckpoint</span> <span class="keyword">extends</span> <span class="title">Checkpoint</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">boolean</span> isOldStorageExist = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HybridStorageStatusCheckpoint</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] encode() &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] bs = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">short</span> val = (<span class="keyword">short</span>) (<span class="keyword">this</span>.isOldStorageExist ? <span class="number">1</span> : <span class="number">0</span>); <span class="comment">//是否存在oldLogStorage的标志位</span></span><br><span class="line">        Bits.putShort(bs, <span class="number">0</span>, val);</span><br><span class="line">        <span class="keyword">return</span> bs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">decode</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span>[] bs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bs.length &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">short</span> val = Bits.getShort(bs, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">this</span>.isOldStorageExist = val == <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="HybridLogStorage的局限性"><a href="#HybridLogStorage的局限性" class="headerlink" title="HybridLogStorage的局限性"></a>HybridLogStorage的局限性</h3><p>HybridLogStorage看着很美好，但是目前HybridLogStorage有其局限性，构造函数里面，限制了newLogStorage的实现，只能是Java实现的LogitLogStorage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//com.alipay.sofa.jraft.storage.HybridLogStorage</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HybridLogStorage</span><span class="params">(<span class="keyword">final</span> String path, <span class="keyword">final</span> StoreOptions storeOptions, <span class="keyword">final</span> LogStorage oldStorage)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> String newLogStoragePath = Paths.get(path, storeOptions.getStoragePath()).toString();</span><br><span class="line">   <span class="keyword">this</span>.newLogStorage = <span class="keyword">new</span> LogitLogStorage(newLogStoragePath, storeOptions);<span class="comment">//没办法修改newLogStorage的实现</span></span><br><span class="line">   <span class="keyword">this</span>.oldLogStorage = oldStorage;</span><br><span class="line">   <span class="keyword">final</span> String statusCheckpointPath = Paths.get(path, STATUS_CHECKPOINT_PATH).toString();</span><br><span class="line">   <span class="keyword">this</span>.statusCheckpoint = <span class="keyword">new</span> HybridStorageStatusCheckpoint(statusCheckpointPath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/02/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90%EF%BC%88%E4%BA%8C%EF%BC%89/" class="post-title-link" itemprop="url">SOFAJRaft日志存储分析（二）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-02 17:08:23" itemprop="dateCreated datePublished" datetime="2022-08-02T17:08:23+08:00">2022-08-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-03 11:45:21" itemprop="dateModified" datetime="2023-07-03T11:45:21+08:00">2023-07-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="LogStorage分析"><a href="#LogStorage分析" class="headerlink" title="LogStorage分析"></a>LogStorage分析</h1><p>LogStorage 是日志存储实现，默认实现基于 RocksDB 存储，通过 LogStorage 接口扩展自定义日志存储实现。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.LogStorage </span><br></pre></td></tr></table></figure>

<p>LogStorage 日志存储实现，核心 API 接口包括：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LogStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line">		<span class="comment">//返回日志里的首/末个日志索引；</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getFirstLogIndex</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getLastLogIndex</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//按照日志索引获取 Log Entry 及其任期；</span></span><br><span class="line">    <span class="function">LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getTerm</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//把单个/批量 Log Entry 添加到日志存储；</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span></span>;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">//从 Log 存储头部/末尾删除日志；</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">truncatePrefix</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstIndexKept)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">truncateSuffix</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> lastIndexKept)</span></span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//删除所有现有日志，重置下任日志索引。</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">reset</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> nextLogIndex)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中LogStorage，有五个实现，Rocks的两个实现是默认实现，其余三个是jraft-extension包提供的额外实现。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034208.jpg" alt="e6c9d24egy1h4sn708bdaj218o0b6ad6"></p>
<p>而，具体使用哪种实现，是通过SPI的方式，以BDBLogStorage为例。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034221.jpg" alt="e6c9d24egy1h4sncopqjbj21xi0sijwa"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SPI(priority = 1)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BDBLogStorageJRaftServiceFactory</span> <span class="keyword">extends</span> <span class="title">DefaultJRaftServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LogStorage <span class="title">createLogStorage</span><span class="params">(String uri, RaftOptions raftOptions)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BDBLogStorage(uri, raftOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RocksDBLogStorage"><a href="#RocksDBLogStorage" class="headerlink" title="RocksDBLogStorage"></a>RocksDBLogStorage</h1><p>RocksDBLogStorage是LogStorage的默认实现，DefaultJRaftServiceFactory返回的是RocksDBLogStorage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJRaftServiceFactory</span> <span class="keyword">implements</span> <span class="title">JRaftServiceFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LogStorage <span class="title">createLogStorage</span><span class="params">(<span class="keyword">final</span> String uri, <span class="keyword">final</span> RaftOptions raftOptions)</span> </span>&#123;</span><br><span class="line">        Requires.requireTrue(StringUtils.isNotBlank(uri), <span class="string">&quot;Blank log storage uri.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RocksDBLogStorage(uri, raftOptions);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RocksDBLogStorage主要属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String                    path; <span class="comment">//DB存储数据路径</span></span><br><span class="line"><span class="keyword">private</span> RocksDB                         db; <span class="comment">//实际存储RocksDB</span></span><br><span class="line"><span class="keyword">private</span> ColumnFamilyHandle              defaultHandle; <span class="comment">//ColumnFamilyHandle 完成RocksDB的读写</span></span><br><span class="line"><span class="keyword">private</span> ColumnFamilyHandle              confHandle; <span class="comment">//ColumnFamily是K/V的逻辑分区</span></span><br></pre></td></tr></table></figure>

<h2 id="getEntry读取方法"><a href="#getEntry读取方法" class="headerlink" title="getEntry读取方法"></a>getEntry读取方法</h2><p>getEntry读取方法，最终是调用RocksDB的get方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.hasLoadFirstLogIndex &amp;&amp; index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">              <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span> getEntryFromDB(index); <span class="comment">//从DB读取</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">          LOG.error(<span class="string">&quot;Fail to get log entry at index &#123;&#125; in data path: &#123;&#125;.&quot;</span>, index, <span class="keyword">this</span>.path, e);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@OnlyForTest</span></span><br><span class="line">  <span class="function">LogEntry <span class="title">getEntryFromDB</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> <span class="keyword">throws</span> IOException, RocksDBException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes = getKeyBytes(index); <span class="comment">// Key，Value都是字节流</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">byte</span>[] bs = onDataGet(index, getValueFromRocksDB(keyBytes));</span><br><span class="line">    <span class="keyword">if</span> (bs != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logEntryDecoder.decode(bs);</span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> entry;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Bad log entry format for index=&#123;&#125;, the log data is: &#123;&#125;.&quot;</span>, index, BytesUtil.toHex(bs));</span><br><span class="line">            <span class="comment">// invalid data remove? TODO</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] getValueFromRocksDB(<span class="keyword">final</span> <span class="keyword">byte</span>[] keyBytes) <span class="keyword">throws</span> RocksDBException &#123;</span><br><span class="line">      checkState();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.db.get(<span class="keyword">this</span>.defaultHandle, keyBytes); </span><br><span class="line">      <span class="comment">//调用 org.rocksdb.RocksDB#get(org.rocksdb.ColumnFamilyHandle, byte[])</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="appendEntry写入方法"><a href="#appendEntry写入方法" class="headerlink" title="appendEntry写入方法"></a>appendEntry写入方法</h2><p>appendEntry写入方法，最终是调用RocksDB的put方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">        <span class="keyword">return</span> executeBatch(batch -&gt; addConfBatch(entry, batch));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.db == <span class="keyword">null</span>) &#123;</span><br><span class="line">                LOG.warn(<span class="string">&quot;DB not initialized or destroyed in data path: &#123;&#125;.&quot;</span>, <span class="keyword">this</span>.path);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">final</span> WriteContext writeCtx = newWriteContext();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> logIndex = entry.getId().getIndex();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] valueBytes = <span class="keyword">this</span>.logEntryEncoder.encode(entry);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] newValueBytes = onDataAppend(logIndex, valueBytes, writeCtx);</span><br><span class="line">            writeCtx.startJob();</span><br><span class="line">            <span class="keyword">this</span>.db.put(<span class="keyword">this</span>.defaultHandle, <span class="keyword">this</span>.writeOptions, getKeyBytes(logIndex), newValueBytes);</span><br><span class="line">            <span class="comment">//调用 org.rocksdb.RocksDB#put(org.rocksdb.ColumnFamilyHandle, org.rocksdb.WriteOptions, byte[], byte[])</span></span><br><span class="line">            writeCtx.joinAll();</span><br><span class="line">            <span class="keyword">if</span> (newValueBytes != valueBytes) &#123;</span><br><span class="line">                doSync();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> RocksDBException | IOException e) &#123;</span><br><span class="line">            LOG.error(<span class="string">&quot;Fail to append entry.&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="RocksDB"><a href="#RocksDB" class="headerlink" title="RocksDB"></a>RocksDB</h1><p>RocksDBLogStorage底层是依托于<a target="_blank" rel="noopener" href="http://rocksdb.org/">rocksdb</a>，<a target="_blank" rel="noopener" href="https://github.com/facebook/rocksdb">github-rocksdb</a>完成存储。</p>
<blockquote>
<p>RocksDB is an <strong>embeddable</strong>  <strong>persistent</strong> <strong>key-value</strong> store for fast storage.</p>
</blockquote>
<blockquote>
<p>The RocksDB library provides a persistent key value store. <strong>Keys and values are arbitrary byte arrays</strong>. The keys are ordered within the key value store according to a user-specified comparator function.</p>
</blockquote>
<blockquote>
<p>This code is a library that forms the core building block for a fast key-value server, especially suited for storing data on flash drives. <strong>It has a Log-Structured-Merge-Database (LSM) design with flexible tradeoffs between Write-Amplification-Factor (WAF), Read-Amplification-Factor (RAF) and Space-Amplification-Factor (SAF).</strong> It has multi-threaded compactions, making it especially suitable for storing multiple terabytes of data in a single database.</p>
</blockquote>
<p>翻译一下，RocksDB 是基于 LSM-Tree 数据结构使用 C++ 编写的嵌入式 KV 存储引擎，其键值均允许使用二进制流。</p>
<p>RocksDB被广泛用于其他开源中间件。其中，Pulsar 使用 BookKeeper 作为存储层，BookKeeper 底层使用到了 RocksDB 来保存 Entry (BookKeeper 中的数据存储单元) 对应的位置索引。主流开源的 pika/kvrocks，以及云厂商的持久型 KV 存储服务，底层都是基于 RocksDB。还有大名鼎鼎的 TiDB，其存储引擎也是 RocksDB。</p>
<h1 id="LSM"><a href="#LSM" class="headerlink" title="LSM"></a>LSM</h1><h2 id="LSM定义"><a href="#LSM定义" class="headerlink" title="LSM定义"></a>LSM定义</h2><p>LSM的论文：<a target="_blank" rel="noopener" href="http://paperhub.s3.amazonaws.com/18e91eb4db2114a06ea614f0384f2784.pdf">The Log-Structured Merge-Tree (LSM Tree)</a> – O’Neil et al. ’96.</p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree">维基LSM定义</a>，其中，比较有意思的描述：</p>
<blockquote>
<p>In <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Computer_science">computer science</a>, the <strong>log-structured merge-tree</strong> (also known as <strong>LSM tree</strong>, or <strong>LSMT</strong>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-1">1]</a>) is a <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_structure">data structure</a> with performance characteristics that make it attractive for providing <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Database_index">indexed</a> access to files with high insert volume, such as <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Transaction_log">transactional log data</a>. LSM trees, like other <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Search_tree">search trees</a>, maintain key-value pairs. LSM trees maintain data in two or more separate structures, each of which is optimized for its respective underlying storage medium; data is synchronized between the two structures efficiently, in batches.</p>
<p>One simple version of the LSM tree is a two-level LSM tree.[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-2">2]</a> As described by <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Patrick_O'Neil">Patrick O’Neil</a>, a two-level LSM tree comprises two <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Tree_(data_structure)">tree-like</a> structures, called C0 and C1. C0 is smaller and entirely resident in memory, whereas C1 is resident on disk. New records are inserted into the memory-resident C0 component. If the insertion causes the C0 component to exceed a certain size threshold, a contiguous segment of entries is removed from C0 and merged into C1 on disk. The performance characteristics of LSM trees stem from the fact that each component is tuned to the characteristics of its underlying storage medium, and that data is efficiently migrated across media in rolling batches, using an algorithm reminiscent of <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Merge_sort">merge sort</a>.</p>
<p>In order to keep down the cost of queries, the system must avoid a situation where there are too many runs.</p>
<p>LSM trees are used in data stores such as <a target="_blank" rel="noopener" href="https://asterixdb.apache.org/">Apache AsterixDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bigtable">Bigtable</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/HBase">HBase</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/LevelDB">LevelDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apache_Accumulo">Apache Accumulo</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/SQLite4">SQLite4</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-6">6]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Tarantool">Tarantool</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-7">7]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/RocksDB">RocksDB</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/WiredTiger">WiredTiger</a>,[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-8">8]</a> <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Apache_Cassandra">Apache Cassandra</a>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/InfluxDB">InfluxDB</a>[<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree#cite_note-9">9]</a> and <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Scylla_(database)">ScyllaDB</a>.</p>
</blockquote>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034241.jpg" alt="e6c9d24egy1h4spclmcqdj212r0jgtaf"></p>
<p>LSM 树是一个复杂的算法设计，源自 Google 的 Bigtable 论文 （引入了术语 SSTable 和 memtable ）。基于 LSM 树算法设计实现的存储引擎，称之为 LSM 存储引擎。在 LevelDB、RocksDB、Cassandra、HBase 都基于 LSM 树算法实现了对应的存储引擎。</p>
<h2 id="LSM原理"><a href="#LSM原理" class="headerlink" title="LSM原理"></a>LSM原理</h2><h3 id="如何理解LSM？"><a href="#如何理解LSM？" class="headerlink" title="如何理解LSM？"></a>如何理解LSM？</h3><p>LSM解决的是高写负载的场景，通过顺序写入（sequential writes）优化数据写入。LSM tree持久化使用的是**Sorted Strings Table (SSTable)*<em>的数据结构。SSTables中key/value队，都是有序的，以key排序。其中key/value对，是以</em>segments*组织的。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034302.jpg" alt="e6c9d24egy1h4uj0jm861j20zu0jktbd"></p>
<h3 id="数据写入"><a href="#数据写入" class="headerlink" title="数据写入"></a>数据写入</h3><p>LSM 是顺序写入。当数据写入时，首先写入内存中的树结构（memtable），其底层数据结构通常是某种形式的排序树，如<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Red%E2%80%93black_tree">红黑树</a>。写入时，数据将添加到此红黑树中。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034316.jpg" alt="e6c9d24egy1h4uj73qdyej20cq0f4dgv"></p>
<p>当内存中的红黑树达到预定义的大小，它将会一段segment按排序顺序刷到（flush）磁盘。通过数据结构的排序性，内存和硬盘两个层次，保证了顺序写入特性，即无论以任何顺序插入，最后刷新到硬盘都是有序的。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034342.jpg" alt="e6c9d24egy1h4ujcwusetj21le0q2aez"></p>
<h3 id="数据读取"><a href="#数据读取" class="headerlink" title="数据读取"></a>数据读取</h3><p>如何在SSTable中找到一个值呢？一种简单的方法是扫描扫描segments分段，即从最新的部分开始，然后回到最老的部分，直到找到要寻找的目标。但是这种简答的方法是低效的，另外的简单的优化是保持内存中的稀疏索引（sparse index）。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034353.jpg" alt="e6c9d24egy1h4ujhloeguj211y0cg0uy"></p>
<p>使用稀疏索引快速查找所需Key前后的值的偏移量。例如，查找key <code>dollar</code>。稀疏索引执行二进制搜索，key <code>dollar</code>介于 <code>dog</code> and <code>downgrade</code>之间。现在，只需要从偏移量17208扫描到19504，就可以找到该值（或确定该值缺失）。</p>
<p>稀疏索引，可以很好提高查询效率，但是如何查找不存在的记录呢？因为以上的算法，只是针对某个分段。为了确定不存在，仍然会在所有段文件上循环查找。这是<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bloom_filter">布隆过滤器bloom-filter</a>可以帮助解决问题。布隆过滤器是一种节省空间的数据结构，可以检查数据中是否存在值。在写入bloom过滤器时向其添加条目，并在读取开始时进行检查，以便有效地检查数据是否存在。</p>
<p>数据压缩</p>
<p>随着时间的推移，分段文件会积累。分段文件需要定期清理和维护，以防止分段文件数量失控。其过程称为压缩的过程。压缩是一个后台过程，不断地将旧分段组合到新分段的过程。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034413.jpg" alt="e6c9d24egy1h4uju3q33oj21d40oen28"></p>
<p>上图的示例中，segment1和segment2都有key <code>dog</code>的值。新分段segment4包含写入的最新值（84），即segment2的值转入segment4。很容易理解，根据时序性，新值覆盖原则。</p>
<h3 id="数据删除"><a href="#数据删除" class="headerlink" title="数据删除"></a>数据删除</h3><p>分段文件被视为不可变（immutable），如何从SSTable中删除数据？删除数据实际上遵循与写入数据完全相同的逻辑。删除数据时，会写入一个Key/Value键值对，但是Value是称为墓碑（<strong>tombstone</strong>）的特殊标记。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034429.jpg" alt="e6c9d24egy1h4uk1pj2rkj20y00cggng"></p>
<p>如上图所示，key <code>dog</code>在segment1的有value52，segment2有墓碑标记的key。这表明，当查询key <code>dog</code>时，会返回不存在的响应。这意味着删除操作实际上会占用磁盘空间，最终，压缩后，<code>dog</code>键值对才不存在于磁盘上。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><p>数据写入存储在内存树（memtable）中。优化措施，还将更新其他数据结构（bloom过滤器和稀疏索引）。</p>
</li>
<li><p>当内存树（memtable）变得太大时，数据将按排序顺序刷新到磁盘。内存和硬盘使用相同的数据结构（SSTable）。</p>
</li>
<li><p>查询优化，当读取数据时，首先检查bloom过滤器。如果bloom过滤器指示不存在，直接返回不存在。如果bloom过滤器指示该值存在，则从分段文件中查找。</p>
</li>
<li><p>对片段文件，通过稀疏索引提高效率。</p>
</li>
<li><p>数据删除，是延迟删除，通过写入带有特殊标记的Key/Value键值对来实现，真正删除，是发生在压缩时。</p>
</li>
</ul>
<h1 id="RocksDB中的LSM"><a href="#RocksDB中的LSM" class="headerlink" title="RocksDB中的LSM"></a>RocksDB中的LSM</h1><p>首先引用下，官网的顶层设计架构图，图中的一些概念，和LSM的概念是吻合的。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034438.jpg" alt="e6c9d24egy1h4v59lb4gij219j0u042b"></p>
<p>接下来，简单分析下读取数据Get的源码。</p>
<p>首先rocksdb封装了SuperVersion的结构体，包含当前版本号、内存中的 MemTable 和 Immutable MemTable、SST 文件信息等。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// column_family.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// holds references to memtable, all immutable memtables and version</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SuperVersion</span> &#123;</span></span><br><span class="line">  <span class="comment">// Accessing members of this class is not thread-safe and requires external</span></span><br><span class="line">  <span class="comment">// synchronization (ie db mutex held or on write thread).</span></span><br><span class="line">  ColumnFamilyData* cfd;</span><br><span class="line">  MemTable* mem; <span class="comment">//内存中的 MemTable</span></span><br><span class="line">  MemTableListVersion* imm; <span class="comment">//内存中的 Immutable MemTable，是集合</span></span><br><span class="line">  Version* current; <span class="comment">//SST文件，硬盘IO</span></span><br><span class="line">  MutableCFOptions mutable_cf_options;</span><br><span class="line">  <span class="comment">// Version number of the current SuperVersion</span></span><br><span class="line">  <span class="keyword">uint64_t</span> version_number; <span class="comment">//版本号</span></span><br><span class="line">  WriteStallCondition write_stall_condition;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Rocksdb 的 Get 接口 DBImpl::Get 其实现主要靠 DBImpl::GetImpl 函数调用。</p>
<p>DBImpl::GetImpl</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// db_impl.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">DBImpl::GetImpl</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                       GetImplOptions&amp; get_impl_options)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">assert</span>(get_impl_options.value != <span class="literal">nullptr</span> ||</span><br><span class="line">         get_impl_options.merge_operands != <span class="literal">nullptr</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">assert</span>(get_impl_options.column_family);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (read_options.timestamp) &#123;</span><br><span class="line">    <span class="keyword">const</span> Status s = <span class="built_in">FailIfTsMismatchCf</span>(get_impl_options.column_family,</span><br><span class="line">                                        *(read_options.timestamp),</span><br><span class="line">                                        <span class="comment">/*ts_for_read=*/</span><span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> Status s = <span class="built_in">FailIfCfHasTs</span>(get_impl_options.column_family);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Acquire SuperVersion</span></span><br><span class="line">  SuperVersion* sv = <span class="built_in">GetAndRefSuperVersion</span>(cfd);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//略</span></span><br><span class="line">  <span class="keyword">if</span> (!skip_memtable) &#123;</span><br><span class="line">    <span class="comment">// Get value associated with key</span></span><br><span class="line">    <span class="keyword">if</span> (get_impl_options.get_value) &#123;</span><br><span class="line">      <span class="comment">// ① 从内存的MemTable读取</span></span><br><span class="line">      <span class="keyword">if</span> (sv-&gt;mem-&gt;<span class="built_in">Get</span>(lkey, get_impl_options.value-&gt;<span class="built_in">GetSelf</span>(), timestamp, &amp;s,</span><br><span class="line">                       &amp;merge_context, &amp;max_covering_tombstone_seq,</span><br><span class="line">                       read_options, get_impl_options.callback,</span><br><span class="line">                       get_impl_options.is_blob_index)) &#123;</span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        get_impl_options.value-&gt;<span class="built_in">PinSelf</span>();</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((s.<span class="built_in">ok</span>() || s.<span class="built_in">IsMergeInProgress</span>()) &amp;&amp;</span><br><span class="line">                 sv-&gt;imm-&gt;<span class="built_in">Get</span>(lkey, get_impl_options.value-&gt;<span class="built_in">GetSelf</span>(),</span><br><span class="line">                              timestamp, &amp;s, &amp;merge_context,</span><br><span class="line">                              &amp;max_covering_tombstone_seq, read_options,</span><br><span class="line">                              get_impl_options.callback,</span><br><span class="line">                              get_impl_options.is_blob_index)) &#123; <span class="comment">// ② 从 内存中的 Immutable MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        get_impl_options.value-&gt;<span class="built_in">PinSelf</span>();</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Get Merge Operands associated with key, Merge Operands should not be</span></span><br><span class="line">      <span class="comment">// merged and raw values should be returned to the user.</span></span><br><span class="line">      <span class="keyword">if</span> (sv-&gt;mem-&gt;<span class="built_in">Get</span>(lkey, <span class="comment">/*value*/</span> <span class="literal">nullptr</span>, <span class="comment">/*timestamp=*/</span><span class="literal">nullptr</span>, &amp;s,</span><br><span class="line">                       &amp;merge_context, &amp;max_covering_tombstone_seq,</span><br><span class="line">                       read_options, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>, <span class="literal">false</span>)) &#123;  <span class="comment">// ① 从内存的MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((s.<span class="built_in">ok</span>() || s.<span class="built_in">IsMergeInProgress</span>()) &amp;&amp;</span><br><span class="line">                 sv-&gt;imm-&gt;<span class="built_in">GetMergeOperands</span>(lkey, &amp;s, &amp;merge_context,</span><br><span class="line">                                           &amp;max_covering_tombstone_seq,</span><br><span class="line">                                           read_options)) &#123; <span class="comment">// ② 从 内存中的 Immutable MemTable读取</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">RecordTick</span>(stats_, MEMTABLE_HIT);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!done &amp;&amp; !s.<span class="built_in">ok</span>() &amp;&amp; !s.<span class="built_in">IsMergeInProgress</span>()) &#123;</span><br><span class="line">      <span class="built_in">ReturnAndCleanupSuperVersion</span>(cfd, sv);</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;DBImpl::GetImpl:PostMemTableGet:0&quot;</span>);</span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;DBImpl::GetImpl:PostMemTableGet:1&quot;</span>);</span><br><span class="line">  PinnedIteratorsManager pinned_iters_mgr;</span><br><span class="line">  <span class="keyword">if</span> (!done) &#123; <span class="comment">//均没读取数据</span></span><br><span class="line">    <span class="built_in">PERF_TIMER_GUARD</span>(get_from_output_files_time);</span><br><span class="line">    <span class="comment">// ③ 从SST文件读取</span></span><br><span class="line">    sv-&gt;current-&gt;<span class="built_in">Get</span>(</span><br><span class="line">        read_options, lkey, get_impl_options.value, timestamp, &amp;s,</span><br><span class="line">        &amp;merge_context, &amp;max_covering_tombstone_seq, &amp;pinned_iters_mgr,</span><br><span class="line">        get_impl_options.get_value ? get_impl_options.value_found : <span class="literal">nullptr</span>,</span><br><span class="line">        <span class="literal">nullptr</span>, <span class="literal">nullptr</span>,</span><br><span class="line">        get_impl_options.get_value ? get_impl_options.callback : <span class="literal">nullptr</span>,</span><br><span class="line">        get_impl_options.get_value ? get_impl_options.is_blob_index : <span class="literal">nullptr</span>,</span><br><span class="line">        get_impl_options.get_value);</span><br><span class="line">    <span class="built_in">RecordTick</span>(stats_, MEMTABLE_MISS);</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">//略</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>读取顺序：MemTable -&gt; MemTableListVersion -&gt; Version</p>
<p>MemTable::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memtable.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTable::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                   std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                   MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                   SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                   SequenceNumber* seq, <span class="keyword">const</span> ReadOptions&amp; read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                   ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index, <span class="keyword">bool</span> do_merge)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// The sequence number is updated synchronously in version_set.h</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">IsEmpty</span>()) &#123;</span><br><span class="line">    <span class="comment">// Avoiding recording stats for speed.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">PERF_TIMER_GUARD</span>(get_from_memtable_time);</span><br><span class="line"></span><br><span class="line">  <span class="function">std::unique_ptr&lt;FragmentedRangeTombstoneIterator&gt; <span class="title">range_del_iter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      NewRangeTombstoneIterator(read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                                GetInternalKeySeqno(key.internal_key())))</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (range_del_iter != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    *max_covering_tombstone_seq =</span><br><span class="line">        std::<span class="built_in">max</span>(*max_covering_tombstone_seq,</span><br><span class="line">                 range_del_iter-&gt;<span class="built_in">MaxCoveringTombstoneSeqnum</span>(key.<span class="built_in">user_key</span>()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">bool</span> found_final_value = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">bool</span> merge_in_progress = s-&gt;<span class="built_in">IsMergeInProgress</span>();</span><br><span class="line">  <span class="keyword">bool</span> may_contain = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">size_t</span> ts_sz = <span class="built_in">GetInternalKeyComparator</span>().<span class="built_in">user_comparator</span>()-&gt;<span class="built_in">timestamp_size</span>();</span><br><span class="line">  Slice user_key_without_ts = <span class="built_in">StripTimestampFromUserKey</span>(key.<span class="built_in">user_key</span>(), ts_sz);</span><br><span class="line">  <span class="keyword">bool</span> bloom_checked = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (bloom_filter_) &#123; <span class="comment">//布隆过滤器</span></span><br><span class="line">    <span class="comment">// when both memtable_whole_key_filtering and prefix_extractor_ are set,</span></span><br><span class="line">    <span class="comment">// only do whole key filtering for Get() to save CPU</span></span><br><span class="line">    <span class="keyword">if</span> (moptions_.memtable_whole_key_filtering) &#123;</span><br><span class="line">      may_contain = bloom_filter_-&gt;<span class="built_in">MayContain</span>(user_key_without_ts);</span><br><span class="line">      bloom_checked = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">assert</span>(prefix_extractor_);</span><br><span class="line">      <span class="keyword">if</span> (prefix_extractor_-&gt;<span class="built_in">InDomain</span>(user_key_without_ts)) &#123;</span><br><span class="line">        may_contain = bloom_filter_-&gt;<span class="built_in">MayContain</span>(</span><br><span class="line">            prefix_extractor_-&gt;<span class="built_in">Transform</span>(user_key_without_ts));</span><br><span class="line">        bloom_checked = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (bloom_filter_ &amp;&amp; !may_contain) &#123;</span><br><span class="line">    <span class="comment">// iter is null if prefix bloom says the key does not exist</span></span><br><span class="line">    <span class="built_in">PERF_COUNTER_ADD</span>(bloom_memtable_miss_count, <span class="number">1</span>);</span><br><span class="line">    *seq = kMaxSequenceNumber;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (bloom_checked) &#123;</span><br><span class="line">      <span class="built_in">PERF_COUNTER_ADD</span>(bloom_memtable_hit_count, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">GetFromTable</span>(key, *max_covering_tombstone_seq, do_merge, callback,</span><br><span class="line">                 is_blob_index, value, timestamp, s, merge_context, seq,</span><br><span class="line">                 &amp;found_final_value, &amp;merge_in_progress); <span class="comment">//真正查找</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// No change to value, since we have not yet found a Put/Delete</span></span><br><span class="line">  <span class="keyword">if</span> (!found_final_value &amp;&amp; merge_in_progress) &#123;</span><br><span class="line">    *s = Status::<span class="built_in">MergeInProgress</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">PERF_COUNTER_ADD</span>(get_from_memtable_count, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> found_final_value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MemTable::GetFromTable</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                            SequenceNumber max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span> do_merge, ReadCallback* callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span>* is_blob_index, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                            std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                            MergeContext* merge_context, SequenceNumber* seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span>* found_final_value, <span class="keyword">bool</span>* merge_in_progress)</span> </span>&#123;</span><br><span class="line">  Saver saver;</span><br><span class="line">  saver.status = s;</span><br><span class="line">  saver.found_final_value = found_final_value;</span><br><span class="line">  saver.merge_in_progress = merge_in_progress;</span><br><span class="line">  saver.key = &amp;key;</span><br><span class="line">  saver.value = value;</span><br><span class="line">  saver.timestamp = timestamp;</span><br><span class="line">  saver.seq = kMaxSequenceNumber;</span><br><span class="line">  saver.mem = <span class="keyword">this</span>;</span><br><span class="line">  saver.merge_context = merge_context;</span><br><span class="line">  saver.max_covering_tombstone_seq = max_covering_tombstone_seq;</span><br><span class="line">  saver.merge_operator = moptions_.merge_operator;</span><br><span class="line">  saver.logger = moptions_.info_log;</span><br><span class="line">  saver.inplace_update_support = moptions_.inplace_update_support;</span><br><span class="line">  saver.statistics = moptions_.statistics;</span><br><span class="line">  saver.clock = clock_;</span><br><span class="line">  saver.callback_ = callback;</span><br><span class="line">  saver.is_blob_index = is_blob_index;</span><br><span class="line">  saver.do_merge = do_merge;</span><br><span class="line">  saver.allow_data_in_errors = moptions_.allow_data_in_errors;</span><br><span class="line">  table_-&gt;<span class="built_in">Get</span>(key, &amp;saver, SaveValue); <span class="comment">//查找方法</span></span><br><span class="line">  *seq = saver.seq;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MemTableRep::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; k, <span class="keyword">void</span>* callback_args,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="keyword">bool</span> (*callback_func)(<span class="keyword">void</span>* arg, <span class="keyword">const</span> <span class="keyword">char</span>* entry))</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> iter = <span class="built_in">GetDynamicPrefixIterator</span>(); <span class="comment">//使用skiplist跳表查找</span></span><br><span class="line">  <span class="keyword">for</span> (iter-&gt;<span class="built_in">Seek</span>(k.<span class="built_in">internal_key</span>(), k.<span class="built_in">memtable_key</span>().<span class="built_in">data</span>());</span><br><span class="line">       iter-&gt;<span class="built_in">Valid</span>() &amp;&amp; <span class="built_in">callback_func</span>(callback_args, iter-&gt;<span class="built_in">key</span>());</span><br><span class="line">       iter-&gt;<span class="built_in">Next</span>()) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// skiplistrep.cc </span></span><br><span class="line">  <span class="function">MemTableRep::Iterator* <span class="title">GetIterator</span><span class="params">(Arena* arena = <span class="literal">nullptr</span>)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (lookahead_ &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">void</span> *mem =</span><br><span class="line">        arena ? arena-&gt;<span class="built_in">AllocateAligned</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::LookaheadIterator))</span><br><span class="line">              : <span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::LookaheadIterator));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in"><span class="keyword">new</span></span> (mem) SkipListRep::<span class="built_in">LookaheadIterator</span>(*<span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">void</span> *mem =</span><br><span class="line">        arena ? arena-&gt;<span class="built_in">AllocateAligned</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::Iterator))</span><br><span class="line">              : <span class="keyword">operator</span> <span class="built_in"><span class="keyword">new</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(SkipListRep::Iterator));</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in"><span class="keyword">new</span></span> (mem) SkipListRep::<span class="built_in">Iterator</span>(&amp;skip_list_);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>MemTableListVersion::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// memtable_list.cc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Search all the memtables starting from the most recent one.</span></span><br><span class="line"><span class="comment">// Return the most recent value found, if any.</span></span><br><span class="line"><span class="comment">// Operands stores the list of merge operations to apply, so far.</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTableListVersion::Get</span><span class="params">(<span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">                              std::string* timestamp, Status* s,</span></span></span><br><span class="line"><span class="params"><span class="function">                              MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                              SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                              SequenceNumber* seq, <span class="keyword">const</span> ReadOptions&amp; read_opts,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">GetFromList</span>(&amp;memlist_, key, value, timestamp, s, merge_context,</span><br><span class="line">                     max_covering_tombstone_seq, seq, read_opts, callback,</span><br><span class="line">                     is_blob_index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">MemTableListVersion::GetFromList</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    std::list&lt;MemTable*&gt;* list, <span class="keyword">const</span> LookupKey&amp; key, std::string* value,</span></span></span><br><span class="line"><span class="params"><span class="function">    std::string* timestamp, Status* s, MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">    SequenceNumber* max_covering_tombstone_seq, SequenceNumber* seq,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> ReadOptions&amp; read_opts, ReadCallback* callback, <span class="keyword">bool</span>* is_blob_index)</span> </span>&#123;</span><br><span class="line">  *seq = kMaxSequenceNumber;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span>&amp; memtable : *list) &#123;</span><br><span class="line">    SequenceNumber current_seq = kMaxSequenceNumber;</span><br><span class="line">    <span class="comment">//调用memtable的Get方法</span></span><br><span class="line">    <span class="keyword">bool</span> done = memtable-&gt;<span class="built_in">Get</span>(key, value, timestamp, s, merge_context,</span><br><span class="line">                              max_covering_tombstone_seq, &amp;current_seq,</span><br><span class="line">                              read_opts, callback, is_blob_index);</span><br><span class="line">    <span class="keyword">if</span> (*seq == kMaxSequenceNumber) &#123;</span><br><span class="line">      <span class="comment">// Store the most recent sequence number of any operation on this key.</span></span><br><span class="line">      <span class="comment">// Since we only care about the most recent change, we only need to</span></span><br><span class="line">      <span class="comment">// return the first operation found when searching memtables in</span></span><br><span class="line">      <span class="comment">// reverse-chronological order.</span></span><br><span class="line">      <span class="comment">// current_seq would be equal to kMaxSequenceNumber if the value was to be</span></span><br><span class="line">      <span class="comment">// skipped. This allows seq to be assigned again when the next value is</span></span><br><span class="line">      <span class="comment">// read.</span></span><br><span class="line">      *seq = current_seq;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">      <span class="built_in">assert</span>(*seq != kMaxSequenceNumber || s-&gt;<span class="built_in">IsNotFound</span>());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!done &amp;&amp; !s-&gt;<span class="built_in">ok</span>() &amp;&amp; !s-&gt;<span class="built_in">IsMergeInProgress</span>() &amp;&amp; !s-&gt;<span class="built_in">IsNotFound</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MemTableListVersion 用链表的形式保存了所有 Immutable memtable 的结构，查找时，按时间序依次查找于每一个 memtable，如果任何一个 memtable 查找到结果则立即返回，即返回最新的返回值。具体 memtable 查找见上述 MemTable::Get 接口。</p>
<p>Version::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// version_set.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Version::Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> LookupKey&amp; k,</span></span></span><br><span class="line"><span class="params"><span class="function">                  PinnableSlice* value, std::string* timestamp, Status* status,</span></span></span><br><span class="line"><span class="params"><span class="function">                  MergeContext* merge_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                  SequenceNumber* max_covering_tombstone_seq,</span></span></span><br><span class="line"><span class="params"><span class="function">                  PinnedIteratorsManager* pinned_iters_mgr, <span class="keyword">bool</span>* value_found,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">bool</span>* key_exists, SequenceNumber* seq, ReadCallback* callback,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">bool</span>* is_blob, <span class="keyword">bool</span> do_merge)</span> </span>&#123;</span><br><span class="line"> <span class="comment">//略</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//fd文件描述符</span></span><br><span class="line">  <span class="function">FilePicker <span class="title">fp</span><span class="params">(user_key, ikey, &amp;storage_info_.level_files_brief_,</span></span></span><br><span class="line"><span class="params"><span class="function">                storage_info_.num_non_empty_levels_,</span></span></span><br><span class="line"><span class="params"><span class="function">                &amp;storage_info_.file_indexer_, user_comparator(),</span></span></span><br><span class="line"><span class="params"><span class="function">                internal_comparator())</span></span>;</span><br><span class="line">  FdWithKeyRange* f = fp.<span class="built_in">GetNextFile</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (f != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">   <span class="comment">//略</span></span><br><span class="line">    *status = table_cache_-&gt;<span class="built_in">Get</span>(</span><br><span class="line">        read_options, *<span class="built_in">internal_comparator</span>(), *f-&gt;file_metadata, ikey,</span><br><span class="line">        &amp;get_context, mutable_cf_options_.prefix_extractor,</span><br><span class="line">        cfd_-&gt;<span class="built_in">internal_stats</span>()-&gt;<span class="built_in">GetFileReadHist</span>(fp.<span class="built_in">GetHitFileLevel</span>()),</span><br><span class="line">        <span class="built_in">IsFilterSkipped</span>(<span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(fp.<span class="built_in">GetHitFileLevel</span>()),</span><br><span class="line">                        fp.<span class="built_in">IsHitFileLastInLevel</span>()),</span><br><span class="line">        fp.<span class="built_in">GetHitFileLevel</span>(), max_file_size_for_l0_meta_pin_);</span><br><span class="line">	<span class="comment">//略</span></span><br><span class="line">  f = fp.<span class="built_in">GetNextFile</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>GetNextFile 函数会遍历所有的 level，然后再遍历每个 level 的所有的文件，这里会对 level 0 的文件做一个特殊处理，这是因为只有 level 0 的 SST 的 range 不是有序的，因此我们每次查找需要查找所有的文件，也就是会一个个的遍历；而在非 level 0，我们只需要按照二分查找来得到对应的文件即可，如果二分查找不存在，那么我就需要进入下一个 level 进行查找。</p>
<p>调用 TableCache::Get 遍历单个 SST 文件，如果查找到结果立即返回。</p>
<p>TableCache::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// table_cache.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">TableCache::Get</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> ReadOptions&amp; options,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> InternalKeyComparator&amp; internal_comparator,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> FileMetaData&amp; file_meta, <span class="keyword">const</span> Slice&amp; k, GetContext* get_context,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> std::shared_ptr&lt;<span class="keyword">const</span> SliceTransform&gt;&amp; prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">    HistogramImpl* file_read_hist, <span class="keyword">bool</span> skip_filters, <span class="keyword">int</span> level,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">size_t</span> max_file_size_for_l0_meta_pin)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span>&amp; fd = file_meta.fd;</span><br><span class="line">  std::string* row_cache_entry = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">bool</span> done = <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ROCKSDB_LITE</span></span><br><span class="line">  IterKey row_cache_key;</span><br><span class="line">  std::string row_cache_entry_buffer;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Check row cache if enabled. Since row cache does not currently store</span></span><br><span class="line">  <span class="comment">// sequence numbers, we cannot use it if we need to fetch the sequence.</span></span><br><span class="line">  <span class="keyword">if</span> (ioptions_.row_cache &amp;&amp; !get_context-&gt;<span class="built_in">NeedToReadSequence</span>()) &#123;</span><br><span class="line">    <span class="keyword">auto</span> user_key = <span class="built_in">ExtractUserKey</span>(k);</span><br><span class="line">    <span class="built_in">CreateRowCacheKeyPrefix</span>(options, fd, k, get_context, row_cache_key);</span><br><span class="line">    done = <span class="built_in">GetFromRowCache</span>(user_key, row_cache_key, row_cache_key.<span class="built_in">Size</span>(),</span><br><span class="line">                           get_context);</span><br><span class="line">    <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">      row_cache_entry = &amp;row_cache_entry_buffer;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// ROCKSDB_LITE</span></span></span><br><span class="line">  Status s;</span><br><span class="line">  TableReader* t = fd.table_reader;</span><br><span class="line">  Cache::Handle* handle = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">    <span class="built_in">assert</span>(s.<span class="built_in">ok</span>());</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="comment">//先从缓存中读取</span></span><br><span class="line">      s = <span class="built_in">FindTable</span>(options, file_options_, internal_comparator, fd, &amp;handle,</span><br><span class="line">                    prefix_extractor,</span><br><span class="line">                    options.read_tier == kBlockCacheTier <span class="comment">/* no_io */</span>,</span><br><span class="line">                    <span class="literal">true</span> <span class="comment">/* record_read_stats */</span>, file_read_hist, skip_filters,</span><br><span class="line">                    level, <span class="literal">true</span> <span class="comment">/* prefetch_index_and_filter_in_cache */</span>,</span><br><span class="line">                    max_file_size_for_l0_meta_pin, file_meta.temperature);</span><br><span class="line">      <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        t = <span class="built_in">GetTableReaderFromHandle</span>(handle);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    SequenceNumber* max_covering_tombstone_seq =</span><br><span class="line">        get_context-&gt;<span class="built_in">max_covering_tombstone_seq</span>();</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>() &amp;&amp; max_covering_tombstone_seq != <span class="literal">nullptr</span> &amp;&amp;</span><br><span class="line">        !options.ignore_range_deletions) &#123;</span><br><span class="line">      <span class="function">std::unique_ptr&lt;FragmentedRangeTombstoneIterator&gt; <span class="title">range_del_iter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">          t-&gt;NewRangeTombstoneIterator(options))</span></span>;</span><br><span class="line">      <span class="keyword">if</span> (range_del_iter != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        *max_covering_tombstone_seq = std::<span class="built_in">max</span>(</span><br><span class="line">            *max_covering_tombstone_seq,</span><br><span class="line">            range_del_iter-&gt;<span class="built_in">MaxCoveringTombstoneSeqnum</span>(<span class="built_in">ExtractUserKey</span>(k)));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      get_context-&gt;<span class="built_in">SetReplayLog</span>(row_cache_entry);  <span class="comment">// nullptr if no cache.</span></span><br><span class="line">      s = t-&gt;<span class="built_in">Get</span>(options, k, get_context, prefix_extractor.<span class="built_in">get</span>(), skip_filters); <span class="comment">//从BlockBasedTable读取，即单个sst文件</span></span><br><span class="line">      get_context-&gt;<span class="built_in">SetReplayLog</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options.read_tier == kBlockCacheTier &amp;&amp; s.<span class="built_in">IsIncomplete</span>()) &#123;</span><br><span class="line">      <span class="comment">// Couldn&#x27;t find Table in cache but treat as kFound if no_io set</span></span><br><span class="line">      get_context-&gt;<span class="built_in">MarkKeyMayExist</span>();</span><br><span class="line">      s = Status::<span class="built_in">OK</span>();</span><br><span class="line">      done = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ROCKSDB_LITE</span></span><br><span class="line">  <span class="comment">// Put the replay log in row cache only if something was found.</span></span><br><span class="line">  <span class="keyword">if</span> (!done &amp;&amp; s.<span class="built_in">ok</span>() &amp;&amp; row_cache_entry &amp;&amp; !row_cache_entry-&gt;<span class="built_in">empty</span>()) &#123;</span><br><span class="line">    <span class="keyword">size_t</span> charge = row_cache_entry-&gt;<span class="built_in">capacity</span>() + <span class="built_in"><span class="keyword">sizeof</span></span>(std::string);</span><br><span class="line">    <span class="keyword">void</span>* row_ptr = <span class="keyword">new</span> std::<span class="built_in">string</span>(std::<span class="built_in">move</span>(*row_cache_entry));</span><br><span class="line">    <span class="comment">// If row cache is full, it&#x27;s OK to continue.</span></span><br><span class="line">    ioptions_.row_cache</span><br><span class="line">        -&gt;<span class="built_in">Insert</span>(row_cache_key.<span class="built_in">GetUserKey</span>(), row_ptr, charge,</span><br><span class="line">                 &amp;DeleteEntry&lt;std::string&gt;)</span><br><span class="line">        .<span class="built_in">PermitUncheckedError</span>();</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// ROCKSDB_LITE</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (handle != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="built_in">ReleaseHandle</span>(handle);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">TableCache::FindTable</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> ReadOptions&amp; ro, <span class="keyword">const</span> FileOptions&amp; file_options,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> InternalKeyComparator&amp; internal_comparator, <span class="keyword">const</span> FileDescriptor&amp; fd,</span></span></span><br><span class="line"><span class="params"><span class="function">    Cache::Handle** handle,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> std::shared_ptr&lt;<span class="keyword">const</span> SliceTransform&gt;&amp; prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">bool</span> no_io, <span class="keyword">bool</span> record_read_stats, HistogramImpl* file_read_hist,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">bool</span> skip_filters, <span class="keyword">int</span> level, <span class="keyword">bool</span> prefetch_index_and_filter_in_cache,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">size_t</span> max_file_size_for_l0_meta_pin, Temperature file_temperature)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">PERF_TIMER_GUARD_WITH_CLOCK</span>(find_table_nanos, ioptions_.clock);</span><br><span class="line">  <span class="keyword">uint64_t</span> number = fd.<span class="built_in">GetNumber</span>();</span><br><span class="line">  Slice key = <span class="built_in">GetSliceForFileNumber</span>(&amp;number);</span><br><span class="line">  *handle = cache_-&gt;<span class="built_in">Lookup</span>(key); <span class="comment">//从缓存中读取</span></span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT_CALLBACK</span>(<span class="string">&quot;TableCache::FindTable:0&quot;</span>,</span><br><span class="line">                           <span class="keyword">const_cast</span>&lt;<span class="keyword">bool</span>*&gt;(&amp;no_io));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (*handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (no_io) &#123;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">Incomplete</span>(<span class="string">&quot;Table not found in table_cache, no_io is set&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">MutexLock <span class="title">load_lock</span><span class="params">(loader_mutex_.get(key))</span></span>;</span><br><span class="line">    <span class="comment">// We check the cache again under loading mutex</span></span><br><span class="line">    *handle = cache_-&gt;<span class="built_in">Lookup</span>(key);</span><br><span class="line">    <span class="keyword">if</span> (*handle != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    std::unique_ptr&lt;TableReader&gt; table_reader;</span><br><span class="line">    <span class="comment">//真实读取，从磁盘读取</span></span><br><span class="line">    Status s = <span class="built_in">GetTableReader</span>(</span><br><span class="line">        ro, file_options, internal_comparator, fd, <span class="literal">false</span> <span class="comment">/* sequential mode */</span>,</span><br><span class="line">        record_read_stats, file_read_hist, &amp;table_reader, prefix_extractor,</span><br><span class="line">        skip_filters, level, prefetch_index_and_filter_in_cache,</span><br><span class="line">        max_file_size_for_l0_meta_pin, file_temperature);</span><br><span class="line">    <span class="keyword">if</span> (!s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">      <span class="built_in">assert</span>(table_reader == <span class="literal">nullptr</span>);</span><br><span class="line">      <span class="built_in">RecordTick</span>(ioptions_.stats, NO_FILE_ERRORS);</span><br><span class="line">      <span class="comment">// We do not cache error results so that if the error is transient,</span></span><br><span class="line">      <span class="comment">// or somebody repairs the file, we recover automatically.</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//插入缓存</span></span><br><span class="line">      s = cache_-&gt;<span class="built_in">Insert</span>(key, table_reader.<span class="built_in">get</span>(), <span class="number">1</span>, &amp;DeleteEntry&lt;TableReader&gt;,</span><br><span class="line">                         handle);</span><br><span class="line">      <span class="keyword">if</span> (s.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        <span class="comment">// Release ownership of table reader.</span></span><br><span class="line">        table_reader.<span class="built_in">release</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockBasedTable::Get</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// block_based_table_reader.cc</span></span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">BlockBasedTable::Get</span><span class="params">(<span class="keyword">const</span> ReadOptions&amp; read_options, <span class="keyword">const</span> Slice&amp; key,</span></span></span><br><span class="line"><span class="params"><span class="function">                            GetContext* get_context,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">const</span> SliceTransform* prefix_extractor,</span></span></span><br><span class="line"><span class="params"><span class="function">                            <span class="keyword">bool</span> skip_filters)</span> </span>&#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">bool</span> may_match = <span class="built_in">FullFilterKeyMayMatch</span>(</span><br><span class="line">      filter, key, no_io, prefix_extractor, get_context, &amp;lookup_context,</span><br><span class="line">      read_options.rate_limiter_priority); <span class="comment">//数据块Index，稀疏索引查找</span></span><br><span class="line">  <span class="built_in">TEST_SYNC_POINT</span>(<span class="string">&quot;BlockBasedTable::Get:AfterFilterMatch&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!may_match) &#123;</span><br><span class="line">    <span class="built_in">RecordTick</span>(rep_-&gt;ioptions.stats, BLOOM_FILTER_USEFUL);</span><br><span class="line">    <span class="built_in">PERF_COUNTER_BY_LEVEL_ADD</span>(bloom_filter_useful, <span class="number">1</span>, rep_-&gt;level); </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">//命中</span></span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">		<span class="comment">//遍历，循环查找</span></span><br><span class="line">    <span class="keyword">for</span> (iiter-&gt;<span class="built_in">Seek</span>(key); iiter-&gt;<span class="built_in">Valid</span>() &amp;&amp; !done; iiter-&gt;<span class="built_in">Next</span>()) &#123;</span><br><span class="line">      IndexValue v = iiter-&gt;<span class="built_in">value</span>();</span><br><span class="line">			<span class="comment">//略</span></span><br><span class="line">      NewDataBlockIterator&lt;DataBlockIter&gt;(</span><br><span class="line">          read_options, v.handle, &amp;biter, BlockType::kData, get_context,</span><br><span class="line">          &amp;lookup_data_block_context, <span class="comment">/*prefetch_buffer=*/</span><span class="literal">nullptr</span>,</span><br><span class="line">          <span class="comment">/*for_compaction=*/</span><span class="literal">false</span>, <span class="comment">/*async_read=*/</span><span class="literal">false</span>, tmp_status);</span><br><span class="line">			<span class="comment">//no_io，命中内存</span></span><br><span class="line">      <span class="keyword">if</span> (no_io &amp;&amp; biter.<span class="built_in">status</span>().<span class="built_in">IsIncomplete</span>()) &#123;</span><br><span class="line">        <span class="comment">// couldn&#x27;t get block from block_cache</span></span><br><span class="line">        <span class="comment">// Update Saver.state to Found because we are only looking for</span></span><br><span class="line">        <span class="comment">// whether we can guarantee the key is not there when &quot;no_io&quot; is set</span></span><br><span class="line">        get_context-&gt;<span class="built_in">MarkKeyMayExist</span>();</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!biter.<span class="built_in">status</span>().<span class="built_in">ok</span>()) &#123;</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">bool</span> may_exist = biter.<span class="built_in">SeekForGet</span>(key);</span><br><span class="line">      <span class="comment">// If user-specified timestamp is supported, we cannot end the search</span></span><br><span class="line">      <span class="comment">// just because hash index lookup indicates the key+ts does not exist.</span></span><br><span class="line">      <span class="keyword">if</span> (!may_exist &amp;&amp; ts_sz == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// HashSeek cannot find the key this block and the the iter is not</span></span><br><span class="line">        <span class="comment">// the end of the block, i.e. cannot be in the following blocks</span></span><br><span class="line">        <span class="comment">// either. In this case, the seek_key cannot be found, so we break</span></span><br><span class="line">        <span class="comment">// from the top level for-loop.</span></span><br><span class="line">        done = <span class="literal">true</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Call the *saver function on each entry/block until it returns false</span></span><br><span class="line">        <span class="keyword">for</span> (; biter.<span class="built_in">Valid</span>(); biter.<span class="built_in">Next</span>()) &#123;</span><br><span class="line">          ParsedInternalKey parsed_key;</span><br><span class="line">          Status pik_status = <span class="built_in">ParseInternalKey</span>(</span><br><span class="line">              biter.<span class="built_in">key</span>(), &amp;parsed_key, <span class="literal">false</span> <span class="comment">/* log_err_key */</span>);  <span class="comment">// TODO</span></span><br><span class="line">          <span class="keyword">if</span> (!pik_status.<span class="built_in">ok</span>()) &#123;</span><br><span class="line">            s = pik_status;</span><br><span class="line">          &#125;</span><br><span class="line">					<span class="comment">//从硬盘的SST文件读取</span></span><br><span class="line">          <span class="keyword">if</span> (!get_context-&gt;<span class="built_in">SaveValue</span>(</span><br><span class="line">                  parsed_key, biter.<span class="built_in">value</span>(), &amp;matched,</span><br><span class="line">                  biter.<span class="built_in">IsValuePinned</span>() ? &amp;biter : <span class="literal">nullptr</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (get_context-&gt;<span class="built_in">State</span>() == GetContext::GetState::kFound) &#123;</span><br><span class="line">              does_referenced_key_exist = <span class="literal">true</span>;</span><br><span class="line">              referenced_data_size = biter.<span class="built_in">key</span>().<span class="built_in">size</span>() + biter.<span class="built_in">value</span>().<span class="built_in">size</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            done = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        s = biter.<span class="built_in">status</span>();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//略</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BlockBasedTable是 RocksDB中默认的 SST table的格式。 </p>
<p><strong>File format</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;beginning_of_file&gt;</span><br><span class="line">[data block 1]</span><br><span class="line">[data block 2]</span><br><span class="line">...</span><br><span class="line">[data block N]</span><br><span class="line">[meta block 1: filter block]                  (see section: &quot;filter&quot; Meta Block)</span><br><span class="line">[meta block 2: index block]</span><br><span class="line">[meta block 3: compression dictionary block]  (see section: &quot;compression dictionary&quot; Meta Block)</span><br><span class="line">[meta block 4: range deletion block]          (see section: &quot;range deletion&quot; Meta Block)</span><br><span class="line">[meta block 5: stats block]                   (see section: &quot;properties&quot; Meta Block)</span><br><span class="line">...</span><br><span class="line">[meta block K: future extended block]  (we may add more meta blocks in the future)</span><br><span class="line">[metaindex block]</span><br><span class="line">[Footer]                               (fixed size; starts at file_size - sizeof(Footer))</span><br><span class="line">&lt;end_of_file&gt;</span><br></pre></td></tr></table></figure>

<p>总结</p>
<p>Rocksdb 的Get 读取数据会不可避免的带来读放大（Read Amplification)。Rocksdb 的读操作需要从新到旧（从上到下）一层一层查找，直到找到想要的数据。这个过程可能需要不止一次 I/O。从level0 开始，潜在的可能会造成I/O，对于level1及以下的层级，最差情况每一层都定位到一个sst 文件，进行一次潜在I/O。这样会造成大量的读放大。所幸，引进了bloom filter减少了可能的读盘次数。另外，引入缓存优化措施，Rocksdb在各个阶段，实现了不同的缓存。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-034514.jpg" alt="e6c9d24egy1h4v74kceuxj20t40xzmze"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://www.sofastack.tech/blog/sofa-jraft-algorithm-storage-module-deep-dive/">https://www.sofastack.tech/blog/sofa-jraft-algorithm-storage-module-deep-dive/</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/426053729">https://zhuanlan.zhihu.com/p/426053729</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/">https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/</a></p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Log-structured_merge-tree">https://en.wikipedia.org/wiki/Log-structured_merge-tree</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/">https://blog.acolyer.org/2014/11/26/the-log-structured-merge-tree-lsm-tree/</a></p>
<p><a target="_blank" rel="noopener" href="https://yetanotherdevblog.com/lsm/">https://yetanotherdevblog.com/lsm/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.iggiewang.cn/2021/01/17/Rocksdb-Get/">https://www.iggiewang.cn/2021/01/17/Rocksdb-Get/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/28/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90(%E4%B8%80)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/28/SOFAJRaft%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90(%E4%B8%80)/" class="post-title-link" itemprop="url">SOFAJRaft日志存储分析（一）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-28 23:45:15" itemprop="dateCreated datePublished" datetime="2022-07-28T23:45:15+08:00">2022-07-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-07-03 14:23:59" itemprop="dateModified" datetime="2023-07-03T14:23:59+08:00">2023-07-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E5%88%86%E6%9E%90/" itemprop="url" rel="index"><span itemprop="name">日志存储分析</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上篇<a target="_blank" rel="noopener" href="https://barryzhanhao.github.io/2022/07/21/Raft%E5%8D%8F%E8%AE%AE%E5%92%8CSOFAJRaft%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">Raft协议和SOFAJRaft选举机制分析</a>，提到Raft协议是基于日志复制，而日志存储，SOFAJRaft是如何实现？其中又做了哪些优化的？</p>
<p>#日志存储在SOFAJRaft的实现</p>
<p>在<a target="_blank" rel="noopener" href="https://www.sofastack.tech/projects/sofa-jraft/engine-architecture/">官方顶层设计</a>中提到，关于日志存储，主要是LogStorage和LogManager。</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-062131.jpg" alt="e6c9d24egy1h4n5kqgmhpj20y00u0jut"></p>
<blockquote>
<ol>
<li>Log 存储，记录 raft 配置变更和用户提交任务的日志，将从 Leader 复制到其他节点上。LogStorage 是存储实现， LogManager 负责对底层存储的调用，对调用做缓存、批量提交、必要的检查和优化。</li>
</ol>
</blockquote>
<h2 id="核心实现类"><a href="#核心实现类" class="headerlink" title="核心实现类"></a>核心实现类</h2><p>日志存储，核心实现类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.storage.LogStorage #接口，真正的底层存储</span><br><span class="line">com.alipay.sofa.jraft.storage.LogManager #接口，日志调用封装</span><br><span class="line">com.alipay.sofa.jraft.entity.LogEntry #日志封装</span><br><span class="line">com.alipay.sofa.jraft.entity.LogId #日志</span><br></pre></td></tr></table></figure>

<p>LogId包含term和index，两个属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogId</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">LogId</span>&gt;, <span class="title">Copiable</span>&lt;<span class="title">LogId</span>&gt;, <span class="title">Serializable</span>, <span class="title">Checksum</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>              index; <span class="comment">// 单调的LogIndex</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>              term; <span class="comment">// 单调的任期</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogEntry包含除了LogId基础信息以外，封装了一些Peers信息，还有就是重要的checksum校验和，保证日志的不可更改。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEntry</span> <span class="keyword">implements</span> <span class="title">Checksum</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** entry type */</span></span><br><span class="line">    <span class="keyword">private</span> EnumOutter.EntryType   type;</span><br><span class="line">    <span class="comment">/** log id with index/term */</span></span><br><span class="line">    <span class="keyword">private</span> LogId                  id         = <span class="keyword">new</span> LogId(<span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 基础信息LOGID</span></span><br><span class="line">    <span class="comment">/** log entry current peers */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PeerId&gt;           peers;</span><br><span class="line">    <span class="comment">/** log entry old peers */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PeerId&gt;           oldPeers;</span><br><span class="line">    <span class="comment">/** log entry current learners */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PeerId&gt;           learners;</span><br><span class="line">    <span class="comment">/** log entry old learners */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;PeerId&gt;           oldLearners;</span><br><span class="line">    <span class="comment">/** entry data */</span></span><br><span class="line">    <span class="keyword">private</span> ByteBuffer             data       = EMPTY_DATA;</span><br><span class="line">    <span class="comment">/** checksum for log entry*/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span>                   checksum; <span class="comment">//校验和</span></span><br><span class="line">    <span class="comment">/** true when the log has checksum **/</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span>                hasChecksum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogStorage是底层存储，主要完成日志真正的读写。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LogStorage</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogStorageOptions</span>&gt;, <span class="title">Storage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get logEntry by index.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Append entries to log.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">appendEntry</span><span class="params">(<span class="keyword">final</span> LogEntry entry)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Append entries to log, return append success number.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>LogManager 负责对底层存储的调用，对调用做缓存、批量提交、必要的检查和优化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LogManager</span> <span class="keyword">extends</span> <span class="title">Lifecycle</span>&lt;<span class="title">LogManagerOptions</span>&gt;, <span class="title">Describer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Append log entry vector and wait until it&#x27;s stable (NOT COMMITTED!)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entries log entries</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> done    callback</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries, StableClosure done)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the log entry at index.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index the index of log entry</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the log entry with &#123;<span class="doctag">@code</span> index&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="LogManager分析"><a href="#LogManager分析" class="headerlink" title="LogManager分析"></a>LogManager分析</h2><blockquote>
<p>LogManager 负责对底层存储的调用，对调用做缓存、批量提交、必要的检查和优化</p>
</blockquote>
<p>LogManager，核心的属性，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogManagerImpl</span> <span class="keyword">implements</span> <span class="title">LogManager</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> LogStorage                                       logStorage; <span class="comment">//存储</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SegmentList&lt;LogEntry&gt;                      logsInMemory  = <span class="keyword">new</span> SegmentList&lt;&gt;(<span class="keyword">true</span>); <span class="comment">//内存缓存</span></span><br><span class="line">    <span class="keyword">private</span> Disruptor&lt;StableClosureEvent&gt;                    disruptor; <span class="comment">//无锁队列</span></span><br><span class="line">    <span class="keyword">private</span> RingBuffer&lt;StableClosureEvent&gt;                   diskQueue; <span class="comment">//无锁队列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LogManager读取日志"><a href="#LogManager读取日志" class="headerlink" title="LogManager读取日志"></a>LogManager读取日志</h3><p><strong>缓存、必要校验</strong></p>
<p>读取方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> LogEntry <span class="title">getEntry</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="keyword">this</span>.lastLogIndex || index &lt; <span class="keyword">this</span>.firstLogIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> LogEntry entry = getEntryFromMemory(index); <span class="comment">//从内存缓存读取</span></span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> entry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> LogEntry entry = <span class="keyword">this</span>.logStorage.getEntry(index);</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) &#123;</span><br><span class="line">        reportError(RaftError.EIO.getNumber(), <span class="string">&quot;Corrupted entry at index=%d, not found&quot;</span>, index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Validate checksum</span></span><br><span class="line">  	<span class="comment">// 检查日志完整性，其中checksum，是在日志写入的时候，存储了的</span></span><br><span class="line">    <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.raftOptions.isEnableLogEntryChecksum() &amp;&amp; entry.isCorrupted()) &#123;</span><br><span class="line">        String msg = String.format(<span class="string">&quot;Corrupted entry at index=%d, term=%d, expectedChecksum=%d, realChecksum=%d&quot;</span>,</span><br><span class="line">            index, entry.getId().getTerm(), entry.getChecksum(), entry.checksum());</span><br><span class="line">        <span class="comment">// Report error to node and throw exception.</span></span><br><span class="line">        reportError(RaftError.EIO.getNumber(), msg);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LogEntryCorruptedException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>checksum是使用的crc算法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">checksum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">long</span> c = checksum(<span class="keyword">this</span>.type.getNumber(), <span class="keyword">this</span>.id.checksum());</span><br><span class="line">      c = checksum(<span class="keyword">this</span>.peers, c);</span><br><span class="line">      c = checksum(<span class="keyword">this</span>.oldPeers, c);</span><br><span class="line">      c = checksum(<span class="keyword">this</span>.learners, c);</span><br><span class="line">      c = checksum(<span class="keyword">this</span>.oldLearners, c);</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.data != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.data.hasRemaining()) &#123;</span><br><span class="line">          c = checksum(c, CrcUtil.crc64(<span class="keyword">this</span>.data));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>其中，使用了SegmentList这个特殊的数据结构实现内存缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A list implementation based on segments. Only supports removing elements from start or end.</span></span><br><span class="line"><span class="comment"> * The list keep the elements in a segment list, every segment contains at most 128 elements.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *                [segment, segment, segment ...]</span></span><br><span class="line"><span class="comment"> *             /                 |                    \</span></span><br><span class="line"><span class="comment"> *         segment             segment              segment</span></span><br><span class="line"><span class="comment"> *      [0, 1 ... 127]    [128, 129 ... 255]    [256, 257 ... 383]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> boyan(boyan@antfin.com)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.1</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SegmentList</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>             SEGMENT_SHIFT = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>              SEGMENT_SIZE  = <span class="number">2</span> &lt;&lt; (SEGMENT_SHIFT - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ArrayDeque&lt;Segment&lt;T&gt;&gt; segments;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                          size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Cached offset in first segment.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span>                          firstOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span>                recycleSegment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因：</p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-062312.jpg" alt="e6c9d24egy1h4n5l08xj7j21bg0nedlw"></p>
<p>issues：<a target="_blank" rel="noopener" href="https://github.com/sofastack/sofa-jraft/pull/377">高频删除引起数据移动，内存碎片</a></p>
<p><img src="https://ipic-test.s3.us-east-005.backblazeb2.com/2023-07-03-062342.jpg" alt="e6c9d24egy1h4n5l6re89j210b0u078n"></p>
<h3 id="LogManager写入日志"><a href="#LogManager写入日志" class="headerlink" title="LogManager写入日志"></a>LogManager写入日志</h3><p><strong>批量、无锁化、异步</strong></p>
<p>写入方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">appendEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries, <span class="keyword">final</span> StableClosure done)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span>(done != <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    Requires.requireNonNull(done, <span class="string">&quot;done&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.hasError) &#123;</span><br><span class="line">        entries.clear();</span><br><span class="line">        ThreadPoolsFactory.runClosureInThread(<span class="keyword">this</span>.groupId, done, <span class="keyword">new</span> Status(RaftError.EIO, <span class="string">&quot;Corrupted LogStorage&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> doUnlock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">this</span>.writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//校验日志是否冲突</span></span><br><span class="line">        <span class="keyword">if</span> (!entries.isEmpty() &amp;&amp; !checkAndResolveConflict(entries, done, <span class="keyword">this</span>.writeLock)) &#123;</span><br><span class="line">            <span class="comment">// If checkAndResolveConflict returns false, the done will be called in it.</span></span><br><span class="line">            entries.clear();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entries.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">final</span> LogEntry entry = entries.get(i);</span><br><span class="line">            <span class="comment">// Set checksum after checkAndResolveConflict</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.raftOptions.isEnableLogEntryChecksum()) &#123;</span><br><span class="line">                entry.setChecksum(entry.checksum()); <span class="comment">//写入checksum</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (entry.getType() == EntryType.ENTRY_TYPE_CONFIGURATION) &#123;</span><br><span class="line">                Configuration oldConf = <span class="keyword">new</span> Configuration();</span><br><span class="line">                <span class="keyword">if</span> (entry.getOldPeers() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    oldConf = <span class="keyword">new</span> Configuration(entry.getOldPeers(), entry.getOldLearners());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">final</span> ConfigurationEntry conf = <span class="keyword">new</span> ConfigurationEntry(entry.getId(),</span><br><span class="line">                    <span class="keyword">new</span> Configuration(entry.getPeers(), entry.getLearners()), oldConf);</span><br><span class="line">                <span class="keyword">this</span>.configManager.add(conf);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!entries.isEmpty()) &#123;</span><br><span class="line">            done.setFirstLogIndex(entries.get(<span class="number">0</span>).getId().getIndex());</span><br><span class="line">            <span class="keyword">this</span>.logsInMemory.addAll(entries); <span class="comment">//写入缓存</span></span><br><span class="line">        &#125;</span><br><span class="line">        done.setEntries(entries);</span><br><span class="line"></span><br><span class="line">        doUnlock = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!wakeupAllWaiter(<span class="keyword">this</span>.writeLock)) &#123;</span><br><span class="line">            notifyLastLogIndexListeners(); <span class="comment">//通知钩子Listeners</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入无锁队列</span></span><br><span class="line">        <span class="comment">// publish event out of lock</span></span><br><span class="line">        <span class="keyword">this</span>.diskQueue.publishEvent((event, sequence) -&gt; &#123;</span><br><span class="line">          event.reset();</span><br><span class="line">          event.type = EventType.OTHER;</span><br><span class="line">          event.done = done;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (doUnlock) &#123;</span><br><span class="line">            <span class="keyword">this</span>.writeLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>什么时候，写入storge？什么时候，从disruptor的diskQueue消费数据？答案是：AppendBatcher类，批量写入功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">AppendBatcher &#123;</span><br><span class="line">        List&lt;StableClosure&gt; storage; <span class="comment">//异步回到</span></span><br><span class="line">        <span class="keyword">int</span>                 cap;</span><br><span class="line">        <span class="keyword">int</span>                 size;</span><br><span class="line">        <span class="keyword">int</span>                 bufferSize;</span><br><span class="line">        List&lt;LogEntry&gt;      toAppend; <span class="comment">//批量数据</span></span><br><span class="line">        LogId               lastId;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">AppendBatcher</span><span class="params">(<span class="keyword">final</span> List&lt;StableClosure&gt; storage, <span class="keyword">final</span> <span class="keyword">int</span> cap, <span class="keyword">final</span> List&lt;LogEntry&gt; toAppend,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">final</span> LogId lastId)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>();</span><br><span class="line">            <span class="keyword">this</span>.storage = storage;</span><br><span class="line">            <span class="keyword">this</span>.cap = cap;</span><br><span class="line">            <span class="keyword">this</span>.toAppend = toAppend;</span><br><span class="line">            <span class="keyword">this</span>.lastId = lastId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function">LogId <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.lastId = appendToStorage(<span class="keyword">this</span>.toAppend); <span class="comment">//真正调用Storage，写入</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.size; i++) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.storage.get(i).getEntries().clear();</span><br><span class="line">                    Status st = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (LogManagerImpl.<span class="keyword">this</span>.hasError) &#123;</span><br><span class="line">                            st = <span class="keyword">new</span> Status(RaftError.EIO, <span class="string">&quot;Corrupted LogStorage&quot;</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            st = Status.OK(); <span class="comment">//没有错误，状态OK</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">this</span>.storage.get(i).run(st); <span class="comment">//run 完成异步回调</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                        LOG.error(<span class="string">&quot;Fail to run closure with status: &#123;&#125;.&quot;</span>, st, t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.toAppend.clear();</span><br><span class="line">                <span class="keyword">this</span>.storage.clear();</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.size = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">this</span>.bufferSize = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.lastId;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">append</span><span class="params">(<span class="keyword">final</span> StableClosure done)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.size == <span class="keyword">this</span>.cap || <span class="keyword">this</span>.bufferSize &gt;= LogManagerImpl.<span class="keyword">this</span>.raftOptions.getMaxAppendBufferSize()) &#123;</span><br><span class="line">                flush();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.storage.add(done);</span><br><span class="line">            <span class="keyword">this</span>.size++;</span><br><span class="line">            <span class="keyword">this</span>.toAppend.addAll(done.getEntries());</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">final</span> LogEntry entry : done.getEntries()) &#123;</span><br><span class="line">                <span class="keyword">this</span>.bufferSize += entry.getData() != <span class="keyword">null</span> ? entry.getData().remaining() : <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//真正调用Storage，写入</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> LogId <span class="title">appendToStorage</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; toAppend)</span> </span>&#123;</span><br><span class="line">        LogId lastId = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.hasError) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> entriesCount = toAppend.size();</span><br><span class="line">            <span class="keyword">this</span>.nodeMetrics.recordSize(<span class="string">&quot;append-logs-count&quot;</span>, entriesCount);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">int</span> writtenSize = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; entriesCount; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> LogEntry entry = toAppend.get(i);</span><br><span class="line">                    writtenSize += entry.getData() != <span class="keyword">null</span> ? entry.getData().remaining() : <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">this</span>.nodeMetrics.recordSize(<span class="string">&quot;append-logs-bytes&quot;</span>, writtenSize);</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> nAppent = <span class="keyword">this</span>.logStorage.appendEntries(toAppend); <span class="comment">//写入</span></span><br><span class="line">                <span class="keyword">if</span> (nAppent != entriesCount) &#123;</span><br><span class="line">                    LOG.error(<span class="string">&quot;**Critical error**, fail to appendEntries, nAppent=&#123;&#125;, toAppend=&#123;&#125;&quot;</span>, nAppent,</span><br><span class="line">                        toAppend.size());</span><br><span class="line">                    reportError(RaftError.EIO.getNumber(), <span class="string">&quot;Fail to append log entries&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (nAppent &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    lastId = toAppend.get(nAppent - <span class="number">1</span>).getId();</span><br><span class="line">                &#125;</span><br><span class="line">                toAppend.clear();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;append-logs&quot;</span>, Utils.monotonicMs() - startMs);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lastId;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>AppendBatcher类是disruptor的EventHandler核心逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">StableClosureEventHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span>&lt;<span class="title">StableClosureEvent</span>&gt; </span>&#123;</span><br><span class="line">    LogId               lastId  = LogManagerImpl.<span class="keyword">this</span>.diskId;</span><br><span class="line">    List&lt;StableClosure&gt; storage = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">256</span>);</span><br><span class="line">    AppendBatcher       ab      = <span class="keyword">new</span> AppendBatcher(<span class="keyword">this</span>.storage, <span class="number">256</span>, <span class="keyword">new</span> ArrayList&lt;&gt;(),</span><br><span class="line">                                    LogManagerImpl.<span class="keyword">this</span>.diskId); <span class="comment">//批量操作</span></span><br><span class="line"></span><br><span class="line">  	<span class="comment">//消费disruptor的时间</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onEvent</span><span class="params">(<span class="keyword">final</span> StableClosureEvent event, <span class="keyword">final</span> <span class="keyword">long</span> sequence, <span class="keyword">final</span> <span class="keyword">boolean</span> endOfBatch)</span></span></span><br><span class="line"><span class="function">                                                                                                      <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (event.type == EventType.SHUTDOWN) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lastId = <span class="keyword">this</span>.ab.flush();</span><br><span class="line">            setDiskId(<span class="keyword">this</span>.lastId);</span><br><span class="line">            LogManagerImpl.<span class="keyword">this</span>.shutDownLatch.countDown();</span><br><span class="line">            event.reset();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> StableClosure done = event.done;</span><br><span class="line">        <span class="keyword">final</span> EventType eventType = event.type;</span><br><span class="line"></span><br><span class="line">        event.reset();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (done.getEntries() != <span class="keyword">null</span> &amp;&amp; !done.getEntries().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.ab.append(done); <span class="comment">//未触发条件，只是append追加</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.lastId = <span class="keyword">this</span>.ab.flush(); <span class="comment">//AppendBatcher批量提交</span></span><br><span class="line">            <span class="keyword">boolean</span> ret = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">                <span class="keyword">case</span> LAST_LOG_ID:</span><br><span class="line">                    ((LastLogIdClosure) done).setLastLogId(<span class="keyword">this</span>.lastId.copy());</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TRUNCATE_PREFIX:</span><br><span class="line">                    <span class="keyword">long</span> startMs = Utils.monotonicMs();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> TruncatePrefixClosure tpc = (TruncatePrefixClosure) done;</span><br><span class="line">                        LOG.debug(<span class="string">&quot;Truncating storage to firstIndexKept=&#123;&#125;.&quot;</span>, tpc.firstIndexKept);</span><br><span class="line">                        ret = LogManagerImpl.<span class="keyword">this</span>.logStorage.truncatePrefix(tpc.firstIndexKept);</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        LogManagerImpl.<span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;truncate-log-prefix&quot;</span>, Utils.monotonicMs()</span><br><span class="line">                                                                                             - startMs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> TRUNCATE_SUFFIX:</span><br><span class="line">                    startMs = Utils.monotonicMs();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">final</span> TruncateSuffixClosure tsc = (TruncateSuffixClosure) done;</span><br><span class="line">                        LOG.warn(<span class="string">&quot;Truncating storage to lastIndexKept=&#123;&#125;.&quot;</span>, tsc.lastIndexKept);</span><br><span class="line">                        ret = LogManagerImpl.<span class="keyword">this</span>.logStorage.truncateSuffix(tsc.lastIndexKept);</span><br><span class="line">                        <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.lastId.setIndex(tsc.lastIndexKept);</span><br><span class="line">                            <span class="keyword">this</span>.lastId.setTerm(tsc.lastTermKept);</span><br><span class="line">                            Requires.requireTrue(<span class="keyword">this</span>.lastId.getIndex() == <span class="number">0</span> || <span class="keyword">this</span>.lastId.getTerm() != <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        LogManagerImpl.<span class="keyword">this</span>.nodeMetrics.recordLatency(<span class="string">&quot;truncate-log-suffix&quot;</span>, Utils.monotonicMs()</span><br><span class="line">                                                                                             - startMs);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> RESET:</span><br><span class="line">                    <span class="keyword">final</span> ResetClosure rc = (ResetClosure) done;</span><br><span class="line">                    LOG.info(<span class="string">&quot;Resetting storage to nextLogIndex=&#123;&#125;.&quot;</span>, rc.nextLogIndex);</span><br><span class="line">                    ret = LogManagerImpl.<span class="keyword">this</span>.logStorage.reset(rc.nextLogIndex);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">                reportError(RaftError.EIO.getNumber(), <span class="string">&quot;Failed operation in LogStorage&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                done.run(Status.OK());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (endOfBatch) &#123;</span><br><span class="line">            <span class="keyword">this</span>.lastId = <span class="keyword">this</span>.ab.flush();</span><br><span class="line">            setDiskId(<span class="keyword">this</span>.lastId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步回调：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">StableClosure</span> <span class="keyword">implements</span> <span class="title">Closure</span> </span>&#123;</span><br><span class="line">		<span class="comment">//上下文信息</span></span><br><span class="line">      <span class="keyword">protected</span> <span class="keyword">long</span>           firstLogIndex = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">protected</span> List&lt;LogEntry&gt; entries;</span><br><span class="line">      <span class="keyword">protected</span> <span class="keyword">int</span>            nEntries;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">StableClosure</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="comment">// NO-OP</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getFirstLogIndex</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.firstLogIndex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirstLogIndex</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> firstLogIndex)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.firstLogIndex = firstLogIndex;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> List&lt;LogEntry&gt; <span class="title">getEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.entries;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEntries</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.entries = entries;</span><br><span class="line">          <span class="keyword">if</span> (entries != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">this</span>.nEntries = entries.size();</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="keyword">this</span>.nEntries = <span class="number">0</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">StableClosure</span><span class="params">(<span class="keyword">final</span> List&lt;LogEntry&gt; entries)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">super</span>();</span><br><span class="line">          setEntries(entries);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Closure</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Called when task is done.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> status the task status.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> Status status)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/21/Raft%E5%8D%8F%E8%AE%AE%E5%92%8CSOFAJRaft%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/21/Raft%E5%8D%8F%E8%AE%AE%E5%92%8CSOFAJRaft%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Raft协议和SOFAJRaft选举机制分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-21 19:05:52" itemprop="dateCreated datePublished" datetime="2022-07-21T19:05:52+08:00">2022-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-07-22 14:33:16" itemprop="dateModified" datetime="2022-07-22T14:33:16+08:00">2022-07-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%AE%97%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">算法</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Raft算法"><a href="#Raft算法" class="headerlink" title="Raft算法"></a>Raft算法</h1><h2 id="分布式共识"><a href="#分布式共识" class="headerlink" title="分布式共识"></a>分布式共识</h2><ul>
<li><strong>多个参与者</strong> 针对 <strong>某一件事</strong> 达成完全 <strong>一致</strong> ：一件事，一个结论。</li>
<li>已达成一致的结论，<strong>不可推翻</strong></li>
</ul>
<h2 id="分布式共识算法"><a href="#分布式共识算法" class="headerlink" title="分布式共识算法"></a>分布式共识算法</h2><ul>
<li>Paxos：被认为是分布式共识算法的根本，其他都是其变种，但是 Paxos 论文中只给出了单个提案的过程，并没有给出复制状态机中需要的 multi-paxos 的相关细节的描述，实现 Paxos 具有很高的工程复杂度（如多点可写，允许日志空洞等）。</li>
<li>Zab：被应用在 Zookeeper 中，业界使用广泛，但没有抽象成通用的 library。</li>
<li>Raft：以容易理解著称，业界也涌现出很多 Raft 实现，比如大名鼎鼎的 etcd, braft, tikv 等。</li>
</ul>
<h2 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h2><p>Raft是基于日志复制的分布式一致性共识算法 (Consensus Algorithm)，<a target="_blank" rel="noopener" href="https://raft.github.io/raft.pdf">论文地址:In Search of an Understandable Consensus Algorithm</a>。</p>
<p><a target="_blank" rel="noopener" href="https://raft.github.io/">Raft</a> 是一种更易于理解的分布式共识算法，核心协议本质上还是师承 Paxos 的精髓，不同的是依靠 Raft 模块化的拆分以及更加简化的设计，Raft 协议相对更容易实现。</p>
<ul>
<li><p>模块化的拆分主要体现在：Raft 把一致性协议划分为 Leader 选举、MemberShip 变更、日志复制、Snapshot 等几个几乎完全解耦的模块。</p>
</li>
<li><p>更加简化的设计则体现在：Raft 不允许类似 Paxos 中的乱序提交、简化系统中的角色状态（只有 Leader、Follower、Candidate 三种角色）、限制仅 Leader 可写入、使用随机化的超时时间来设计 Leader Election 等等。 </p>
</li>
</ul>
<h2 id="Raft节点"><a href="#Raft节点" class="headerlink" title="Raft节点"></a>Raft节点</h2><p>Raft将系统中的节点分为领导者（Leader）、跟从者（Follower）和候选人（Candidate）：</p>
<ul>
<li><strong>Leader</strong>：接受客户端请求，并向Follower同步请求日志，当日志同步到大多数节点上后告诉Follower提交日志。</li>
<li><strong>Follower</strong>：接受并持久化Leader同步的日志，在Leader告之日志可以提交之后，提交日志。</li>
<li><strong>Candidate</strong>：Leader选举过程中的临时角色。</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f06s2yimj207a07sdfu.jpg" alt="1"></p>
<h2 id="节点转换"><a href="#节点转换" class="headerlink" title="节点转换"></a>节点转换</h2><p>Raft要求系统在任意时刻最多只有一个Leader，正常工作期间只有Leader和Followers。</p>
<p>Raft算法角色状态转换如下：</p>
<p><img src="https://pic2.zhimg.com/v2-7f64a2df8f8817932ed047d35878bca9_r.jpg" alt="preview"></p>
<p>Raft算法将时间分为一个个的任期（term），每一个term的开始都是Leader选举。在成功选举Leader之后，Leader会在整个term内管理整个集群。如果Leader选举失败，该term就会因为没有Leader而结束。</p>
<h2 id="任期"><a href="#任期" class="headerlink" title="任期"></a>任期</h2><ol>
<li>时间被划分为一个个任期 (term)，term id 按时间轴单调递增；</li>
<li>每一个任期的开始都是 Leader 选举，选举成功之后，Leader 在任期内管理整个集群，也就是 <strong>“选举 + 常规操作”</strong>；</li>
<li>每个任期最多一个 Leader，可能没有 Leader (spilt-vote 导致)。</li>
</ol>
<p><img src="https://gw.alipayobjects.com/mdn/rms_da499f/afts/img/A*CTpYRa_CB_4AAAAAAAAAAABjARQnAQ" alt="本图出自《Raft: A Consensus Algorithm for Replicated Logs》"></p>
<h1 id="SOFAJRaft"><a href="#SOFAJRaft" class="headerlink" title="SOFAJRaft"></a>SOFAJRaft</h1><p><a target="_blank" rel="noopener" href="https://github.com/sofastack/sofa-jraft">SOFAJRaft</a> 是一个基于 <a target="_blank" rel="noopener" href="https://raft.github.io/">Raft</a> 一致性算法的生产级高性能 Java 实现，支持 MULTI-RAFT-GROUP，适用于高负载低延迟的场景。 使用 SOFAJRaft 你可以专注于自己的业务领域，由 SOFAJRaft 负责处理所有与 Raft 相关的技术难题，并且 SOFAJRaft 非常易于使用，你可以通过几个示例在很短的时间内掌握它。</p>
<p>SOFAJRaft 是从百度的 <a target="_blank" rel="noopener" href="https://github.com/brpc/braft">braft</a> 移植而来，做了一些优化和改进，感谢百度 braft 团队开源了如此优秀的 C++ Raft 实现。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f08ipylmj20xr0u0n03.jpg" alt="image-20220722001730696"></p>
<blockquote>
<p>整个系统围绕着Node进行。涵盖了日志管理、元数据存储、快照、状态机、日志复制等模块。Node和Node之间通过RPC进行通信。<br>系统日志模块和状态机的任务都是通过Disruptor异步去执行。</p>
</blockquote>
<ul>
<li>FSMCaller主要就是将日志同步到状态机。</li>
<li>LogManager，顾名思义，就是管理日志。</li>
<li>MetaStorage用来存储节点的元数据信息。</li>
<li>SnapshotExecutor就是快照方面的实现。</li>
</ul>
<h1 id="SOFAJRaft选举机制"><a href="#SOFAJRaft选举机制" class="headerlink" title="SOFAJRaft选举机制"></a>SOFAJRaft选举机制</h1><p>其中，SOFAJRaft 的选举中包含了对两个属性的判断：LogIndex 和 Term。</p>
<ul>
<li>Term 即任期</li>
<li>LogIndex即提交到 raft group  中的任务都将序列化为一条日志存储下来，每条日志一个编号，在整个 raft group 内单调递增并复制到每个 raft  节点。可以理解为事务id。</li>
</ul>
<p><img src="https://pic3.zhimg.com/80/v2-05b80ce9095004381b5846c6179f932e_1440w.jpg" alt="img"></p>
<p>SOFAJRaft选举机制，大致如下：</p>
<ol>
<li>Candidate 被 ET（Election Timeout） 触发</li>
<li>Candidate 开始尝试发起 pre-vote 预投票</li>
<li>Follower 判断是否认可该 pre-vote request</li>
<li>Candidate 根据 pre-vote response 来决定是否发起 RequestVoteRequest</li>
<li>Follower 判断是否认可该 RequestVoteRequest</li>
<li>Candidate 根据 response 来判断自己是否当选</li>
</ol>
<p>这个过程可用下图表示：</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0a4jpu6j20u20u076o.jpg" alt="3"></p>
<p>在代码层面，主要是由四个方法来处理这个流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">com.alipay.sofa.jraft.core.NodeImpl#preVote <span class="comment">//预投票</span></span><br><span class="line">com.alipay.sofa.jraft.core.NodeImpl#electSelf <span class="comment">//投票</span></span><br><span class="line">com.alipay.sofa.jraft.core.NodeImpl#handlePreVoteRequest <span class="comment">//处理预投票请求</span></span><br><span class="line">com.alipay.sofa.jraft.core.NodeImpl#handleRequestVoteRequest <span class="comment">//处理投票请求</span></span><br></pre></td></tr></table></figure>

<p>代码逻辑比较直观，所以我们用流程图来简述各个方法中的处理。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0cxnajtj20u00usq9a.jpg" alt="4"></p>
<p>图中可见，预投票请求 preVote 和投票请求 electSelf 的流程基本类似，只是有几个细节不太一样：</p>
<ol>
<li>preVote 是由超时触发；</li>
<li>preVote 在组装 Request 的时候将 term 赋值为 currTerm + 1，而 electSelf 是先将 term ++；</li>
<li>preVote 成功后，进入 electSelf，electSelf 成功后 become Leader。</li>
</ol>
<p>处理预投票和投票请求的逻辑也比较类似，同样用图来表示。</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0dezjqhj20u010laee.jpg" alt="5"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0e1bo7nj20u00vn782.jpg" alt="6"></p>
<p>上面提到的四个方法的源码:</p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0ecchzkj20sg11pdkr.jpg" alt="7"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0elg6wrj20sg127wk3.jpg" alt="8"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0eyzgy2j20sg15744f.jpg" alt="9"></p>
<p><img src="https://tva1.sinaimg.cn/large/e6c9d24egy1h4f0fdk2amj20sg15pjxl.jpg" alt="10"></p>
<h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a target="_blank" rel="noopener" href="https://raft.github.io/">https://raft.github.io/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/sofastack/sofa-jraft">https://github.com/sofastack/sofa-jraft</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sofastack.tech/blog/sofa-jraft-production-level-algorithm-library/">https://www.sofastack.tech/blog/sofa-jraft-production-level-algorithm-library/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.sofastack.tech/blog/sofa-jraft-election-mechanism/">https://www.sofastack.tech/blog/sofa-jraft-election-mechanism/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11743469.html">https://www.cnblogs.com/luozhiyun/p/11743469.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32052223">https://zhuanlan.zhihu.com/p/32052223</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/luozhiyun/p/11743469.html">https://www.cnblogs.com/luozhiyun/p/11743469.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yunqiinsight/article/details/117515558">https://blog.csdn.net/yunqiinsight/article/details/117515558</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1688836">https://cloud.tencent.com/developer/article/1688836</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/06/10/Spring%20Cloud%20Contract%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zhan Hao">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhan Hao's Blogs">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/10/Spring%20Cloud%20Contract%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C/" class="post-title-link" itemprop="url">Spring Cloud Contract使用经验</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2021-06-10 13:58:04 / Modified: 17:41:20" itemprop="dateCreated datePublished" datetime="2021-06-10T13:58:04+08:00">2021-06-10</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="API接口，集成测试中遇到的问题"><a href="#API接口，集成测试中遇到的问题" class="headerlink" title="API接口，集成测试中遇到的问题"></a>API接口，集成测试中遇到的问题</h1><p>目前，项目中，集成测试，遇到RPC远程调用，采取的是端对端Mock API接口的方式。具体实现，是用WireMock，在Spring Boot Test上下文启动的时候，手动启动一个WireMock Server，然后在各个测试用例里面，Stub API接口。</p>
<p>遇到的问题：</p>
<ul>
<li>站在消费者的角度，编写Mock 数据，有重复的工作量。比如A -&gt; C，B -&gt; C，A、B调用了C的某个API接口，Mock API接口的时候，在A、B项目里面，就会编写相同的Stubs。</li>
<li>无法及时感知API接口的变更。比如，目前使用WireMock，来Mock API  HTTP接口，是使用的JSON格式的文件，来Mock接口返回值，如果API接口增加了一个字段，消费者很容易忽略了这个新增的字段。</li>
</ul>
<h1 id="CDC-Consumer-Driven-Contracts"><a href="#CDC-Consumer-Driven-Contracts" class="headerlink" title="CDC(Consumer-Driven Contracts)"></a>CDC(Consumer-Driven Contracts)</h1><p> Thoughtworks 的 <a target="_blank" rel="noopener" href="http://iansrobinson.com/">Ian Robinson</a> 提出的 <a target="_blank" rel="noopener" href="https://martinfowler.com/articles/consumerDrivenContracts.html">Consumer-Driven Contracts (CDC) </a>能很好解决上述问题。</p>
<blockquote>
<p>消费者驱动的契约测试（Consumer-Driven Contracts，简称CDC），是指从消费者业务实现的角度出发，驱动出契约，再基于契约，对提供者验证的一种测试方式。</p>
</blockquote>
<h1 id="Spring-Cloud-Contract"><a href="#Spring-Cloud-Contract" class="headerlink" title="Spring Cloud Contract"></a>Spring Cloud Contract</h1><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-contract">Spring Cloud Contract</a> 是CDC的一种具体实现。具体流程，如下图：</p>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNgy1grd8bhgjvhj30re0jkmxw.jpg" alt="Getting started first application"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud-contract">https://spring.io/projects/spring-cloud-contract</a></p>
<p><a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-cloud-contract">https://www.baeldung.com/spring-cloud-contract</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/spring-cloud-samples/spring-cloud-contract-samples">https://github.com/spring-cloud-samples/spring-cloud-contract-samples</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zhan Hao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">12</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhan Hao</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
